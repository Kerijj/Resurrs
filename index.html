<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>БУНКЕР-СИГНАЛ: ВЫЖИВАНИЕ</title>
    <style>
        /* --- СТИЛИ ТЕРМИНАЛА (без изменений) --- */
        body {
            font-family: 'Consolas', 'Courier New', monospace;
            background-color: #0d0d0d;
            color: #00ff41;
            margin: 0;
            padding: 20px;
            text-shadow: 0 0 5px #00ff41;
            overflow-x: hidden;
        }
        h1, h2, h3 {
            color: #00ffcc;
            text-align: center;
            border-bottom: 2px solid #00ffcc;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-shadow: 0 0 8px #00ffcc;
        }
        #team-select, #game-container {
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid #00ff41;
            padding: 20px;
            box-shadow: 0 0 15px #00ff41;
        }
        .btn {
            background-color: transparent;
            color: #00ff41;
            border: 1px solid #00ff41;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            font-size: 1.1em;
            text-shadow: 0 0 5px #00ff41;
        }
        .btn:hover:not(.locked) {
            background-color: #00ff41;
            color: #0d0d0d;
            box-shadow: 0 0 10px #00ff41;
        }
        #round-nav {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .round-btn {
            background-color: transparent;
            color: #00ff41;
            border: 1px dashed #00ff41;
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .round-btn:hover:not(.locked), .round-btn.active:not(.locked) {
            background-color: #003311;
            border: 1px solid #00ff41;
            box-shadow: 0 0 5px #00ff41;
        }
        .round-btn.locked {
            color: #444;
            border-color: #444;
            cursor: not-allowed;
            text-shadow: none;
        }
        #round-content {
            padding: 15px;
            border-top: 2px solid #00ffcc;
            min-height: 300px;
        }
        .card-list {
            list-style: none;
            padding: 0;
        }
        .card-list li {
            background-color: #1a1a1a;
            border-left: 5px solid #00ffcc;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: 0 0 5px rgba(0, 255, 65, 0.2);
        }
        .warning {
            color: #ff004c;
            font-weight: bold;
            text-shadow: 0 0 5px #ff004c;
        }
        .success {
            color: #00ff41;
            font-weight: bold;
        }
        .round-objective {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #00ffcc;
            text-align: center;
        }
        #timer-display {
            font-size: 2.5em;
            color: #ffcc00;
            text-align: center;
            margin: 10px 0 20px;
            padding: 5px;
            border: 3px double #ffcc00;
            background-color: #331a00;
            text-shadow: 0 0 8px #ffcc00;
        }
        #timer-label {
            font-size: 0.5em;
            color: #00ffcc;
            display: block;
        }
        .input-area input {
            padding: 8px;
            margin-top: 5px;
            background-color: #0d0d0d;
            border: 1px solid #00ff41;
            color: #00ff41;
            font-family: inherit;
            text-transform: uppercase;
        }
        #challenge-section {
            border: 2px solid #ffcc00;
            padding: 15px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="team-select">
        <h1>[ СИСТЕМА ВЫЖИВАНИЯ БУНКЕРА ]</h1>
        <h2>ИНИЦИАЛИЗАЦИЯ СВЯЗИ</h2>
        <p style="text-align: center;">*Сбой протокола. Выберите свой Лагерь/Бункер, чтобы получить данные.*</p>
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="selectTeam('Group 1')">ГРУППА 1: СЕКЦИЯ АЛЬФА</button>
            <button class="btn" onclick="selectTeam('Group 2')">ГРУППА 2: СЕКЦИЯ БЕТА</button>
            <button class="btn" onclick="selectTeam('Group 3')">ГРУППА 3: СЕКЦИЯ ГАММА</button>
        </div>
    </div>

    <div id="game-container" style="display:none;">
        <h1>БУНКЕР: КРИТИЧЕСКИЙ РЕЖИМ</h1>
        <h2 id="team-display" style="color: #ffcc00;"></h2>

        <div id="timer-display">
            <span id="timer-label">ВРЕМЯ НА РАУНД</span>
            <span id="time-left">10:00</span>
        </div>
        
        <div id="round-nav">
            <button class="round-btn active" data-round="1" onclick="showRound(1)">РАУНД 1: РЕСУРСЫ 📦</button>
            <button class="round-btn locked" data-round="2">РАУНД 2: ФИЛЬТР 💧</button>
            <button class="round-btn locked" data-round="3">РАУНД 3: СВЯЗЬ 📡</button>
            <button class="round-btn locked" data-round="4">РАУНД 4: ВЫХОД 🌲</button>
            <button class="round-btn locked" data-round="5">РАУНД 5: ФИНАЛ 🤝</button>
        </div>

        <div id="round-content">
        </div>
    </div>

    <script>
        // --- ДАННЫЕ ИГРЫ ---
        const challengeQuestions = {
            "Group 1": [
                { q: "Вопрос 1: Как называется израильская лепёшка, которая часто подается с хумусом?", a: "ПИТА" },
                { q: "Вопрос 2: Назовите основной ингредиент Фалафеля.", a: "НУТ" },
                { q: "Вопрос 3: Из какого зерна традиционно готовят халу (израильский субботний хлеб)?", a: "ПШЕНИЦА" },
                { q: "Вопрос 4: Какой фрукт часто используется для приготовления восточных сладостей (например, в 'Бахлаве')?", a: "ФИНИК" },
                { q: "Вопрос 5: Какой молочный продукт часто добавляют в салат, который подается на завтрак (творог/сыр)?", a: "ТВОРОГ" }
            ],
            "Group 2": [
                { q: "Вопрос 1: Какой инструмент используется для закручивания винтов с крестообразным шлицем?", a: "ОТВЕРТКА" },
                { q: "Вопрос 2: Как называется ручной инструмент для нарезания внешней резьбы на стержнях?", a: "ПЛАШКА" },
                { q: "Вопрос 3: Какой инструмент используют для изгибания или фиксации металлических деталей?", a: "ТИСКИ" },
                { q: "Вопрос 4: Как называется устройство, которое преобразует электрический ток в механическое движение (например, в дрели)?", a: "МОТОР" },
                { q: "Вопрос 5: Что используется для точного измерения углов и линий на материалах?", a: "РУЛЕТКА" }
            ],
            "Group 3": [
                { q: "Вопрос 1: Как называется неглубокий разрез, сделанный для остановки кровотечения?", a: "ЖГУТ" },
                { q: "Вопрос 2: Назовите самое распространенное дезинфицирующее средство, используемое для обработки ран.", a: "АНТИСЕПТИК" },
                { q: "Вопрос 3: Что нужно сделать в первую очередь при подозрении на перелом конечности?", a: "ОБЕЗДВИЖИТЬ" },
                { q: "Вопрос 4: Какое лекарство используется для понижения высокой температуры?", a: "ПАРАЦЕТАМОЛ" },
                { q: "Вопрос 5: Как называется специальная повязка, которая накладывается на рану для защиты от инфекции?", a: "БАНДАЖ" }
            ]
        };

        const gameData = {
            "Group 1": {
                "name": "ГРУППА 1: СЕКЦИЯ АЛЬФА (Кухня)",
                "Round 1": {
                    objective: "🔹 Сбор ресурсов. Локация: Кухня. Цель: Получить Еду. (5 мин на решение)",
                    challenge_resource: "Еда 🍞",
                    challenge_text: "Ответьте на 5 вопросов о культуре еды Израиля, чтобы получить дополнительный запас.",
                    trade_need: "<span class='warning'>⚠️ Дефицит: Инструменты. Штраф: Если не обменялись, Раунд 3 займет +3 минуты.</span>",
                    cards: ["💧 Вода", "💊 Медикаменты", "🪵 Материалы", "💡 Бонус: Острый нож (доп. ресурс)"]
                },
                "Round 2": {
                    objective: "🔹 Ремонт Фильтра. Цель: Разгадать код и получить ВЕРХНЮЮ часть схемы 🔺. (7 мин)",
                    challenge_resource: "Верхняя часть схемы",
                    challenge_text: "Решите ребус 💧 + А. Ответ: ВОДА",
                    trade_need: "Обмен: Нужны **Средняя (Гр. 2)** и **Нижняя (Гр. 3)** части схемы.",
                    cards: ["🟦 Ребус", "🔹 Схема Фильтра (ВЕРХНЯЯ ЧАСТЬ) 🔺", "📝 Секретное слово: ВОДА"]
                },
                "Round 3": {
                    objective: "🔹 Сбор Связи. Цель: Собрать Антенну. Ускорение: Инструменты. (7 мин)",
                    challenge_resource: "Антенна",
                    challenge_text: "Ответьте на 5 вопросов по географии Израиля.",
                    trade_need: "Обмен: Нужны **Кабель питания (Гр. 2)** и **Резервное Питание (Гр. 3)**.",
                    cards: ["📡 Антенна", "🛠️ Инструменты (+1 к скорости, если есть)", "🟢 Бонус: Инструменты Гр. 2."]
                },
                "Round 4": {
                    objective: "🔹 Выход на Поверхность. Цель: Выбрать маршрут с наименьшими потерями. (5 мин)",
                    challenge_resource: "Маршрут",
                    challenge_text: "Анализ состояния передатчика (Раунд 3) для выбора пути.",
                    trade_need: "Маршрут А: Короткий, Опасный (Потеря 1 ресурса). Маршрут Б: Длинный, Безопасный.",
                    cards: ["🌲 Маршрут А", "🛤️ Маршрут Б", "🟢 Подсказка: Стабильный сигнал = Безопасность."]
                },
                "Round 5": {
                    objective: "🔹 Финал. Выберите стратегию спасения. (5 мин)",
                    challenge_resource: "Решение",
                    challenge_text: "Голосование за Объединение (🤝) или Отдельный Выход (🏃‍♂️).",
                    trade_need: "Итог зависит от собранных ресурсов и успешного обмена.",
                    cards: ["🤝 Объединиться", "🏃‍♂️ Идти отдельно"]
                }
            },
            "Group 2": {
                "name": "ГРУППА 2: СЕКЦИЯ БЕТА (Мастерская)",
                "Round 1": {
                    objective: "🔹 Сбор ресурсов. Локация: Мастерская. Цель: Получить Инструменты. (5 мин на решение)",
                    challenge_resource: "Инструменты 🛠️",
                    challenge_text: "Ответьте на 5 вопросов о федеральных округах РФ, чтобы получить нужные инструменты.",
                    trade_need: "<span class='warning'>⚠️ Дефицит: Еда. Штраф: Если нет Еды, Раунд 4 начнется с -2 ресурсами.</span>",
                    cards: ["💧 Вода", "🔌 Провода", "🔹 Фильтр для воды", "💡 Бонус: Набор проводов (доп. ресурс)"]
                },
                "Round 2": {
                    objective: "🔹 Ремонт Фильтра. Цель: Разгадать код и получить СРЕДНЮЮ часть схемы 🟦. (7 мин)",
                    challenge_resource: "Средняя часть схемы",
                    challenge_text: "Разгадайте кроссворд (4 слова: очистка, мембрана...). Ответ: ЧИСТЫЙ",
                    trade_need: "Обмен: Нужны **Верхняя (Гр. 1)** и **Нижняя (Гр. 3)** части схемы.",
                    cards: ["📝 Кроссворд (часть 1)", "🔹 Схема Фильтра (СРЕДНЯЯ ЧАСТЬ) 🟦", "📝 Секретное слово: ЧИСТЫЙ"]
                },
                "Round 3": {
                    objective: "🔹 Сбор Связи. Цель: Собрать Кабель Питания. Ускорение: Ресурсы Гр. 1. (7 мин)",
                    challenge_resource: "Кабель Питания",
                    challenge_text: "Ответьте на 5 вопросов по физике и электронике.",
                    trade_need: "Обмен: Нужны **Антенна (Гр. 1)** и **Резервное Питание (Гр. 3)**.",
                    cards: ["🔌 Кабель питания", "🎛️ Панель управления", "🟢 Бонус: Еда Гр. 1."]
                },
                "Round 4": {
                    objective: "🔹 Выход на Поверхность. Цель: Выбрать маршрут с наименьшими потерями. (5 мин)",
                    challenge_resource: "Маршрут",
                    challenge_text: "Анализ состояния передатчика (Раунд 3) для выбора пути.",
                    trade_need: "Маршрут А: Короткий, Опасный (Потеря 1 ресурса). Маршрут Б: Длинный, Безопасный.",
                    cards: ["🛤️ Маршрут Б", "🕳️ Маршрут В", "🟡 Подсказка: Инструменты ускоряют прохождение."]
                },
                "Round 5": {
                    objective: "🔹 Финал. Выберите стратегию спасения. (5 мин)",
                    challenge_resource: "Решение",
                    challenge_text: "Голосование за Объединение (🤝) или Отдельный Выход (🏃‍♂️).",
                    trade_need: "Итог зависит от собранных ресурсов и успешного обмена.",
                    cards: ["🤝 Объединиться", "🏃‍♀️ Идти отдельно"]
                }
            },
            "Group 3": {
                "name": "ГРУППА 3: СЕКЦИЯ ГАММА (Склад)",
                "Round 1": {
                    objective: "🔹 Сбор ресурсов. Локация: Склад. Цель: Получить Медикаменты. (5 мин на решение)",
                    challenge_resource: "Медикаменты 💊",
                    challenge_text: "Ответьте на 5 вопросов о первой помощи и медицине, чтобы получить медикаменты.",
                    trade_need: "<span class='warning'>⚠️ Дефицит: Еда. Штраф: Если не обменялись, Раунд 4 имеет утроенный риск! (Потеря 3 ресурсов)</span>", // Исправлено на Еда
                    cards: ["🥫 Еда (Сухпай)", "⛽ Топливо", "🪶 Материалы", "💾 Микросхема"]
                },
                "Round 2": {
                    objective: "🔹 Ремонт Фильтра. Цель: Разгадать код и получить НИЖНЮЮ часть схемы 🔻. (7 мин)",
                    challenge_resource: "Нижняя часть схемы",
                    challenge_text: "Загадка 'Небо без звезд, дыхание без легких'. Ответ: ВОЗДУХ",
                    trade_need: "Обмен: Нужны **Верхняя (Гр. 1)** и **Средняя (Гр. 2)** части схемы.",
                    cards: ["📝 Загадка", "🔹 Схема Фильтра (НИЖНЯЯ ЧАСТЬ) 🔻", "📝 Секретное слово: ВОЗДУХ"]
                },
                "Round 3": {
                    objective: "🔹 Сбор Связи. Цель: Собрать Резервное Питание. Ускорение: Микросхема. (7 мин)",
                    challenge_resource: "Резервное Питание",
                    challenge_text: "Ответьте на 5 вопросов по энергетике и топливу.",
                    trade_need: "Обмен: Нужны **Антенна (Гр. 1)** и **Кабель питания (Гр. 2)**.",
                    cards: ["🔋 Резервное питание", "💾 Микросхема (+1 к скорости, если есть)", "🟢 Бонус: Топливо (если есть)"]
                },
                "Round 4": {
                    objective: "🔹 Выход на Поверхность. Цель: Выбрать маршрут с наименьшими потерями. (5 мин)",
                    challenge_resource: "Маршрут",
                    challenge_text: "Анализ состояния передатчика (Раунд 3) для выбора пути.",
                    trade_need: "Маршрут А: Короткий, Опасный (Потеря 1 ресурса). Маршрут Б: Длинный, Безопасный.",
                    cards: ["🌲 Маршрут А", "🕳️ Маршрут В", "🟢 Подсказка: Резервное питание позволяет выбрать более длинный маршрут."]
                },
                "Round 5": {
                    objective: "🔹 Финал. Выберите стратегию спасения. (5 мин)",
                    challenge_resource: "Решение",
                    challenge_text: "Голосование за Объединение (🤝) или Отдельный Выход (🏃‍♂️).",
                    trade_need: "Итог зависит от собранных ресурсов и успешного обмена.",
                    cards: ["🤝 Объединиться", "🏃‍♂️ Идти отдельно"]
                }
            }
        };

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ИГРЫ ---
        const ROUND_DURATION_SEC = 600; // 10 минут
        const ROUND_1_DURATION_SEC = 300; // 5 минут для 1 раунда
        let currentTeam = null;
        let timerInterval = null;
        let currentQuestionIndex = 0;
        let correctAnswers = 0;
        
        // Хранение прогресса команды
        let teamProgress = {
            "Group 1": { completed: false, hasBonusResource: false, round2Completed: false, round3Completed: false },
            "Group 2": { completed: false, hasBonusResource: false, round2Completed: false, round3Completed: false },
            "Group 3": { completed: false, hasBonusResource: false, round2Completed: false, round3Completed: false }
        };

        // --- ФУНКЦИИ ИГРЫ ---

        function startTimer(durationInSeconds) {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            let timer = durationInSeconds;
            const display = document.getElementById('time-left');
            const timerDiv = document.getElementById('timer-display');
            
            timerDiv.style.color = '#00ff41'; 
            timerDiv.style.textShadow = '0 0 5px #00ff41';

            timerInterval = setInterval(function () {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(timerInterval);
                    display.textContent = "ВРЕМЯ ИСТЕКЛО! 💀";
                    timerDiv.style.color = '#ff004c'; 
                    timerDiv.style.textShadow = '0 0 8px #ff004c'; 
                } else if (timer <= 60 && timer > 0) {
                     timerDiv.style.color = '#ffcc00'; 
                     timerDiv.style.textShadow = '0 0 8px #ffcc00'; 
                } else {
                     timerDiv.style.color = '#00ffcc'; 
                     timerDiv.style.textShadow = '0 0 8px #00ffcc';
                }
            }, 1000);
        }

        // КРИТИЧЕСКАЯ ФУНКЦИЯ: ЗАПУСК ИГРЫ И ПЕРЕХОД К РАУНДУ 1
        function selectTeam(teamId) {
            // 1. Устанавливаем текущую команду
            currentTeam = teamId;
            document.getElementById('team-select').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            
            document.getElementById('team-display').textContent = `[ СВЯЗЬ УСТАНОВЛЕНА: ${gameData[teamId].name} ]`;

            // 2. Устанавливаем навигацию
            updateRoundNavigation(1);
            // 3. Отображаем контент Раунда 1
            showRound(1); 
        }
        
        // ОБНОВЛЕНИЕ КНОПОК НАВИГАЦИИ
        function updateRoundNavigation(activeRound = 1) {
            if (!currentTeam) return;

            const navButtons = document.querySelectorAll('.round-btn');
            const progress = teamProgress[currentTeam];

            navButtons.forEach(btn => {
                const roundNum = parseInt(btn.getAttribute('data-round'));
                
                let isUnlocked = false;

                if (roundNum === 1) isUnlocked = true;
                else if (roundNum === 2 && progress.completed) isUnlocked = true;
                else if (roundNum === 3 && progress.round2Completed) isUnlocked = true;
                else if (roundNum === 4 && progress.round3Completed) isUnlocked = true;
                else if (roundNum === 5 && progress.round3Completed) isUnlocked = true; // Раунд 4 и 5 доступны после Раунда 3

                if (isUnlocked) {
                    btn.classList.remove('locked');
                    btn.onclick = function() { showRound(roundNum); };
                } else {
                    btn.classList.add('locked');
                    btn.onclick = null; 
                }

                // Сброс активного класса и установка нового
                btn.classList.remove('active');
                if (roundNum === activeRound) {
                    btn.classList.add('active');
                }
            });
        }

        // ОТОБРАЖЕНИЕ КОНТЕНТА РАУНДА
        function showRound(roundNum) {
            if (!currentTeam || !gameData[currentTeam]) return; 

            // Находим кнопку для стилизации
            const btn = document.querySelector(`.round-btn[data-round="${roundNum}"]`);
            if (btn && btn.classList.contains('locked')) return; 

            // Стилизация активной кнопки
            document.querySelectorAll('.round-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // Запуск таймера (5 минут для Раунда 1, 10 для остальных)
            const duration = roundNum === 1 ? ROUND_1_DURATION_SEC : ROUND_DURATION_SEC;
            startTimer(duration);

            const roundKey = `Round ${roundNum}`;
            const data = gameData[currentTeam][roundKey];
            const progress = teamProgress[currentTeam];
            const contentDiv = document.getElementById('round-content');
            
            let html = `
                <h3>[ ${data.objective.toUpperCase()} ]</h3>
                
                <h4 style="color:#ffcc00;">🔑 ИСПЫТАНИЕ:</h4>
                <div class="round-objective" style="border-color: #ffcc00;">
                    ${data.challenge_text}
                </div>
            `;

            // Логика для Раунда 1 (Сбор ресурсов)
            if (roundNum === 1) {
                let challengeContent = '';
                if (progress.hasBonusResource) {
                    challengeContent = `<p class='success'>✅ КРИТИЧЕСКИЙ РЕСУРС **${data.challenge_resource}** ПОЛУЧЕН.</p>`;
                } else if (progress.completed) {
                    challengeContent = `<p class='warning'>❌ ИСПЫТАНИЕ ПРОВАЛЕНО ИЛИ ПРОПУЩЕНО.</p>`;
                }
                else {
                    challengeContent = `
                        <h4 style="color:#ffcc00;">🚨 ШАНС НА КРИТИЧЕСКИЙ РЕСУРС: ${data.challenge_resource}</h4>
                        <p>Нажмите, чтобы начать испытание из 5 вопросов (3 верных для успеха).</p>
                        <button class="btn" id="start-challenge-btn" onclick="startResourceChallenge()">НАЧАТЬ ИСПЫТАНИЕ</button>
                    `;
                }

                html += `<div id="challenge-section">${challengeContent}</div>`;
                
                // Кнопка перехода к Раунду 2
                if (progress.completed) {
                     html += `
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="updateRoundNavigation(2); showRound(2);">ПЕРЕЙТИ К РАУНДУ 2</button>
                        </div>
                    `;
                } else {
                     html += `
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="completeRound1SkipChallenge()">ПРОДОЛЖИТЬ (ПРОПУСТИТЬ ИСПЫТАНИЕ)</button>
                        </div>
                    `;
                }
            } 
            
            // Логика для Раунда 2 (Секретное слово)
            else if (roundNum === 2) {
                if (progress.round2Completed) {
                    html += `<p class='success' style="text-align: center;">✅ ФИЛЬТР ВОССТАНОВЛЕН. Переходите к следующему этапу.</p>`;
                } else {
                    html += `
                        <div class="input-area" style="text-align: center; margin-top: 15px;">
                            <strong>ВВЕДИТЕ СЕКРЕТНОЕ СЛОВО:</strong>
                            <input type="text" id="secret-word-input" placeholder="Введите ответ">
                            <button class="btn" onclick="checkSecretWord(2)">ПРОВЕРИТЬ</button>
                            <p id="secret-word-feedback" style="margin-top: 10px;"></p>
                        </div>
                    `;
                }
                if (progress.round2Completed) {
                     html += `
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="updateRoundNavigation(3); showRound(3);">ПЕРЕЙТИ К РАУНДУ 3</button>
                        </div>
                    `;
                }
            }
            // Логика для Раунда 3 (Сбор Связи)
            else if (roundNum === 3) {
                if (progress.round3Completed) {
                    html += `<p class='success' style="text-align: center;">✅ СВЯЗЬ УСТАНОВЛЕНА. Вы готовы к выходу.</p>`;
                } else {
                    html += `<p style="text-align: center;">Выполните задание и нажмите кнопку ниже, чтобы перейти дальше.</p>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="completeRound3()">ЗАВЕРШИТЬ РАУНД 3</button>
                    </div>`;
                }
            }
            // Логика для Раунда 4 и 5 (Маршрут/Финал)
            else if (roundNum === 4 || roundNum === 5) {
                html += `<p style="text-align: center;">*** ${roundNum === 4 ? 'Примите решение по маршруту!' : 'Примите ФИНАЛЬНОЕ решение!'} ***</p>`;
                html += `<div style="text-align: center; margin-top: 20px;">`;
                data.cards.forEach((card, index) => {
                    html += `<button class="btn" onclick="alert('Вы выбрали: ${card}. Это ваше финальное решение.')">${card}</button>`;
                });
                html += `</div>`;
            }


            // Карточки ресурсов
            html += `
                <h4 style="color:#00ffcc;">📦 ВАШИ КАРТОЧКИ:</h4>
                <ul class="card-list">
            `;

            data.cards.forEach((card) => {
                // Дополнительная проверка на наличие бонусного ресурса в Раунде 1
                if (roundNum === 1 && card.includes("Бонус:") && !progress.hasBonusResource) {
                    return; // Не показываем бонус, если он не получен
                }
                html += `<li>${card}</li>`;
            });

            html += `</ul>`;
            
            // Информация о дефиците и обмене
            html += `
                <h4 style="color:#ff004c;">🚨 КРИТИЧЕСКИЙ ДЕФИЦИТ:</h4>
                <div class="round-objective" style="border-color: #ff004c;">
                    ${data.trade_need}
                </div>
            `;
            
            contentDiv.innerHTML = html;
        }

        // ФУНКЦИЯ ДЛЯ ЗАВЕРШЕНИЯ РАУНДА 1 (Пропуск/завершение испытания)
        function completeRound1SkipChallenge() {
            if (!currentTeam || teamProgress[currentTeam].completed) return;

            teamProgress[currentTeam].completed = true;
            clearInterval(timerInterval);
            alert('Раунд 1 завершен. Вам доступен Раунд 2.');
            
            // Обновляем навигацию и отображаем Раунд 1, чтобы показать кнопку "Перейти к Раунду 2"
            updateRoundNavigation(1);
            showRound(1);
        }
        
        // ФУНКЦИЯ ДЛЯ ЗАВЕРШЕНИЯ РАУНДА 3
        function completeRound3() {
            if (!currentTeam) return;
            
            teamProgress[currentTeam].round3Completed = true;
            clearInterval(timerInterval);
            alert('Связь установлена. Вам доступны Раунды 4 и 5.');
            updateRoundNavigation(3);
            showRound(3);
        }

        // ФУНКЦИЯ ПРОВЕРКИ СЕКРЕТНОГО СЛОВА (Раунд 2)
        function checkSecretWord(roundNum) {
            const input = document.getElementById('secret-word-input');
            const feedback = document.getElementById('secret-word-feedback');
            const userInput = (input.value || '').trim().toUpperCase();
            
            // Извлекаем правильное слово из данных
            const correctWordCard = gameData[currentTeam][`Round ${roundNum}`].cards.find(c => c.includes('Секретное слово:'));
            if (!correctWordCard) return;

            const correctWord = correctWordCard.split(': ')[1].trim().toUpperCase();

            if (userInput === correctWord) {
                teamProgress[currentTeam].round2Completed = true;
                clearInterval(timerInterval);
                feedback.innerHTML = '<span class="success">✅ КОД ПРИНЯТ. ФИЛЬТР АКТИВИРОВАН.</span>';
                updateRoundNavigation(2);
                showRound(2);
            } else {
                feedback.innerHTML = '<span class="warning">❌ ОШИБКА АВТОРИЗАЦИИ. Повторите ввод.</span>';
            }
        }


        // ФУНКЦИИ ИСПЫТАНИЯ (Раунд 1)
        function startResourceChallenge() {
            if (teamProgress[currentTeam].hasBonusResource || teamProgress[currentTeam].completed) return; 

            currentQuestionIndex = 0;
            correctAnswers = 0;
            
            const challengeSection = document.getElementById('challenge-section');
            challengeSection.innerHTML = `
                <h4 style="color:#ffcc00;">🔑 ИСПЫТАНИЕ ЗА РЕСУРС: <span id="challenge-resource-name">${gameData[currentTeam].Round 1.challenge_resource}</span></h4>
                <p id="challenge-question">Нажмите 'Начать', чтобы увидеть первый вопрос.</p>
                <div id="challenge-buttons" class="input-area" style="text-align: center;">
                    <button class="btn" onclick="nextQuestion('start')">НАЧАТЬ</button>
                </div>
                <p style="margin-top: 10px;">Счет: Верно <span id="correct-count">0</span> / Ошибки <span id="incorrect-count">0</span></p>
            `;
        }
        
        function nextQuestion(action) {
            if (!currentTeam) return;

            const questions = challengeQuestions[currentTeam];
            const challengeSection = document.getElementById('challenge-section');
            const questionDisplay = document.getElementById('challenge-question');
            const buttonsDisplay = document.getElementById('challenge-buttons');
            const correctCountEl = document.getElementById('correct-count');
            const incorrectCountEl = document.getElementById('incorrect-count');
            const answeredQuestions = currentQuestionIndex;

            if (action !== 'start' && answeredQuestions > 0) {
                const lastQuestion = questions[answeredQuestions - 1];
                const userAnswer = (document.getElementById('user-answer-input')?.value || '').trim().toUpperCase();
                
                const isCorrect = (action === 'answer') && (userAnswer === lastQuestion.a.toUpperCase());

                if (isCorrect) {
                    correctAnswers++;
                }
            }

            // Обновление счетчика
            const questionsAnswered = (action === 'start') ? 0 : answeredQuestions;
            const finalIncorrect = questionsAnswered - correctAnswers;
            
            correctCountEl.textContent = correctAnswers;
            if (incorrectCountEl) {
                incorrectCountEl.textContent = finalIncorrect;
            }

            if (answeredQuestions < questions.length) {
                // Показать следующий вопрос
                const currentQ = questions[answeredQuestions];
                
                questionDisplay.innerHTML = `
                    **ВОПРОС ${answeredQuestions + 1} из 5:** ${currentQ.q}
                    <br><br>
                    <input type="text" id="user-answer-input" placeholder="Введите ответ">
                `;
                buttonsDisplay.innerHTML = `
                    <button class="btn" onclick="nextQuestion('answer')">ОТВЕТИТЬ</button>
                    <button class="btn" style="background-color: #331a00;" onclick="nextQuestion('skip')">ПРОДОЛЖИТЬ</button>
                `;
                currentQuestionIndex++;
            } else {
                // Испытание завершено
                let resultMessage = '';
                
                if (correctAnswers >= 3) {
                    const resourceName = gameData[currentTeam].Round 1.challenge_resource;
                    const bonusCard = `<span class='success'>✅ Бонус: ${resourceName} (получен в Испытании)</span>`;
                    
                    if (!teamProgress[currentTeam].hasBonusResource) {
                        // Удаляем старый (пустой) бонусный ресурс и добавляем полученный
                        gameData[currentTeam].Round 1.cards = gameData[currentTeam].Round 1.cards.filter(card => !card.includes('💡 Бонус:'));
                        gameData[currentTeam].Round 1.cards.push(bonusCard); 
                        teamProgress[currentTeam].hasBonusResource = true;
                    }

                    resultMessage = `<span class='success'>✅ УСПЕХ! ${correctAnswers} из 5. Вы получаете **Критический Ресурс**.</span>`;
                } else {
                    resultMessage = `<span class='warning'>❌ ПРОВАЛ! ${correctAnswers} из 5. Вы не получаете Критический Ресурс.</span>`;
                }
                
                // АКТИВАЦИЯ ДОСТУПА К РАУНДУ 2
                teamProgress[currentTeam].completed = true; 
                clearInterval(timerInterval);

                // Финальный экран
                challengeSection.innerHTML = `
                    <h4>🔥 ИСПЫТАНИЕ ЗАВЕРШЕНО 🔥</h4>
                    <p style="font-size: 1.5em; margin: 20px 0;">
                        Верных ответов: **${correctAnswers}** / Ошибок: **${finalIncorrect}**
                    </p>
                    <p style="font-size: 1.5em; margin-bottom: 20px;">
                        ${resultMessage}
                    </p>
                    <button class="btn" onclick="updateRoundNavigation(1); showRound(1)">ОБНОВИТЬ КАРТОЧКИ И ПРОДОЛЖИТЬ</button>
                `;
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('time-left').textContent = "10:00";
             document.getElementById('game-container').style.display = 'none';
        });
    </script>
</body>
</html>
