<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ä—Å–∏–∞–Ω—Å–∫–∏–π –¢–µ—Ä–º–∏–Ω–∞–ª: –ú–∏—Å—Å–∏—è –≠–≤–∞–∫—É–∞—Ü–∏–∏</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        #game-container {
            display: flex;
            width: 1200px;
            max-width: 90%;
            background-color: #1e1e1e;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        /* --- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–°–¢–ê–¢–£–° –ò –†–ï–°–£–†–°–´) --- */
        #status-panel {
            width: 300px;
            padding: 15px;
            background-color: #252525;
            border-right: 1px solid #00ffff;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .status-block {
            border: 1px solid #3a3a3a;
            padding: 10px;
            border-radius: 4px;
        }
        
        .status-block h3 {
            color: #00ffff;
            margin-top: 0;
            margin-bottom: 5px;
            border-bottom: 1px dashed #3a3a3a;
            padding-bottom: 5px;
            font-size: 1.1em;
        }

        .resource-list li {
            list-style: none;
            padding: 3px 0;
            display: flex;
            justify-content: space-between;
        }

        .resource-list strong {
            color: #e0e0e0;
        }

        .value {
            font-weight: bold;
            font-size: 1.1em;
        }

        /* –¶–≤–µ—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ */
        #resource-power { color: #ffcc00; } /* –≠–Ω–µ—Ä–≥–∏—è: –ñ–µ–ª—Ç—ã–π */
        #resource-water { color: #3498db; } /* –í–æ–¥–∞: –°–∏–Ω–∏–π */
        #resource-air { color: #2ecc71; } /* –í–æ–∑–¥—É—Ö: –ó–µ–ª–µ–Ω—ã–π */
        #resource-health { color: #e74c3c; } /* –ó–¥–æ—Ä–æ–≤—å–µ: –ö—Ä–∞—Å–Ω—ã–π */
        #resource-points { color: #f1c40f; } /* –ë–∞–ª–ª—ã: –ó–æ–ª–æ—Ç–æ–π */

        #inventory-list {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .inventory-item {
            margin-bottom: 5px;
            border-bottom: 1px dotted #3a3a3a;
            padding-bottom: 3px;
        }
        
        /* --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –ü–ê–ù–ï–õ–¨ (–î–ï–ô–°–¢–í–ò–Ø) --- */
        #main-panel {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        #round-header {
            background-color: #00ffff1a;
            color: #00ffff;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            text-align: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        #round-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .round-info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #round-number {
            font-size: 2em;
            font-weight: bold;
        }

        #next-round-indicator {
            font-size: 0.8em;
            color: #999;
        }

        /* --- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô --- */
        #action-section {
            background-color: #2e2e2e;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #444;
        }

        #action-header-text {
            color: #00ffff;
            margin-top: 0;
        }

        #action-prompt {
            margin-bottom: 15px;
            font-style: italic;
            color: #aaa;
        }
        
        #action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-item-container, .crafting-item {
            background-color: #3a3a3a;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        input[type="number"] {
            background-color: #1e1e1e;
            border: 1px solid #00ffff;
            color: #fff;
            padding: 5px;
            border-radius: 3px;
        }

        button {
            background-color: #555;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
        }

        button:hover:not(:disabled) {
            background-color: #777;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .buy-button-R1 {
            background-color: #2ecc71 !important;
            color: #121212 !important;
            font-weight: bold;
        }
        .buy-button-R1:hover:not(:disabled) {
            background-color: #27ae60 !important;
        }

        .round-action-button-main {
            padding: 8px 15px;
            font-weight: bold;
        }

        .crafting-info.missing {
            color: #e74c3c;
            font-weight: bold;
        }
        .crafting-info {
            color: #2ecc71;
            font-weight: bold;
            margin-right: 10px;
        }
        
        /* --- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–õ–û–ì –ò –ö–ù–û–ü–ö–ê –ü–ï–†–ï–•–û–î–ê) --- */
        #log-panel {
            width: 350px;
            padding: 15px;
            background-color: #252525;
            border-left: 1px solid #00ffff;
            display: flex;
            flex-direction: column;
        }

        #log-box {
            flex-grow: 1;
            background-color: #121212;
            padding: 10px;
            border-radius: 4px;
            overflow-y: auto;
            max-height: 500px;
            font-size: 0.85em;
        }

        #log-box p {
            margin: 2px 0;
            color: #b0b0b0;
        }

        #log-box p.error {
            color: #ff4444;
            font-weight: bold;
        }

        #end-round-section {
            margin-top: 15px;
            text-align: center;
        }

        #end-round-button {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            background-color: #f39c12;
            color: #121212;
            font-weight: bold;
            border-radius: 5px;
        }
        #end-round-button:hover:not(:disabled) {
            background-color: #e67e22;
        }

        #game-over-message {
            text-align: center;
            padding: 20px;
            background-color: #c0392b;
            color: #fff;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 15px;
            border-radius: 5px;
            display: none;
        }
        
        /* --- –ü–†–ï–î–ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù --- */
        #pre-game-selector {
            width: 800px;
            max-width: 90%;
            padding: 30px;
            background-color: #2c3e50;
            border-radius: 8px;
            text-align: center;
            margin: 50px auto;
        }
        #pre-game-selector h1 {
            color: #ecf0f1;
        }
        .group-select-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .group-select-buttons button {
            padding: 15px 25px;
            font-size: 1.2em;
            font-weight: bold;
            background-color: #34495e;
            color: #fff;
        }
        .group-select-buttons button:hover:not(:disabled) {
            background-color: #3498db;
        }
        .group-select-buttons button.active-group {
            background-color: #27ae60;
        }
    </style>
</head>
<body>

<div id="game-container">

    <div id="status-panel">
        <div class="status-block">
            <h3>üåê –°–¢–ê–¢–£–° –ú–ò–°–°–ò–ò</h3>
            <p>–î–∞—Ç–∞: <span id="current-date"></span></p>
            <p>–í—Ä–µ–º—è: <span id="current-time"></span></p>
            <p>–û—Å–Ω–æ–≤–Ω–∞—è –ì—Ä—É–ø–ø–∞: <span id="active-group-display" style="font-weight: bold;">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</span></p>
        </div>

        <div class="status-block">
            <h3>üí∞ –ë–ê–õ–õ–´ –ò –†–ï–°–£–†–°–´</h3>
            <ul class="resource-list">
                <li><span style="color: #f1c40f;">–ë–ê–õ–õ–´ (–ë)</span>: <span id="resource-points" class="value">100</span></li>
                <li><strong>–≠–Ω–µ—Ä–≥–∏—è (–≠)</strong>: <span id="resource-power" class="value">50</span></li>
                <li><strong>–í–æ–¥–∞ (–í)</strong>: <span id="resource-water" class="value">50</span></li>
                <li><strong>–í–æ–∑–¥—É—Ö (–í–ó)</strong>: <span id="resource-air" class="value">50</span></li>
                <li><strong>–ó–¥–æ—Ä–æ–≤—å–µ –≠–∫–∏–ø–∞–∂–∞ (–ó–≠)</strong>: <span id="resource-health" class="value">100</span></li>
            </ul>
        </div>

        <div class="status-block" style="flex-grow: 1;">
            <h3>üì¶ –ò–ù–í–ï–ù–¢–ê–†–¨ (–ö–†–ê–§–¢–ò–ù–ì)</h3>
            <ul id="inventory-list">
                <li class="inventory-item">–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤</li>
            </ul>
        </div>
    </div>

    <div id="main-panel">
        
        <div id="pre-game-selector">
            <h1>–ú–ê–†–°–ò–ê–ù–°–ö–ò–ô –¢–ï–†–ú–ò–ù–ê–õ: –í–´–ë–û–† –ì–†–£–ü–ü–´</h1>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –≥—Ä—É–ø–ø—É. –≠—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤–∞—à–∏ **—Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã –£1** –∏ **—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é** (–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫—Ä–∞—Ñ—Ç–∏–Ω–≥–æ–≤—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –£2/–£3).</p>
            <div class="group-select-buttons">
                <button id="pre-select-group-a" onclick="setPrimaryGroup('A')">–ì–†–£–ü–ü–ê –ê (–¢–ï–•–ù–û–õ–û–ì–ò–Ø/–≠–ù–ï–†–ì–ò–Ø)</button>
                <button id="pre-select-group-b" onclick="setPrimaryGroup('B')">–ì–†–£–ü–ü–ê –ë (–ë–ò–û–õ–û–ì–ò–Ø/–ñ–ò–ó–ù–¨)</button>
                <button id="pre-select-group-c" onclick="setPrimaryGroup('C')">–ì–†–£–ü–ü–ê –í (–ö–û–ù–°–¢–†–£–ö–¶–ò–Ø/–†–ï–ú–û–ù–¢)</button>
            </div>
            <p id="group-selection-status" style="margin-top: 20px; color: #f1c40f; font-weight: bold;">–°–¥–µ–ª–∞–π—Ç–µ –≤—ã–±–æ—Ä, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –†–∞—É–Ω–¥ 1.</p>
        </div>

        <div id="main-game-interface" style="display: none;">
            <div id="round-header">
                <div class="round-info-item">
                    <span>–¢–ï–ö–£–©–ò–ô –†–ê–£–ù–î</span>
                    <span id="round-number">0</span>
                </div>
                <h2>–ü–†–û–¢–û–ö–û–õ –ú–ò–°–°–ò–ò</h2>
                <div class="round-info-item">
                    <span>–°–õ–ï–î–£–Æ–©–ò–ô –†–ê–£–ù–î</span>
                    <span id="next-round-indicator">(1)</span>
                </div>
            </div>

            <div id="action-section">
                <h3 id="action-header-text">1. –û–ñ–ò–î–ê–ù–ò–ï –î–ï–ô–°–¢–í–ò–Ø</h3>
                <p id="action-prompt">–ù–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É, –≤—ã–±—Ä–∞–≤ –≥—Ä—É–ø–ø—É.</p>
                
                <div id="action-buttons">
                    
                </div>
            </div>
        </div>

        <div id="game-over-message"></div>
    </div>

    <div id="log-panel">
        <h3>üì¢ –õ–û–ì –°–û–ë–´–¢–ò–ô</h3>
        <div id="log-box">
            </div>

        <div id="end-round-section">
            <button id="end-round-button" onclick="nextRound()" disabled>
                –ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î 0 (–ü–ï–†–ï–ô–¢–ò –ö 1)
            </button>
        </div>
    </div>
</div>

<script>
// ====================================================================
// === –í–ï–°–¨ –ö–û–î JAVASCRIPT –î–õ–Ø –ò–ì–†–´ "–ú–ê–†–°–ò–ê–ù–°–ö–ò–ô –¢–ï–†–ú–ò–ù–ê–õ" ===
// ====================================================================

// --- 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–û–í–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–• ---

    const INITIAL_RESOURCES = {
        POWER: 50,      // –≠–Ω–µ—Ä–≥–∏—è
        WATER: 50,      // –í–æ–¥–∞
        AIR: 50,        // –í–æ–∑–¥—É—Ö
        HEALTH: 100,    // –ó–¥–æ—Ä–æ–≤—å–µ –≠–∫–∏–ø–∞–∂–∞
    };
    
    let gameData = {
        round: 0, 
        points: 100, 
        resources: { ...INITIAL_RESOURCES },
        inventory: {}, 
        primaryGroup: null, // –û—Å–Ω–æ–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞ –∏–≥—Ä–æ–∫–∞ (A, B, –∏–ª–∏ C)
        taskCompleted: false, // –§–ª–∞–≥ –¥–ª—è –†1/–†2/–†5/–†6
        r6Resolved: false, 
    };
    
    // --- 2. –°–ò–°–¢–ï–ú–ê –ö–†–ê–§–¢–ò–ù–ì–ê/–†–ï–°–£–†–°–û–í –ò –¶–ï–ù–´ ---
    
    const RESOURCE_PRICES = {
        '–†–ì': 22, 'CO2': 16, '–ú–¢': 18, '–ñ–ï': 17, '–•–õ': 20, 
        '–õ–î': 15, 'N': 19, '–ö–õ': 14, '–°–õ': 23, '–§–°': 11,
        '–ê–õ': 13, '–¢–¢': 25, '–ó–û': 10, '–°–í': 24, '–ù–ö': 21
    };

    const RESOURCE_DATABASE = {
        'A': { // TECH_ENERGY
            name: "–ì—Ä—É–ø–ø–∞ –ê (–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è)",
            level1: [ 
                { code: '–†–ì', name: '–†–µ–≥–æ–ª–∏—Ç', description: '–ú–∞—Ä—Å–∏–∞–Ω—Å–∫–∏–π –≥—Ä—É–Ω—Ç, –æ—Å–Ω–æ–≤–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è.', level: 1 },
                { code: 'CO2', name: '–£–≥–ª–µ–∫–∏—Å–ª—ã–π –ì–∞–∑', description: '–ò–∑ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã (–°–æ–±—Ä–∞–Ω–Ω—ã–π –≥–∞–∑).', level: 1 },
                { code: '–ú–¢', name: '–ú–µ—Ç–∞–Ω', description: '–°–ª–µ–¥–æ–≤—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–¥–ª—è —Ä–∞–∫–µ—Ç–Ω–æ–≥–æ —Ç–æ–ø–ª–∏–≤–∞).', level: 1 },
                { code: '–ñ–ï', name: '–ñ–µ–ª–µ–∑–æ', description: '–û–∫—Å–∏–¥ –∂–µ–ª–µ–∑–∞, –∏–∑–≤–ª–µ–∫–∞–µ–º—ã–π –∏–∑ –≥—Ä—É–Ω—Ç–∞.', level: 1 },
                { code: '–•–õ', name: '–•–ª–æ—Ä', description: '–ò–∑ –º–∏–Ω–µ—Ä–∞–ª–æ–≤ (–æ—á–∏—Å—Ç–∫–∞).', level: 1 },
            ],
            level2: [ 
                { code: '–ö–ü', name: '–ö—Ä–µ–º–Ω–∏–µ–≤—ã–µ –ü–ª–∞—Å—Ç–∏–Ω—ã', description: '–î–ª—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏ –∏ —Å–æ–ª–Ω–µ—á–Ω—ã—Ö –±–∞—Ç–∞—Ä–µ–π.', level: 2 },
                { code: 'CO', name: '–ú–æ–Ω–æ–æ–∫—Å–∏–¥ –£–≥–ª–µ—Ä–æ–¥–∞', description: '–ö–ª—é—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ç–æ–ø–ª–∏–≤–∞.', level: 2 },
                { code: '–ì–†', name: '–ì—Ä–∞—Ñ–µ–Ω', description: '–°–≤–µ—Ä—Ö–ª–µ–≥–∫–∏–µ –∏ –ø—Ä–æ—á–Ω—ã–µ –Ω–∞–Ω–æ—Ç—Ä—É–±–∫–∏.', level: 2 },
                { code: '–§–°', name: '–§–µ—Ä—Ä–æ—Å–ø–ª–∞–≤', description: '–°–ø–ª–∞–≤ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö —á–∞—Å—Ç–µ–π.', level: 2 },
                { code: '–≠–õ', name: '–≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç', description: '–î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –≤—ã—Å–æ–∫–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –±–∞—Ç–∞—Ä–µ–π.', level: 2 },
            ],
            level3: [ 
                { code: '–°–§', name: '–°–æ–ª–Ω–µ—á–Ω–∞—è –§–µ—Ä–º–∞', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫—É –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–∞ (–≠) –Ω–∞ +1/—Ö–æ–¥.', bonus: { type: 'POWER_BONUS', value: 1 }, level: 3 },
                { code: '–ê–í–£', name: '–ê–Ω—Ç–µ–Ω–Ω–∞ –í—ã—Å–æ–∫–æ–≥–æ –£—Å–∏–ª–µ–Ω–∏—è', description: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –ë–æ–Ω—É—Å –∫ –ó–ß –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è.', level: 3 },
                { code: '–°–¢', name: '–°–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¢–æ–ø–ª–∏–≤–æ', description: '–£—Å—Ç—Ä–∞–Ω—è–µ—Ç —à—Ç—Ä–∞—Ñ –≠ –¥–ª—è –¥–∞–ª—å–Ω–∏—Ö –ø–æ–µ–∑–¥–æ–∫ –Ω–∞ —Ä–æ–≤–µ—Ä–µ.', level: 3 },
                { code: '–ì–°', name: '–ì–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –°–∫–∞–Ω–µ—Ä', description: '–®–∞–Ω—Å –Ω–∞–π—Ç–∏ —Ä–µ–¥–∫–∏–π —Ä–µ—Å—É—Ä—Å (+1 –•–°) –≤ —Ñ–∞–∑–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.', level: 3 },
                { code: '–ò–ì', name: '–ò–∑–æ—Ç–æ–ø–Ω—ã–π –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', description: '+0.5 –≠ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏.', bonus: { type: 'POWER_BONUS', value: 0.5 }, level: 3 },
            ],
        },
        'B': { // BIO_LIFE
            name: "–ì—Ä—É–ø–ø–∞ –ë (–ë–∏–æ–ª–æ–≥–∏—è)",
            level1: [ { code: '–õ–î', name: '–õ–µ–¥', description: '–õ–µ–¥', level: 1 }, { code: 'N', name: '–ê–∑–æ—Ç', description: '–ê–∑–æ—Ç', level: 1 }, { code: '–ö–õ', name: '–ö–∞–ª–∏–π', description: '–ö–∞–ª–∏–π', level: 1 }, { code: '–°–õ', name: '–°–æ–ª–∏', description: '–°–æ–ª–∏', level: 1 }, { code: '–§–°', name: '–§–æ—Å—Ñ–æ—Ä', description: '–§–æ—Å—Ñ–æ—Ä', level: 1 }],
            level2: [ { code: 'H2O', name: '–ñ–∏–¥–∫–∞—è –í–æ–¥–∞', description: '–í–æ–¥–∞', level: 2 }, { code: '–ü–†', name: '–ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–π –†–∞—Å—Ç–≤–æ—Ä', description: '–ü–†', level: 2 }, { code: '–ö–£', name: '–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –£–¥–æ–±—Ä–µ–Ω–∏–π', description: '–ö–£', level: 2 }, { code: '–ú–î', name: '–ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã', description: '–ú–î', level: 2 }, { code: '–ü–ì', name: '–ü–∏—â–µ–≤–æ–π –ì–µ–ª—å', description: '–ü–ì', level: 2 }],
            level3: [ 
                { code: '–ú–ë', name: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ë–æ—Ç', description: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ó–≠ –Ω–∞ +5/—Ö–æ–¥.', level: 3, bonus: { type: 'HEALTH_BONUS', value: 5 } }, 
                { code: '–°–†–í', name: '–°–∏—Å—Ç–µ–º–∞ –†–µ—Ü–∏—Ä–∫—É–ª—è—Ü–∏–∏ –í–æ–¥—ã', description: '–£–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –í –Ω–∞ -2/—Ö–æ–¥.', level: 3, bonus: { type: 'WATER_REDUCTION', value: 2 } }, 
                { code: '–ë–†', name: '–ë–∏–æ-–†–µ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (–û‚ÇÇ)', description: '–£–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –í–ó –Ω–∞ -2/—Ö–æ–¥.', level: 3, bonus: { type: 'AIR_REDUCTION', value: 2 } }, 
                { code: '–ì–°–ï–ö', name: '–ì–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –°–µ–∫–≤–µ–Ω—Å–æ—Ä', description: '–ü–æ–≤—ã—à–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –ø–∏—â–∏.', level: 3 }, 
                { code: '–ê–û', name: '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –û–≥–æ—Ä–æ–¥', description: '–ó–∞–º–µ–Ω—è–µ—Ç —Ä—É—á–Ω–æ–π —Ç—Ä—É–¥, +5 –ó–≠/—Ö–æ–¥.', level: 3 }],
        },
        'C': { // CONSTRUCTION_REPAIR
            name: "–ì—Ä—É–ø–ø–∞ –í (–ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)",
            level1: [ { code: '–ê–õ', name: '–ê–ª—é–º–∏–Ω–∏–π', description: '–ê–ª—é–º–∏–Ω–∏–π', level: 1 }, { code: '–¢–¢', name: '–¢–∏—Ç–∞–Ω', description: '–¢–∏—Ç–∞–Ω', level: 1 }, { code: '–ó–û', name: '–ó–∞–≥—Ä—è–∑–Ω–µ–Ω–Ω—ã–µ –û—Ç—Ö–æ–¥—ã', description: '–û—Ç—Ö–æ–¥—ã', level: 1 }, { code: '–°–í', name: '–°—Ç–µ–∫–ª–æ–≤–æ–ª–æ–∫–Ω–æ', description: '–°—Ç–µ–∫–ª–æ–≤–æ–ª–æ–∫–Ω–æ', level: 1 }, { code: '–ù–ö', name: '–ù–∏–∫–µ–ª—å', description: '–ù–∏–∫–µ–ª—å', level: 1 }],
            level2: [ { code: '–õ–°', name: '–õ–µ–≥–∫–∏–π –°–ø–ª–∞–≤', description: '–°–ø–ª–∞–≤', level: 2 }, { code: '–ó–°', name: '–ó–∞–∫–∞–ª–µ–Ω–Ω—ã–π –°–ø–ª–∞–≤', description: '–°–ø–ª–∞–≤', level: 2 }, { code: '–í–ö', name: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã', description: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã', level: 2 }, { code: '–£–ü', name: '–£–ø—Ä–æ—á–Ω–µ–Ω–Ω—ã–π –ü–æ–ª–∏–º–µ—Ä', description: '–ü–æ–ª–∏–º–µ—Ä', level: 2 }, { code: '–ò–ö', name: '–ò–Ω–¥—É–∫—Ü–∏–æ–Ω–Ω–∞—è –ö–∞—Ç—É—à–∫–∞', description: '–ö–∞—Ç—É—à–∫–∞', level: 2 }],
            level3: [ 
                { code: '–ê–°–ì', name: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –°–∏—Å—Ç–µ–º–∞ –ì–µ—Ä–º–µ—Ç–∏–∑–∞—Ü–∏–∏', description: '–£–º–µ–Ω—å—à–∞–µ—Ç —à–∞–Ω—Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —É—Ç–µ—á–∫–∏ –í–ó.', level: 3 }, 
                { code: '–†–≠', name: '–†–∞–¥–∏–∞—Ü–∏–æ–Ω–Ω—ã–π –≠–∫—Ä–∞–Ω', description: '–ü–æ–≤—ã—à–∞–µ—Ç —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ–º–æ—Å—Ç—å –ó–≠.', level: 3 }, 
                { code: '–ê–ë–ü', name: '–ê–≤–∞—Ä–∏–π–Ω—ã–π –ë–ª–æ–∫ –ü–∏—Ç–∞–Ω–∏—è', description: '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ 15 –≠.', level: 3, bonus: { type: 'POWER_INSTANT', value: 15 } }, 
                { code: '–ö–û', name: '–ö–µ–≤–ª–∞—Ä–æ–≤–∞—è –û–±–æ–ª–æ—á–∫–∞', description: '–ó–∞—â–∏—Ç–∞ –æ—Ç –º–∏–∫—Ä–æ–º–µ—Ç–µ–æ—Ä–∏—Ç–æ–≤.', level: 3 }, 
                { code: '–°–°', name: '–°–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–∏–π—Å—è –°–∫–∞—Ñ–∞–Ω–¥—Ä', description: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–º–æ–Ω—Ç –ó–≠.', level: 3 }],
        },
    };
    
    // –ë–æ–Ω—É—Å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –£1 –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ—Å–Ω–æ–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã
    const PRIMARY_GROUP_BONUS_RESOURCES = {
        'A': ['–†–ì', 'CO2'], // –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è: –†–µ–≥–æ–ª–∏—Ç, CO2
        'B': ['–õ–î', 'N'],   // –ë–∏–æ–ª–æ–≥–∏—è: –õ–µ–¥, –ê–∑–æ—Ç
        'C': ['–ê–õ', '–¢–¢']   // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ê–ª—é–º–∏–Ω–∏–π, –¢–∏—Ç–∞–Ω
    };

    const RESOURCE_LOOKUP = {};
    Object.values(RESOURCE_DATABASE).forEach(category => {
        Object.keys(category).filter(key => key.startsWith('level')).forEach(levelKey => {
            category[levelKey].forEach(resource => {
                RESOURCE_LOOKUP[resource.code] = resource;
            });
        });
    });

    // –†–µ—Ü–µ–ø—Ç—ã –ö—Ä–∞—Ñ—Ç–∏–Ω–≥–∞ (–£1 -> –£2)
    const CRAFTING_RECIPES_R3 = {
        '–ö–ü': [{ code: '–†–ì', amount: 2 }], 'H2O': [{ code: '–õ–î', amount: 2 }], '–õ–°': [{ code: '–ê–õ', amount: 2 }],
        '–§–°': [{ code: '–ñ–ï', amount: 2 }], '–ü–†': [{ code: 'N', amount: 2 }], '–ó–°': [{ code: '–¢–¢', amount: 2 }],
        'CO': [{ code: 'CO2', amount: 2 }], '–ö–£': [{ code: '–ö–õ', amount: 2 }], '–í–ö': [{ code: '–°–í', amount: 2 }],
        '–ì–†': [{ code: '–ú–¢', amount: 2 }], '–ú–î': [{ code: '–°–õ', amount: 2 }], '–£–ü': [{ code: '–ù–ö', amount: 2 }],
    };

    // –†–µ—Ü–µ–ø—Ç—ã –ö—Ä–∞—Ñ—Ç–∏–Ω–≥–∞ (–£2 -> –£3)
    const CRAFTING_RECIPES_R4 = {
        '–°–§': [{ code: '–ö–ü', amount: 2 }], '–ú–ë': [{ code: 'H2O', amount: 2 }], '–ê–°–ì': [{ code: '–õ–°', amount: 2 }],
        '–ò–ì': [{ code: '–§–°', amount: 2 }], '–°–†–í': [{ code: '–ü–†', amount: 2 }], '–†–≠': [{ code: '–ó–°', amount: 2 }],
        '–ê–í–£': [{ code: 'CO', amount: 2 }], '–ë–†': [{ code: '–ö–£', amount: 2 }], '–ê–ë–ü': [{ code: '–í–ö', amount: 2 }],
        '–°–¢': [{ code: '–ì–†', amount: 2 }], '–ì–°–ï–ö': [{ code: '–ú–î', amount: 2 }], '–ö–û': [{ code: '–£–ü', amount: 2 }],
    };
    
    // –ó–∞–¥–∞–Ω–∏—è –¥–ª—è –†–∞—É–Ω–¥–∞ 1 (—Ç–æ–ª—å–∫–æ –£1 –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã)
    const ROUND_1_TASKS = {
        'A': { group: 'A', question: "–ö–∞–∫–æ–≤–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ (–ì–°)?", answer: "–ø–æ–∏—Å–∫ —Ä–µ–¥–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤", reward: { code: '–ñ–ï', amount: 1 }, points: 17 },
        'B': { group: 'B', question: "–ù–∞–∑–æ–≤–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É –≤–æ–¥—ã, –∫–æ—Ç–æ—Ä—É—é –¥–æ–±—ã–≤–∞—é—Ç –Ω–∞ –ú–∞—Ä—Å–µ.", answer: "–ª–µ–¥", reward: { code: '–õ–î', amount: 1 }, points: 15 },
        'C': { group: 'C', question: "–ö–∞–∫–æ–π —Ä–µ—Å—É—Ä—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –∏ –∏–º–µ–µ—Ç –∫–æ–¥ '–°–í'?", answer: "—Å—Ç–µ–∫–ª–æ–≤–æ–ª–æ–∫–Ω–æ", reward: { code: '–°–í', amount: 1 }, points: 24 },
    };
    
    // –ó–∞–¥–∞–Ω–∏—è –¥–ª—è –†–∞—É–Ω–¥–∞ 2 (–£1 —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–∏–µ - —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã)
    const ROUND_2_TASKS = {
        'A': { question: "–î–ª—è —á–µ–≥–æ –Ω—É–∂–µ–Ω –ò–∑–æ—Ç–æ–ø–Ω—ã–π –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä (–ò–ì)?", answer: "–ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è", reward: { code: 'CO2', amount: 1 }, penalty: { type: 'POWER', value: 3 } },
        'B': { question: "–ö–∞–∫–∏–µ —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è —É–¥–æ–±—Ä–µ–Ω–∏–π (–∫—Ä–æ–º–µ –≤–æ–¥—ã)?", answer: "–∞–∑–æ—Ç –∫–∞–ª–∏–π —Ñ–æ—Å—Ñ–æ—Ä", reward: { code: 'N', amount: 1 }, penalty: { type: 'WATER', value: 3 } },
        'C': { question: "–ö–∞–∫–æ–π –º–µ—Ç–∞–ª–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–≤–µ—Ä—Ö–ø—Ä–æ—á–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏ –∏–º–µ–µ—Ç –∫–æ–¥ '–¢–¢'?", answer: "—Ç–∏—Ç–∞–Ω", reward: { code: '–¢–¢', amount: 1 }, penalty: { type: 'HEALTH', value: 5 } }
    };
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –†–∞—É–Ω–¥–∞ 5 (–ê–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å)
    const APOCALYPSE_PENALTIES = [
        { type: 'WATER', value: 15, msg: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–æ—Ç–µ—Ä—è –≤–æ–¥—ã –∏–∑-–∑–∞ –ø—Ä–æ–±–æ–∏–Ω—ã –≤ —Ç—Ä—É–±–µ.' },
        { type: 'AIR', value: 10, msg: '–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ –≤–æ–∑–¥—É—Ö–∞ –≤ –∂–∏–ª–æ–º –æ—Ç—Å–µ–∫–µ.' },
        { type: 'HEALTH', value: 20, msg: '–°–∏–ª—å–Ω—ã–µ —Ç—Ä–∞–≤–º—ã —ç–∫–∏–ø–∞–∂–∞ –æ—Ç –ø–∞–¥–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.' }
    ];
    
    const CRISIS_DATABASE = {
        'A': { 
            name: "–≠–ù–ï–†–ì–ï–¢–ò–ß–ï–°–ö–ò–ô –®–¢–û–†–ú", 
            flaw: "–£—Ç–µ—á–∫–∞ –≠–Ω–µ—Ä–≥–∏–∏: -10 –≠ –≤ –∫–æ–Ω—Ü–µ —Ä–∞—É–Ω–¥–∞.", 
            resolved: false, 
            solution: { 
                resource: '–ò–ì', 
                task: { question: "–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Ç–æ–∫ (–≤ –ê), –µ—Å–ª–∏ U=20 –í, R=4 –û–º. ($I = U / R$)", answer: "5", rewardMsg: "–ê–≤–∞—Ä–∏–π–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—â–µ–Ω.", penalty: { type: 'POWER', value: 5 } } 
            } 
        },
        'B': { 
            name: "–ë–ò–û–õ–û–ì–ò–ß–ï–°–ö–ê–Ø –£–ì–†–û–ó–ê", 
            flaw: "–ö—Ä–∏–∑–∏—Å –í–æ–¥—ã: -5 –í –∏ –ó–¥–æ—Ä–æ–≤—å—è: -5 –ó–≠ –≤ –∫–æ–Ω—Ü–µ —Ä–∞—É–Ω–¥–∞.", 
            resolved: false, 
            solution: { 
                resource: '–°–†–í', 
                task: { question: "–ö–∞–∫–æ–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏—è–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–∏—Å–ª–æ—Ä–æ–¥?", answer: "—Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑", rewardMsg: "–°–∏—Å—Ç–µ–º–∞ —Ä–µ—Ü–∏—Ä–∫—É–ª—è—Ü–∏–∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞.", penalty: { type: 'WATER', value: 5 } } 
            } 
        },
        'C': { 
            name: "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–û–ò–ù–ê", 
            flaw: "–£—Ç–µ—á–∫–∞ –í–æ–∑–¥—É—Ö–∞: -5 –í–ó –∏ –ó–¥–æ—Ä–æ–≤—å—è: -5 –ó–≠ –≤ –∫–æ–Ω—Ü–µ —Ä–∞—É–Ω–¥–∞.", 
            resolved: false, 
            solution: { 
                resource: '–ê–°–ì', 
                task: { question: "–ö–∞–∫–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –¥–∞–µ—Ç —Å–ø–ª–∞–≤ –¢–∏—Ç–∞–Ω–∞ (–¢–¢) –¥–ª—è –∫–æ—Ä–ø—É—Å–∞?", answer: "—Å–≤–µ—Ä—Ö–ø—Ä–æ—á–Ω–æ—Å—Ç—å", rewardMsg: "–ü—Ä–æ–±–æ–∏–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞.", penalty: { type: 'HEALTH', value: 10 } } 
            } 
        }
    };

    const ROUND_6_CHALLENGE = {
        name: "–°–û–ó–î–ê–ù–ò–ï –°–í–ï–†–•–î–ê–õ–¨–ù–ï–ì–û –¢–†–ê–ù–°–ü–û–ù–î–ï–†–ê",
        flaw: "–¢–æ–ª—å–∫–æ –º–æ—â–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä –º–æ–∂–µ—Ç –ø—Ä–æ–±–∏—Ç—å –∏–æ–Ω–Ω—É—é –±—É—Ä—é –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª —Å–ø–∞—Å–µ–Ω–∏—è.",
        cost: [
            { code: '–§–°', amount: 2, group: 'A' }, // –§–µ—Ä—Ä–æ—Å–ø–ª–∞–≤ (A, –£2)
            { code: '–ü–†', amount: 2, group: 'B' }, // –ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–π –†–∞—Å—Ç–≤–æ—Ä (B, –£2)
            { code: '–ó–°', amount: 2, group: 'C' }  // –ó–∞–∫–∞–ª–µ–Ω–Ω—ã–π –°–ø–ª–∞–≤ (C, –£2)
        ],
        task: {
            question: "–ö–∞–∫–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫ –æ—Ä–±–∏—Ç–∞–ª—å–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∫–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—á–µ—Å—Ç—å –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –æ–∫–Ω–∞ –∑–∞–ø—É—Å–∫–∞ —Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞–ø–ø–∞—Ä–∞—Ç–∞?",
            answer: "–æ—Ä–±–∏—Ç–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ",
            rewardMsg: "–†–∞—Å—á–µ—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –¢—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É.",
            penalty: { type: 'HEALTH', value: 15 }
        }
    };
    
    // --- 3. –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ---
    
    function updateResourceDisplay() {
        document.getElementById('resource-power').textContent = Math.max(0, gameData.resources.POWER);
        document.getElementById('resource-water').textContent = Math.max(0, gameData.resources.WATER);
        document.getElementById('resource-air').textContent = Math.max(0, gameData.resources.AIR);
        document.getElementById('resource-health').textContent = Math.max(0, gameData.resources.HEALTH);
        document.getElementById('resource-points').textContent = gameData.points;

        const inventoryList = document.getElementById('inventory-list');
        inventoryList.innerHTML = '';
        
        let hasInventory = false;
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é (–£1, –£2, –£3)
        const sortedInventory = Object.keys(gameData.inventory).sort((a, b) => {
            const levelA = RESOURCE_LOOKUP[a]?.level || 0;
            const levelB = RESOURCE_LOOKUP[b]?.level || 0;
            return levelA - levelB;
        });

        sortedInventory.forEach(code => {
            const count = gameData.inventory[code];
            if (count > 0) {
                hasInventory = true;
                const res = RESOURCE_LOOKUP[code];
                const item = document.createElement('li');
                item.className = 'inventory-item';
                const levelColor = res.level === 1 ? '#e0e0e0' : (res.level === 2 ? '#00ffff' : '#ffcc00');
                item.innerHTML = `<span style="color: ${levelColor}; font-weight: bold;">${res.name}</span> (${res.code} - –£${res.level}): ${count}`;
                inventoryList.appendChild(item);
            }
        });
        if (!hasInventory) {
             inventoryList.innerHTML = '<li class="inventory-item">–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤</li>';
        }
    }

    function logEvent(message, isError = false) {
        const logBox = document.getElementById('log-box');
        const p = document.createElement('p');
        const timestamp = new Date().toLocaleTimeString('ru-RU', { hour12: false });
        p.innerHTML = `[${timestamp}] ${message}`;
        if (isError) {
            p.classList.add('error');
        }
        logBox.prepend(p); 
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ª–æ–≥–∞ 20 –∑–∞–ø–∏—Å—è–º–∏
        while (logBox.children.length > 20) {
            logBox.removeChild(logBox.lastChild);
        }
    }

    function updateGroupDisplay() {
        const activeGroupDisplay = document.getElementById('active-group-display');
        if (gameData.primaryGroup) {
            activeGroupDisplay.textContent = `${gameData.primaryGroup} (${RESOURCE_DATABASE[gameData.primaryGroup].name})`;
        } else {
            activeGroupDisplay.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
        }
    }

// --- –§–ê–ó–ê –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–û–ì–û –í–´–ë–û–†–ê (ROUND 0) ---

    function setPrimaryGroup(group) {
        if (gameData.primaryGroup) return; // –ó–∞–ø—Ä–µ—Ç –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–±–æ—Ä
        
        gameData.primaryGroup = group;
        
        // 1. –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
        PRIMARY_GROUP_BONUS_RESOURCES[group].forEach(code => {
            gameData.inventory[code] = (gameData.inventory[code] || 0) + 2; // +2 –µ–¥. –£1
            logEvent(`–ë–û–ù–£–°: –û—Å–Ω–æ–≤–Ω–∞—è –ì—Ä—É–ø–ø–∞ ${group} –ø–æ–ª—É—á–∏–ª–∞ **2 –µ–¥.** ${RESOURCE_LOOKUP[code].name} (${code}).`);
        });

        // 2. –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
        document.getElementById('pre-select-group-a').disabled = true;
        document.getElementById('pre-select-group-b').disabled = true;
        document.getElementById('pre-select-group-c').disabled = true;
        document.getElementById(`pre-select-group-${group.toLowerCase()}`).classList.add('active-group');

        // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        document.getElementById('group-selection-status').textContent = `‚úÖ –í–´–ë–†–ê–ù–ê –ü–û–°–¢–û–Ø–ù–ù–ê–Ø –ì–†–£–ü–ü–ê ${group} (${RESOURCE_DATABASE[group].name}). –ù–∞—á–∏–Ω–∞–µ–º –†–∞—É–Ω–¥ 1.`;
        
        // 4. –ü–µ—Ä–µ—Ö–æ–¥ –∫ –†–∞—É–Ω–¥—É 1 (–ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä—ã)
        document.getElementById('pre-game-selector').style.display = 'none';
        document.getElementById('main-game-interface').style.display = 'block';
        
        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–∞—É–Ω–¥—É 1 —á–µ—Ä–µ–∑ nextRound, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É
        document.getElementById('end-round-button').textContent = `–ù–ê–ß–ê–¢–¨ –ú–ò–°–°–ò–Æ (–ü–ï–†–ï–ô–¢–ò –ö –†–ê–£–ù–î–£ 1)`;
        document.getElementById('end-round-button').disabled = false;
        
        updateGroupDisplay();
        updateResourceDisplay();
        logEvent('–°–ò–°–¢–ï–ú–ê: –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ù–ê–ß–ê–¢–¨ –ú–ò–°–°–ò–Æ" –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞.', false);
    }
    
// --- –õ–û–ì–ò–ö–ê –ü–û–ö–£–ü–ö–ò (–†–ê–£–ù–î 1) ---

    /** –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ –ø–æ–∫—É–ø–∫–∏ –∏ —Å—Ç–∞—Ç—É—Å –∫–Ω–æ–ø–∫–∏ "–ö–£–ü–ò–¢–¨" */
    function updateBuyCount(inputId, delta, unitPrice) {
        const input = document.getElementById(inputId);
        if (!input) return;

        let count = parseInt(input.value) + delta;
        const maxBuyable = Math.floor(gameData.points / unitPrice);
        
        if (maxBuyable === 0) {
             count = 0;
        } else if (count < 1) {
            count = 1;
        } else if (count > maxBuyable) {
            count = maxBuyable;
        }
        
        input.value = count;
        checkBuyButtonStatus(inputId, unitPrice);
    }

    /** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–Ω–æ–ø–∫–∏ "–ö–£–ü–ò–¢–¨" */
    function checkMaxBuyable(inputId, unitPrice) {
        const input = document.getElementById(inputId);
        if (!input) return;

        let count = parseInt(input.value);
        const maxBuyable = Math.floor(gameData.points / unitPrice);

        if (isNaN(count) || count < 1) {
            count = maxBuyable > 0 ? 1 : 0;
        }
        
        if (count > maxBuyable && maxBuyable > 0) {
            count = maxBuyable;
            logEvent(`–í–Ω–∏–º–∞–Ω–∏–µ: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å, —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${maxBuyable} –µ–¥–∏–Ω–∏—Ü.`, true);
        } else if (count > 0 && maxBuyable === 0) {
             count = 0;
        }

        input.value = count;
        checkBuyButtonStatus(inputId, unitPrice);
    }
    
    /** –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–ö–£–ü–ò–¢–¨" */
    function checkBuyButtonStatus(inputId, unitPrice) {
        const input = document.getElementById(inputId);
        const buyButton = input.parentElement.querySelector('.buy-button-R1');
        const currentCount = parseInt(input.value);
        
        if (buyButton) {
            buyButton.disabled = currentCount <= 0 || currentCount * unitPrice > gameData.points;
            buyButton.textContent = currentCount <= 0 ? '–ù–ï–¢ –ë–ê–õ–õ–û–í' : `–ö–£–ü–ò–¢–¨ (${currentCount * unitPrice} –ë–ê–õ–õ–û–í)`;
        }
    }
    
    /** –ü–æ–∫—É–ø–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Å—É—Ä—Å–∞ */
    function buyResource(code, quantity) {
        const price = RESOURCE_PRICES[code];
        const totalPrice = price * quantity;

        if (gameData.points >= totalPrice && quantity > 0) {
            gameData.points -= totalPrice;
            gameData.inventory[code] = (gameData.inventory[code] || 0) + quantity;
            logEvent(`–ü–æ–∫—É–ø–∫–∞: **${quantity} –µ–¥.** ${RESOURCE_LOOKUP[code].name} (${code}). –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: **${totalPrice} –ë**.`);
            
            updateResourceDisplay(); 
            // –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            renderRound1Actions(); 

        } else {
            logEvent(`–û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ (${gameData.points}) –¥–ª—è –ø–æ–∫—É–ø–∫–∏ ${quantity} –µ–¥. ${code} (–¢—Ä–µ–±—É–µ—Ç—Å—è ${totalPrice})!`, true);
        }
    }

// --- –†–ê–£–ù–î 1 –õ–û–ì–ò–ö–ê (–ó–ê–ö–£–ü–ö–ê –∏ –î–û–ë–´–ß–ê –£1) ---

    function renderRound1Actions() { 
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        document.getElementById('action-prompt').textContent = `–î–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–ª–ª—ã: ${gameData.points}. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—É—Ä—Å –£1 –¥–ª—è –ø–æ–∫—É–ø–∫–∏ (–§–∞–∑–∞ 1/2).`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –ó–ê–ö–£–ü–ö–ò (–£1)`;
        document.getElementById('end-round-button').disabled = true; 

        const level1Resources = Object.values(RESOURCE_DATABASE).flatMap(cat => cat.level1);

        level1Resources.forEach(res => {
            const price = RESOURCE_PRICES[res.code];
            const maxBuyable = Math.floor(gameData.points / price);
            const inputId = `buy-count-${res.code}`;
            let currentCount = maxBuyable > 0 ? 1 : 0;
            if (maxBuyable === 0) currentCount = 0;
            
            const itemContainer = document.createElement('div');
            itemContainer.className = 'action-item-container';

            const info = document.createElement('span');
            info.innerHTML = `<strong>${res.name}</strong> (${res.code}) | –¶–µ–Ω–∞ –∑–∞ 1 –µ–¥.: <span style="color: #ffcc00;">${price} –ë</span>`;
            itemContainer.appendChild(info);

            const controls = document.createElement('div');
            controls.className = 'action-controls';

            // –ö–Ω–æ–ø–∫–∞ –ú–ò–ù–£–° (-)
            const btnMinus = document.createElement('button');
            btnMinus.textContent = '‚Äì';
            btnMinus.onclick = () => updateBuyCount(inputId, -1, price);
            btnMinus.disabled = maxBuyable < 1; 
            controls.appendChild(btnMinus);

            // –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            const input = document.createElement('input');
            input.type = 'number';
            input.id = inputId;
            input.value = currentCount; 
            input.min = 0;
            input.max = maxBuyable;
            input.style.width = '40px';
            input.style.textAlign = 'center';
            input.disabled = maxBuyable < 1;
            input.onchange = () => checkMaxBuyable(inputId, price);
            controls.appendChild(input);
            
            // –ö–Ω–æ–ø–∫–∞ –ü–õ–Æ–° (+)
            const btnPlus = document.createElement('button');
            btnPlus.textContent = '+';
            btnPlus.onclick = () => updateBuyCount(inputId, 1, price);
            btnPlus.disabled = maxBuyable < 1; 
            controls.appendChild(btnPlus);

            // –ö–Ω–æ–ø–∫–∞ –ü–û–ö–£–ü–ö–ê
            const buyButton = document.createElement('button');
            buyButton.className = 'buy-button-R1';
            const buttonText = maxBuyable < 1 ? '–ù–ï–¢ –ë–ê–õ–õ–û–í' : `–ö–£–ü–ò–¢–¨ (${currentCount * price} –ë–ê–õ–õ–û–í)`;
            buyButton.textContent = buttonText;
            buyButton.onclick = () => {
                const count = parseInt(document.getElementById(inputId).value);
                if (count > 0) {
                    buyResource(res.code, count);
                }
            };
            buyButton.disabled = maxBuyable < 1;
            controls.appendChild(buyButton);

            itemContainer.appendChild(controls);
            actionsDiv.appendChild(itemContainer);
        });

        const endBuyPhaseButton = document.createElement('button');
        endBuyPhaseButton.id = 'end-buy-phase';
        endBuyPhaseButton.className = 'end-round-button round-action-button-main';
        endBuyPhaseButton.textContent = '–ó–ê–í–ï–†–®–ò–¢–¨ –ó–ê–ö–£–ü–ö–£ –ò –ü–ï–†–ï–ô–¢–ò –ö –î–û–ë–´–ß–ï (–ó–ê–î–ê–ù–ò–ï)';
        endBuyPhaseButton.style.backgroundColor = '#f39c12';
        endBuyPhaseButton.style.borderColor = '#e67e22';
        endBuyPhaseButton.onclick = startRound1TaskPhase;
        actionsDiv.appendChild(endBuyPhaseButton);
    }
    
    function startRound1TaskPhase() { 
        if (gameData.taskCompleted) {
             logEvent('–§–∞–∑–∞ –¥–æ–±—ã—á–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É.', true);
             document.getElementById('end-round-button').disabled = false;
             return;
        }

        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        document.getElementById('action-prompt').textContent = `–§–∞–∑–∞ 2/2: –î–û–ë–´–ß–ê. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –ì—Ä—É–ø–ø—ã **${gameData.primaryGroup}** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –£1 –∏ –±–∞–ª–ª–æ–≤.`;
        document.getElementById('action-header-text').textContent = `2. –§–ê–ó–ê –î–û–ë–´–ß–ò (–ó–ê–î–ê–ù–ò–ï)`;

        const task = ROUND_1_TASKS[gameData.primaryGroup];
        const taskElement = document.createElement('div');
        taskElement.style.marginBottom = '15px';
        taskElement.innerHTML = `
            <h3 style="color: #3498db;">–ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} | üí° –ó–∞–¥–∞–Ω–∏–µ: **${task.question}**</h3>
            <p style="color: #ffcc00;">–ù–∞–≥—Ä–∞–¥–∞: **${task.reward.amount} –µ–¥.** ${RESOURCE_LOOKUP[task.reward.code].name} (${task.reward.code}) –∏ **${task.points} –ë–ê–õ–õ–û–í**</p>
            <input type="text" id="task-input-R1" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç (1-2 —Å–ª–æ–≤–∞)" style="width: 300px; padding: 8px; margin-right: 10px;">
            <button id="task-button-R1" onclick="submitRound1Task()" class="round-action-button-main" style="width: auto; background: #3498db;">
                –í–´–ü–û–õ–ù–ò–¢–¨ –ó–ê–î–ê–ù–ò–ï
            </button>
        `;
        actionsDiv.appendChild(taskElement);

        document.getElementById('end-round-button').disabled = true;
    }

    function submitRound1Task() { 
        if (gameData.taskCompleted) return;

        const task = ROUND_1_TASKS[gameData.primaryGroup];
        const input = document.getElementById(`task-input-R1`);
        const button = document.getElementById(`task-button-R1`);
        
        const answer = input.value.trim().toLowerCase().replace(/ /g, "");
        const expected = task.answer.toLowerCase().replace(/ /g, "");
        
        button.disabled = true;
        input.disabled = true;

        if (answer === expected) {
            gameData.inventory[task.reward.code] = (gameData.inventory[task.reward.code] || 0) + task.reward.amount;
            gameData.points += task.points;
            gameData.taskCompleted = true;

            logEvent(`‚úÖ –£–°–ü–ï–•! –ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –¥–æ–±—ã–ª–∞ 1 –µ–¥. **${task.reward.code}** –∏ –ø–æ–ª—É—á–∏–ª–∞ **${task.points} –ë**.`);
            document.getElementById('action-prompt').textContent = '–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –†–∞—É–Ω–¥—É 2.';

        } else {
            logEvent(`‚ùå –ü–†–û–í–ê–õ. –ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç. –†–µ—Å—É—Ä—Å –Ω–µ –ø–æ–ª—É—á–µ–Ω.`, true);
            document.getElementById('action-prompt').textContent = '–ó–∞–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–ª–µ–Ω–æ. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –†–∞—É–Ω–¥—É 2.';
            gameData.taskCompleted = true; // –ó–∞–¥–∞–Ω–∏–µ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        }

        updateResourceDisplay();
        document.getElementById('end-round-button').disabled = false; // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏
    }


    function initRound1() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–ü–ï–†–ï–ô–¢–ò –ö 2)`;
        
        gameData.taskCompleted = false; // –°–±—Ä–æ—Å
        logEvent('–°–ò–°–¢–ï–ú–ê: –ó–∞–ø—É—Å–∫ –ü—Ä–æ—Ç–æ–∫–æ–ª–∞ –†–∞—É–Ω–¥–∞ 1. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–∫—É–ø–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤ –£—Ä–æ–≤–Ω—è 1 (100 –ë–∞–ª–ª–æ–≤).');
        renderRound1Actions();
        updateResourceDisplay();
    }
    
// --- –†–ê–£–ù–î 2 –õ–û–ì–ò–ö–ê (–î–û–ë–û–† –£1 - –û–î–ù–ê –ì–†–£–ü–ü–ê) ---

    function initRound2() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –î–û–ë–´–ß–ò –£1 (–û–î–ò–ù –†–ï–°–£–†–°)`;
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–ü–ï–†–ï–ô–¢–ò –ö 3)`;
        
        gameData.taskCompleted = false; // –°–±—Ä–æ—Å –¥–ª—è –†2
        renderRound2Actions();
        logEvent(`–°–ò–°–¢–ï–ú–ê: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –†–∞—É–Ω–¥ 2. –ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞–Ω–∏–µ –¥–æ–±—ã—á–∏ —Ä–µ—Å—É—Ä—Å–∞ –£1.`);
    }
    
    function renderRound2Actions() {
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        
        if (gameData.taskCompleted) {
            document.getElementById('action-prompt').textContent = `–î–µ–π—Å—Ç–≤–∏–µ –ì—Ä—É–ø–ø—ã ${gameData.primaryGroup} –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –†–∞—É–Ω–¥—É 3.`;
            actionsDiv.innerHTML = `<p style="text-align: center; color: #00ffaa;">–î–µ–π—Å—Ç–≤–∏–µ –ì—Ä—É–ø–ø—ã ${gameData.primaryGroup} –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.</p>`;
            document.getElementById('end-round-button').disabled = false;
            return;
        }

        const task = ROUND_2_TASKS[gameData.primaryGroup];
        
        actionsDiv.innerHTML = `
            <div style="padding: 10px; border: 1px solid #3498db;">
                <h3 style="color: #3498db;">–ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} | üí° –ó–∞–¥–∞–Ω–∏–µ: **${task.question}**</h3>
                <p style="color: #ffcc00;">–ù–∞–≥—Ä–∞–¥–∞: **1 –µ–¥.** ${RESOURCE_LOOKUP[task.reward.code].name} (${task.reward.code}).</p>
                <p class="error" style="font-size: 0.9em;">–®—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç: **-${task.penalty.value} ${task.penalty.type.toUpperCase()}**</p>
                
                <input type="text" id="task-input-R2" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç" style="width: 300px; padding: 8px; margin-right: 10px;">
                <button id="task-button-R2" onclick="submitRound2Task()" class="round-action-button-main" style="width: auto; background: #3498db;">
                    –í–´–ü–û–õ–ù–ò–¢–¨ –î–ï–ô–°–¢–í–ò–ï
                </button>
            </div>
        `;
        document.getElementById('end-round-button').disabled = true;
    }

    function submitRound2Task() {
        if (gameData.taskCompleted) return;

        const input = document.getElementById('task-input-R2');
        const button = document.getElementById('task-button-R2');
        const task = ROUND_2_TASKS[gameData.primaryGroup];

        const answer = input.value.trim().toLowerCase().replace(/ /g, "");
        const expected = task.answer.toLowerCase().replace(/ /g, "");
        
        button.disabled = true;
        input.disabled = true;
        
        gameData.taskCompleted = true; // –î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
        
        if (answer.includes(expected) || expected.includes(answer)) { 
            gameData.inventory[task.reward.code] = (gameData.inventory[task.reward.code] || 0) + task.reward.amount;
            logEvent(`‚úÖ –£–°–ü–ï–•! –ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –¥–æ–±—ã–ª–∞ 1 –µ–¥. **${task.reward.code}**.`);
        } else {
            const penaltyType = task.penalty.type.toUpperCase();
            const penaltyValue = task.penalty.value;
            
            gameData.resources[penaltyType] -= penaltyValue; 
            
            logEvent(`‚ùå –ü–†–û–í–ê–õ. –ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –Ω–µ —Å–º–æ–≥–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ. –®—Ç—Ä–∞—Ñ: **-${penaltyValue} ${penaltyType}**!`, true);
        }
        
        updateResourceDisplay();
        renderRound2Actions(); 
    }

// --- –ö–†–ê–§–¢–ò–ù–ì –õ–û–ì–ò–ö–ê (–†3 - –£2, –†4 - –£3) ---

    function tryCrafting(outputCode, recipe, isR4 = false) {
        let missingResources = [];

        recipe.forEach(r => {
            if ((gameData.inventory[r.code] || 0) < r.amount) {
                missingResources.push({ code: r.code, needed: r.amount, have: (gameData.inventory[r.code] || 0) });
            }
        });

        if (missingResources.length > 0) {
            const missingText = missingResources.map(m => `${m.code} (–ù–∞–¥–æ: ${m.needed}, –ï—Å—Ç—å: ${m.have})`).join(', ');
            logEvent(`‚ùå –û–®–ò–ë–ö–ê –ö–†–ê–§–¢–ò–ù–ì–ê: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤. –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: ${missingText}.`, true);
            return;
        }

        recipe.forEach(r => {
            gameData.inventory[r.code] -= r.amount;
        });

        gameData.inventory[outputCode] = (gameData.inventory[outputCode] || 0) + 1;
        
        logEvent(`‚úÖ –£–°–ü–ï–•! –ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –ø—Ä–æ–∏–∑–≤–µ–ª–∞ **1 –µ–¥.** ${RESOURCE_LOOKUP[outputCode].name} (**${outputCode}** - –£${RESOURCE_LOOKUP[outputCode].level}).`);

        updateResourceDisplay();
        if (!isR4) {
            renderRound3Actions();
        } else {
            renderRound4Actions();
        }
    }

// --- –†–ê–£–ù–î 3 –õ–û–ì–ò–ö–ê (–ö–†–ê–§–¢–ò–ù–ì –£2) ---
    function initRound3() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –ö–†–ê–§–¢–ò–ù–ì–ê –£2 (–£1 -> –£2)`;
        document.getElementById('action-prompt').textContent = `–ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –Ω–∞—á–∏–Ω–∞–µ—Ç –∫—Ä–∞—Ñ—Ç–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ **–£—Ä–æ–≤–Ω—è 2**. –î–µ–π—Å—Ç–≤–∏–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ.`;
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–ü–ï–†–ï–ô–¢–ò –ö 4)`;

        renderRound3Actions();
        logEvent(`–°–ò–°–¢–ï–ú–ê: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –†–∞—É–Ω–¥ 3. –ö—Ä–∞—Ñ—Ç–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ –£—Ä–æ–≤–Ω—è 2.`);
        document.getElementById('end-round-button').disabled = false; // –ö—Ä–∞—Ñ—Ç–∏–Ω–≥ –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω
    }
    
    function renderRound3Actions() {
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        
        const category = gameData.primaryGroup;
        const level2Resources = RESOURCE_DATABASE[category].level2;
        
        level2Resources.forEach(res => {
            const recipe = CRAFTING_RECIPES_R3[res.code];
            if (!recipe) return; 

            let canCraft = true;
            let missingText = [];
            
            recipe.forEach(r => {
                const have = gameData.inventory[r.code] || 0;
                if (have < r.amount) {
                    canCraft = false;
                    missingText.push(`${r.amount - have} –µ–¥. ${r.code}`);
                }
            });
            
            const neededText = recipe.map(r => `${r.amount} –µ–¥. ${RESOURCE_LOOKUP[r.code].name} (${r.code})`).join(', ');
            
            const itemContainer = document.createElement('div');
            itemContainer.className = 'crafting-item';
            
            const info = document.createElement('span');
            info.innerHTML = `<strong style="color: #00ffff;">${res.name}</strong> (${res.code} - –£2) | –¢—Ä–µ–±—É–µ—Ç—Å—è: ${neededText}`;
            itemContainer.appendChild(info);
            
            const controls = document.createElement('div');
            controls.className = 'action-controls';

            const status = document.createElement('span');
            status.className = canCraft ? 'crafting-info' : 'crafting-info missing';
            status.textContent = canCraft ? '–ì–û–¢–û–í–û –ö –ü–†–û–ò–ó–í–û–î–°–¢–í–£' : `–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –£1: ${missingText.join(', ')}`;
            controls.appendChild(status);

            const button = document.createElement('button');
            button.textContent = `–ö–†–ê–§–¢–ò–¢–¨ 1 –ï–î.`;
            button.style.backgroundColor = canCraft ? '#2ecc71' : '#7f8c8d';
            button.onclick = () => tryCrafting(res.code, recipe, false);
            button.disabled = !canCraft;

            controls.appendChild(button);
            itemContainer.appendChild(controls);
            actionsDiv.appendChild(itemContainer);
        });
    }


// --- –†–ê–£–ù–î 4 –õ–û–ì–ò–ö–ê (–ö–†–ê–§–¢–ò–ù–ì –£3) ---
    function initRound4() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –ö–†–ê–§–¢–ò–ù–ì–ê –£3 (–£2 -> –£3)`;
        
        document.getElementById('action-prompt').textContent = `–ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –Ω–∞—á–∏–Ω–∞–µ—Ç –∫—Ä–∞—Ñ—Ç–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º **–£—Ä–æ–≤–Ω—è 3**. –î–µ–π—Å—Ç–≤–∏–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ.`;
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–ü–ï–†–ï–ô–¢–ò –ö –ö–†–ò–ó–ò–°–£)`;
        
        renderRound4Actions();
        logEvent(`–°–ò–°–¢–ï–ú–ê: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –†–∞—É–Ω–¥ 4. –ö—Ä–∞—Ñ—Ç–∏–Ω–≥ –≥–æ—Ç–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –£—Ä–æ–≤–Ω—è 3 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ë–æ–Ω—É—Å—ã).`);
        document.getElementById('end-round-button').disabled = false;
    }

    function renderRound4Actions() {
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        
        const category = gameData.primaryGroup;
        const level3Resources = RESOURCE_DATABASE[category].level3;
        
        level3Resources.forEach(res => {
            const recipe = CRAFTING_RECIPES_R4[res.code];
            if (!recipe) return;

            let canCraft = true;
            let missingText = [];
            
            recipe.forEach(r => {
                const have = gameData.inventory[r.code] || 0;
                if (have < r.amount) {
                    canCraft = false;
                    missingText.push(`${r.amount - have} –µ–¥. ${r.code}`);
                }
            });
            
            const neededText = recipe.map(r => `${r.amount} –µ–¥. ${RESOURCE_LOOKUP[r.code].name} (${r.code})`).join(', ');
            
            const itemContainer = document.createElement('div');
            itemContainer.className = 'crafting-item';
            
            const info = document.createElement('span');
            info.innerHTML = `<strong style="color: #ffcc00;">${res.name}</strong> (${res.code} - –£3) | –¢—Ä–µ–±—É–µ—Ç—Å—è: ${neededText}`;
            itemContainer.appendChild(info);
            
            const controls = document.createElement('div');
            controls.className = 'action-controls';

            const status = document.createElement('span');
            status.className = canCraft ? 'crafting-info' : 'crafting-info missing';
            status.textContent = canCraft ? '–ì–û–¢–û–í–û –ö –ü–û–°–¢–†–û–ô–ö–ï' : `–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –£2: ${missingText.join(', ')}`;
            controls.appendChild(status);

            const button = document.createElement('button');
            button.textContent = `–ü–û–°–¢–†–û–ò–¢–¨ 1 –ï–î.`;
            button.style.backgroundColor = canCraft ? '#1abc9c' : '#7f8c8d';
            button.onclick = () => tryCrafting(res.code, recipe, true); // True –¥–ª—è –£3
            button.disabled = !canCraft;

            controls.appendChild(button);
            itemContainer.appendChild(controls);
            actionsDiv.appendChild(itemContainer);
        });
    }

// --- –†–ê–£–ù–î 5 –õ–û–ì–ò–ö–ê (–ê–ü–û–ö–ê–õ–ò–ü–°–ò–° - –û–î–ò–ù –ö–†–ò–ó–ò–°) ---
    function initRound5() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –£–°–¢–†–ê–ù–ï–ù–ò–Ø –ö–†–ò–ó–ò–°–ê`;
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–ü–ï–†–ï–ô–¢–ò –ö 6)`;
        
        // –£—Ä–æ–Ω –æ—Ç –ê–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å–∞
        APOCALYPSE_PENALTIES.forEach(p => {
            gameData.resources[p.type.toUpperCase()] -= p.value;
            logEvent(`üö® –ö–†–ò–ó–ò–°–ù–´–ô –£–†–û–ù: **-${p.value} ${p.type.toUpperCase()}**. ${p.msg}`, true);
        });
        
        document.getElementById('action-prompt').textContent = `–†–ê–£–ù–î 5: –ö–†–ò–ó–ò–° –ê–ö–¢–ò–í–ù–û–ô –ì–†–£–ü–ü–´! –£—Å—Ç—Ä–∞–Ω–∏—Ç–µ —É–≥—Ä–æ–∑—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å –ì—Ä—É–ø–ø–æ–π **${gameData.primaryGroup}**.`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å resolved –∫—Ä–∏–∑–∏—Å–∞
        CRISIS_DATABASE[gameData.primaryGroup].resolved = gameData.taskCompleted; 
        
        renderRound5Actions();
        logEvent(`–°–ò–°–¢–ï–ú–ê: –ó–∞–ø—É—â–µ–Ω –†–∞—É–Ω–¥ 5. –ö—Ä–∏–∑–∏—Å ${CRISIS_DATABASE[gameData.primaryGroup].name} –∞–∫—Ç–∏–≤–µ–Ω! –°—Ä–æ—á–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç–µ —É–≥—Ä–æ–∑—É!`, true);
        updateResourceDisplay();
        document.getElementById('end-round-button').disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ –ø–æ–ø—ã—Ç–∫–∏
    }
    
    function renderRound5Actions() {
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        
        const groupCode = gameData.primaryGroup;
        const crisis = CRISIS_DATABASE[groupCode];

        if (crisis.resolved) {
            document.getElementById('action-prompt').textContent = '–ö—Ä–∏–∑–∏—Å —É—Å–ø–µ—à–Ω–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞—É–Ω–¥.';
            actionsDiv.innerHTML = `<p style="text-align: center; color: #2ecc71;">‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É–≥—Ä–æ–∑–∞ **${crisis.name}** —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞.</p>`;
            document.getElementById('end-round-button').disabled = false;
            return;
        }

        const resourceCode = crisis.solution.resource;
        const task = crisis.solution.task;
        const hasResource = (gameData.inventory[resourceCode] || 0) > 0;
        
        actionsDiv.innerHTML = `
            <h2 style="color: #e74c3c;">üö® –ö–†–ò–ó–ò–° –ì–†–£–ü–ü–´ ${groupCode}: ${crisis.name}</h2>
            <p class="error">**–£–ì–†–û–ó–ê:** ${crisis.flaw}</p>
            <p style="font-weight: bold; margin-top: 15px;">–ú–ï–¢–û–î–´ –£–°–¢–†–ê–ù–ï–ù–ò–Ø:</p>
            
            <div style="border: 1px solid #3498db; padding: 10px; margin-bottom: 10px;">
                ${hasResource ? `
                    <button class="round-action-button-main" onclick="resolveCrisisResource('${groupCode}')" style="background: #2ecc71;">
                        –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –†–ï–°–£–†–° **${RESOURCE_LOOKUP[resourceCode].name}** (${resourceCode})
                    </button>
                    <p style="color: #00ffaa; font-size: 0.9em;">‚Äî –¢—Ä–µ–±—É–µ—Ç—Å—è: 1 –µ–¥. ${RESOURCE_LOOKUP[resourceCode].name}. –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç —É–≥—Ä–æ–∑—É.</p>
                ` : `
                    <button class="round-action-button-main" disabled style="background: #e74c3c; opacity: 0.7;">
                        –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –†–ï–°–£–†–°–ê **${RESOURCE_LOOKUP[resourceCode].name}** (${resourceCode})
                    </button>
                    <p style="color: #ff4444; font-size: 0.9em;">‚Äî –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ –£3 –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è.</p>
                `}
            </div>
            
            <div style="border: 1px solid #f1c40f; padding: 10px;">
                <h3 style="color: #f1c40f;">–†–£–ß–ù–û–ô –ü–†–û–¢–û–ö–û–õ (–ê–≤–∞—Ä–∏–π–Ω–æ–µ –†–µ—à–µ–Ω–∏–µ): ${task.question}</h3>
                <input type="text" id="task-input-R5" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç (1-2 —Å–ª–æ–≤–∞)" style="width: 300px; padding: 8px; margin-right: 10px;">
                <button id="task-button-R5" onclick="resolveCrisisTask('${groupCode}')" class="round-action-button-main" style="background: #f1c40f; color: #121212; width: auto;">
                    –í—ã–ø–æ–ª–Ω–∏—Ç—å –í—Ä—É—á–Ω—É—é (–û–î–ù–ê –ü–û–ü–´–¢–ö–ê)
                </button>
                <p style="font-size: 0.9em;">‚Äî –ù–∞–≥—Ä–∞–¥–∞: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —É–≥—Ä–æ–∑—ã. <span class="error">–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–≤–∞–ª: **-${task.penalty.value} ${task.penalty.type.toUpperCase()}**</span>.</p>
            </div>
        `;
        // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –±—ã–ª —Ä–µ—à–µ–Ω, –∫–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –≤ resolveCrisis
        document.getElementById('end-round-button').disabled = crisis.resolved ? false : true; 
    }

    function resolveCrisis(groupCode, isSuccess) {
        const crisis = CRISIS_DATABASE[groupCode];
        
        if (isSuccess) {
            CRISIS_DATABASE[groupCode].resolved = true;
            gameData.taskCompleted = true; // –§–ª–∞–≥, —á—Ç–æ –∫—Ä–∏–∑–∏—Å —Ä–∞–∑—Ä–µ—à–µ–Ω/–ø–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞–Ω–∞
            logEvent(`‚úÖ –£–ì–†–û–ó–ê –£–°–¢–†–ê–ù–ï–ù–ê: –ö—Ä–∏–∑–∏—Å **${crisis.name}** —Ä–µ—à–µ–Ω.`, false);
        } else {
            const penaltyType = crisis.solution.task.penalty.type.toUpperCase();
            const penaltyValue = crisis.solution.task.penalty.value;
            gameData.resources[penaltyType] -= penaltyValue;
            gameData.taskCompleted = true; // –§–ª–∞–≥, —á—Ç–æ –∫—Ä–∏–∑–∏—Å —Ä–∞–∑—Ä–µ—à–µ–Ω/–ø–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞–Ω–∞

            logEvent(`‚ùå –ü–†–û–í–ê–õ: –†—É—á–Ω–æ–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è ${crisis.name} –Ω–µ —É–¥–∞–ª—Å—è. –®—Ç—Ä–∞—Ñ: **-${penaltyValue} ${penaltyType}**!`, true);
        }

        updateResourceDisplay();
        document.getElementById('end-round-button').disabled = false; // –ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –º–æ–∂–Ω–æ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ
        renderRound5Actions();
    }

    function resolveCrisisResource(groupCode) {
        const crisis = CRISIS_DATABASE[groupCode];
        const resourceCode = crisis.solution.resource;
        
        if ((gameData.inventory[resourceCode] || 0) > 0) {
            gameData.inventory[resourceCode] -= 1; 
            resolveCrisis(groupCode, true);
        } else {
            logEvent('–û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è!', true);
        }
    }

    function resolveCrisisTask(groupCode) {
        const task = CRISIS_DATABASE[groupCode].solution.task;
        const input = document.getElementById('task-input-R5');
        const button = document.getElementById('task-button-R5');
        const answer = input.value.trim().toLowerCase().replace(/ /g, "");
        const expected = task.answer.toLowerCase().replace(/ /g, "");

        button.disabled = true;
        input.disabled = true;
        
        if (answer.includes(expected) || expected.includes(answer)) {
            resolveCrisis(groupCode, true);
        } else {
            resolveCrisis(groupCode, false);
        }
    }

// --- –†–ê–£–ù–î 6 –õ–û–ì–ò–ö–ê (–°–û–¢–†–£–î–ù–ò–ß–ï–°–¢–í–û) ---
    function initRound6() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –°–í–Ø–ó–ò –ò –°–ü–ê–°–ï–ù–ò–Ø`;
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–§–ò–ù–ê–õ)`;
        
        gameData.taskCompleted = gameData.r6Resolved; // –ò—Å–ø–æ–ª—å–∑—É–µ–º taskCompleted –∫–∞–∫ —Ñ–ª–∞–≥ –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–Ω–æ–ø–∫–∏

        document.getElementById('action-prompt').textContent = `–†–ê–£–ù–î 6: –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–¢–†–£–î–ù–ò–ß–ï–°–¢–í–û. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ—Å—É—Ä—Å—ã –£2 –æ—Ç –≤—Å–µ—Ö –≥—Ä—É–ø–ø –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¢—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä–∞.`;
        
        renderRound6Actions();
        logEvent('–°–ò–°–¢–ï–ú–ê: –ó–∞–ø—É—â–µ–Ω –†–∞—É–Ω–¥ 6. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–±—Ä–∞—Ç—å –£2 —Ä–µ—Å—É—Ä—Å—ã –∏–∑ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –¢—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä–∞!', true);
        updateResourceDisplay();
        document.getElementById('end-round-button').disabled = gameData.taskCompleted ? false : true;
    }

    function renderRound6Actions() {
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        
        const challenge = ROUND_6_CHALLENGE;
        let hasAllResources = true;
        let missingText = [];

        challenge.cost.forEach(item => {
            if ((gameData.inventory[item.code] || 0) < item.amount) {
                hasAllResources = false;
                missingText.push(`${item.amount - (gameData.inventory[item.code] || 0)} –µ–¥. ${RESOURCE_LOOKUP[item.code].name} (${item.code})`);
            }
        });
        
        actionsDiv.innerHTML = `
            <h2 style="color: #00ffff;">üì° ${challenge.name} (–ü–û–°–¢–†–û–ô–ö–ê)</h2>
            <p><strong>–¢–†–ï–ë–û–í–ê–ù–ò–Ø (–í—Å–µ –ì—Ä—É–ø–ø—ã, –£2):</strong></p>
            <ul style="list-style: none; padding-left: 0;">
                ${challenge.cost.map(item => `
                    <li style="color: ${gameData.inventory[item.code] >= item.amount ? '#2ecc71' : '#e74c3c'};">
                        **${item.amount} –µ–¥.** ${RESOURCE_LOOKUP[item.code].name} (${item.code}) [–ï—Å—Ç—å: ${gameData.inventory[item.code] || 0}]
                    </li>
                `).join('')}
            </ul>

            <hr style="border-top: 1px dashed #5dade2; margin: 20px 0;">

            ${!gameData.r6Resolved ? (hasAllResources ? `
                <button class="round-action-button-main" onclick="resolveRound6Resource()" style="background: #2ecc71; margin-bottom: 10px;">
                    –ü–û–°–¢–†–û–ò–¢–¨ –¢–†–ê–ù–°–ü–û–ù–î–ï–† (–ü–æ—Ç—Ä–∞—Ç–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã)
                </button>
            ` : 
                `<button class="round-action-button-main" disabled style="background: #e74c3c; opacity: 0.7; margin-bottom: 10px;">
                    –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –†–ï–°–£–†–°–û–í! –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: ${missingText.join('; ')}
                </button>`
            ) : `<button class="round-action-button-main" disabled style="background: #27ae60; margin-bottom: 10px;">–¢–†–ê–ù–°–ü–û–ù–î–ï–† –£–ñ–ï –ü–û–°–¢–†–û–ï–ù –ò –ê–ö–¢–ò–í–ò–†–û–í–ê–ù</button>`}
            
            <hr style="border-top: 1px dashed #e74c3c; margin: 20px 0;">

            <div style="border: 1px solid #f1c40f; padding: 10px;">
                <h3 style="color: #f1c40f;">–†–£–ß–ù–û–ô –ü–†–û–¢–û–ö–û–õ (–ê–≤–∞—Ä–∏–π–Ω—ã–π –†–∞—Å—á–µ—Ç): ${challenge.task.question}</h3>
                <input type="text" id="task-input-R6" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç (1-2 —Å–ª–æ–≤–∞)" style="width: 300px; padding: 8px; margin-right: 10px;" ${gameData.taskCompleted ? 'disabled' : ''}>
                <button id="task-button-R6" onclick="resolveRound6Task()" style="background: #f1c40f; color: #121212; width: auto;" ${gameData.taskCompleted ? 'disabled' : ''}>
                    –í—ã–ø–æ–ª–Ω–∏—Ç—å –ê–≤–∞—Ä–∏–π–Ω—ã–π –†–∞—Å—á–µ—Ç
                </button>
                <p style="font-size: 0.9em;">‚Äî –ù–∞–≥—Ä–∞–¥–∞: –£—Å–ø–µ—Ö –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö (**–¢—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º**). <span class="error">–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–≤–∞–ª: **-${challenge.task.penalty.value} ${challenge.task.penalty.type.toUpperCase()}**</span>.</p>
            </div>
        `;
        document.getElementById('end-round-button').disabled = gameData.taskCompleted ? false : true;
    }

    function resolveRound6Resource() {
        if (gameData.r6Resolved) return;
        const challenge = ROUND_6_CHALLENGE;
        
        challenge.cost.forEach(item => {
            gameData.inventory[item.code] -= item.amount;
        });

        gameData.r6Resolved = true; 
        gameData.taskCompleted = true;
        logEvent(`‚úÖ –°–ò–ì–ù–ê–õ –£–°–ü–ï–•–ê: –°–≤–µ—Ä—Ö–¥–∞–ª—å–Ω–∏–π –¢—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä –ø–æ—Å—Ç—Ä–æ–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω!`, false);
        
        gameData.resources.HEALTH += 10; 
        logEvent(`–ë–û–ù–£–°: –≠–∫–∏–ø–∞–∂ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. +10 –ó–¥–æ—Ä–æ–≤—å—è.`, false);
        
        updateResourceDisplay();
        renderRound6Actions(); 
    }

    function resolveRound6Task() {
        if (gameData.taskCompleted) return;

        const task = ROUND_6_CHALLENGE.task;
        const input = document.getElementById('task-input-R6');
        const button = document.getElementById('task-button-R6');
        const answer = input.value.trim().toLowerCase().replace(/ /g, "");
        const expected = task.answer.toLowerCase().replace(/ /g, "");

        button.disabled = true;
        input.disabled = true;
        gameData.taskCompleted = true; // –ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞–Ω–∞
        
        if (answer.includes(expected) || expected.includes(answer)) {
            gameData.r6Resolved = true; // –°—á–∏—Ç–∞–µ—Ç—Å—è, —á—Ç–æ —Å–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
            logEvent(`‚úÖ –°–ò–ì–ù–ê–õ –£–°–ü–ï–•–ê: –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! –°–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.`, false);
        } else {
            const penaltyType = task.penalty.type.toUpperCase();
            const penaltyValue = task.penalty.value;
            gameData.resources[penaltyType] -= penaltyValue;
            
            logEvent(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ: –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–∞—Å—á–µ—Ç –Ω–µ —É–¥–∞–ª—Å—è. –®—Ç—Ä–∞—Ñ: **-${penaltyValue} ${penaltyType}**!`, true);
        }
        
        updateResourceDisplay();
        renderRound6Actions();
    }

// --- –†–ê–£–ù–î 7 –õ–û–ì–ò–ö–ê (–§–ò–ù–ê–õ) ---

    function initRound7() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(–ó–ê–í–ï–†–®–ï–ù–ò–ï)`;
        document.getElementById('action-header-text').textContent = `1. –§–ò–ù–ê–õ–¨–ù–´–ô –ü–†–û–¢–û–ö–û–õ`;
        document.getElementById('end-round-button').textContent = '–ó–ê–í–ï–†–®–ò–¢–¨ –ú–ò–°–°–ò–Æ';
        document.getElementById('end-round-button').disabled = true; 

        document.getElementById('action-buttons').innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
        const actionsDiv = document.getElementById('action-buttons');

        if (gameData.r6Resolved) {
            document.getElementById('action-prompt').textContent = '–†–ê–£–ù–î 7: –§–ò–ù–ê–õ–¨–ù–´–ô –≠–¢–ê–ü. –°–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –°–ø–∞—Å–∞—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç –ø—Ä–∏–±—ã–≤–∞–µ—Ç. –ù–∞—á–Ω–∏—Ç–µ —ç–≤–∞–∫—É–∞—Ü–∏—é.';
            
            const requiredPower = 10;
            const requiredAir = 5;
            const canEvacuate = gameData.resources.POWER >= requiredPower && gameData.resources.AIR >= requiredAir;
            
            actionsDiv.innerHTML = `
                <h2 style="color: #00b894;">üöÄ –§–ò–ù–ê–õ–¨–ù–´–ô –ü–†–û–¢–û–ö–û–õ: –≠–í–ê–ö–£–ê–¶–ò–Ø</h2>
                <p style="font-weight: bold;">–°–ø–∞—Å–∞—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç –Ω–∞ –æ—Ä–±–∏—Ç–µ. –¢—Ä–µ–±—É–µ—Ç—Å—è:</p>
                <ul>
                    <li style="color: ${gameData.resources.POWER >= requiredPower ? '#2ecc71' : '#e74c3c'}">
                        **10 –µ–¥. –≠–Ω–µ—Ä–≥–∏–∏** (–ï—Å—Ç—å: ${gameData.resources.POWER})
                    </li>
                    <li style="color: ${gameData.resources.AIR >= requiredAir ? '#2ecc71' : '#e74c3c'}">
                        **5 –µ–¥. –í–æ–∑–¥—É—Ö–∞** (–ï—Å—Ç—å: ${gameData.resources.AIR})
                    </li>
                </ul>
                
                <button class="round-action-button-main" onclick="finalEvacuate()" style="background: ${canEvacuate ? '#00b894' : '#7f8c8d'}; font-size: 1.2em; margin-top: 15px;" ${canEvacuate ? '' : 'disabled'}>
                    ${canEvacuate ? '–ù–ê–ß–ê–¢–¨ –≠–í–ê–ö–£–ê–¶–ò–Æ' : '–ù–ï–¢ –†–ï–°–£–†–°–û–í –î–õ–Ø –ó–ê–ü–£–°–ö–ê –ß–ï–õ–ù–û–ö–ê'}
                </button>
            `;
        } else {
             document.getElementById('action-prompt').textContent = '–†–ê–£–ù–î 7: –§–ò–ù–ê–õ–¨–ù–´–ô –≠–¢–ê–ü. –°–∏–≥–Ω–∞–ª —Å–ø–∞—Å–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –í—Ä–µ–º—è –Ω–∞ –ú–∞—Ä—Å–µ –∏—Å—Ç–µ–∫–∞–µ—Ç...';
             actionsDiv.innerHTML = `
                <p class="error" style="font-size: 1.2em;">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –°–∏–≥–Ω–∞–ª –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ú–∏—Å—Å–∏—è –ø—Ä–æ–≤–∞–ª–µ–Ω–∞.</p>
             `;
             document.getElementById('game-over-message').textContent = '–ú–ò–°–°–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê. –°–ò–ì–ù–ê–õ –°–ü–ê–°–ï–ù–ò–Ø –ù–ï –û–¢–ü–†–ê–í–õ–ï–ù.';
             document.getElementById('game-over-message').style.display = 'block';
        }
        logEvent('–°–ò–°–¢–ï–ú–ê: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –†–∞—É–Ω–¥ 7. –§–ò–ù–ê–õ–¨–ù–ê–Ø –§–ê–ó–ê.', true);
    }

    function finalEvacuate() {
        const requiredPower = 10;
        const requiredAir = 5;

        if (gameData.resources.POWER >= requiredPower && gameData.resources.AIR >= requiredAir) {
            gameData.resources.POWER -= requiredPower;
            gameData.resources.AIR -= requiredAir;
            
            logEvent('‚úÖ –≠–í–ê–ö–£–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê: –®–∞—Ç—Ç–ª –∑–∞–ø—É—â–µ–Ω. –≠–∫–∏–ø–∞–∂ –Ω–∞ –ø—É—Ç–∏ –¥–æ–º–æ–π! **–ú–ò–°–°–ò–Ø –í–´–ü–û–õ–ù–ï–ù–ê**.', false);
            
            document.getElementById('game-over-message').textContent = '–ú–ò–°–°–ò–Ø –í–´–ü–û–õ–ù–ï–ù–ê. –≠–ö–ò–ü–ê–ñ –°–ü–ê–°–ï–ù.';
            document.getElementById('game-over-message').style.display = 'block';
            document.getElementById('action-buttons').innerHTML = '';

        } else {
            logEvent(`‚ùå –û–¢–ú–ï–ù–ê –≠–í–ê–ö–£–ê–¶–ò–ò: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —á–µ–ª–Ω–æ–∫–∞.`, true);
            
            document.getElementById('game-over-message').textContent = '–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ö–ê–ó. –≠–í–ê–ö–£–ê–¶–ò–Ø –ù–ï–í–û–ó–ú–û–ñ–ù–ê. –ú–ò–°–°–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê.';
            document.getElementById('game-over-message').style.display = 'block';
            document.getElementById('action-buttons').innerHTML = '';
        }
        document.getElementById('end-round-button').disabled = true;
        updateResourceDisplay();
    }


// --- –ì–õ–û–ë–ê–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï ---
    
    function checkGameOver() {
        if (gameData.resources.WATER <= 0 || gameData.resources.AIR <= 0 || gameData.resources.HEALTH <= 0) {
            document.getElementById('game-over-message').textContent = '–ú–ò–°–°–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ö–ê–ó –°–ò–°–¢–ï–ú –ñ–ò–ó–ù–ï–û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø.';
            document.getElementById('game-over-message').style.display = 'block';
            document.getElementById('end-round-button').disabled = true;
            logEvent('–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ö–ê–ó: –†–µ—Å—É—Ä—Å—ã –∂–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏—Å—á–µ—Ä–ø–∞–Ω—ã. –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.', true);
            return true;
        }
        return false;
    }

    function applyResourceChanges() {
        let waterConsumption = 5;
        let airConsumption = 5;
        let healthBonus = 0;
        let powerBonus = 0;
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ –æ—Ç –£3 —Å–∏—Å—Ç–µ–º
        for (const code in gameData.inventory) {
            if (gameData.inventory[code] > 0) {
                const res = RESOURCE_LOOKUP[code];
                if (res && res.level === 3 && res.bonus) {
                    const count = gameData.inventory[code];
                    
                    if (res.bonus.type === 'POWER_BONUS') {
                        powerBonus += res.bonus.value * count;
                    }
                    if (res.bonus.type === 'HEALTH_BONUS') {
                        healthBonus += res.bonus.value * count;
                    }
                    if (res.bonus.type === 'WATER_REDUCTION') {
                        waterConsumption -= res.bonus.value * count;
                    }
                    if (res.bonus.type === 'AIR_REDUCTION') {
                        airConsumption -= res.bonus.value * count;
                    }
                }
            }
        }
        
        waterConsumption = Math.max(0, waterConsumption);
        airConsumption = Math.max(0, airConsumption);

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        gameData.resources.WATER -= waterConsumption;
        gameData.resources.AIR -= airConsumption;
        gameData.resources.POWER += powerBonus;
        gameData.resources.HEALTH += healthBonus;

        // –®—Ç—Ä–∞—Ñ –æ—Ç –Ω–µ—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –∫—Ä–∏–∑–∏—Å–∞ –†5 (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –†6)
        if (gameData.round === 6) { 
             const crisis = CRISIS_DATABASE[gameData.primaryGroup];
             if (!crisis.resolved) {
                 if (crisis.name === "–≠–ù–ï–†–ì–ï–¢–ò–ß–ï–°–ö–ò–ô –®–¢–û–†–ú") {
                     gameData.resources.POWER -= 10;
                     logEvent('–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –®–¢–†–ê–§: -10 –≠–Ω–µ—Ä–≥–∏–∏ –∏–∑-–∑–∞ –Ω–µ—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –®—Ç–æ—Ä–º–∞.', true);
                 } else if (crisis.name === "–ë–ò–û–õ–û–ì–ò–ß–ï–°–ö–ê–Ø –£–ì–†–û–ó–ê") {
                     gameData.resources.WATER -= 5;
                     gameData.resources.HEALTH -= 5;
                     logEvent('–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –®–¢–†–ê–§: -5 –í –∏ -5 –ó–≠ –∏–∑-–∑–∞ –Ω–µ—Ä–µ—à–µ–Ω–Ω–æ–π –ë–∏–æ—É–≥—Ä–æ–∑—ã.', true);
                 } else if (crisis.name === "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–û–ò–ù–ê") {
                     gameData.resources.AIR -= 5;
                     gameData.resources.HEALTH -= 5;
                     logEvent('–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –®–¢–†–ê–§: -5 –í–ó –∏ -5 –ó–≠ –∏–∑-–∑–∞ –Ω–µ—Ä–µ—à–µ–Ω–Ω–æ–π –ü—Ä–æ–±–æ–∏–Ω—ã.', true);
                 }
                 logEvent(`‚ö†Ô∏è –û–°–¢–ê–í–®–ï–ï–°–Ø –ü–û–í–†–ï–ñ–î–ï–ù–ò–ï: –ö—Ä–∏–∑–∏—Å "${crisis.name}" –Ω–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω. –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è!`, true);
             }
        }

        logEvent(`–†–ê–°–•–û–î: -${waterConsumption} –í, -${airConsumption} –í–ó. –ë–û–ù–£–°–´: +${powerBonus} –≠, +${healthBonus} –ó–≠.`, false);
    }


    function nextRound() {
        if (gameData.round > 0) {
            applyResourceChanges();
        }
        
        if (checkGameOver()) return;

        gameData.round++;
        logEvent(`--- –£–°–ü–ï–®–ù–´–ô –ü–ï–†–ï–•–û–î –ö –†–ê–£–ù–î–£ ${gameData.round}! ---`, false);
        
        gameData.taskCompleted = false; // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
        
        if (gameData.round === 1) {
            initRound1();
        } else if (gameData.round === 2) {
            initRound2();
        } else if (gameData.round === 3) {
            initRound3();
        } else if (gameData.round === 4) {
            initRound4();
        } else if (gameData.round === 5) {
            initRound5();
        } else if (gameData.round === 6) {
            initRound6();
        } else if (gameData.round === 7) {
            initRound7();
        } else {
            logEvent('–û–®–ò–ë–ö–ê: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ä–∞—É–Ω–¥–∞.', true);
        }
        
        updateResourceDisplay(); 
    }
    
    function initGame() {
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–∞—Ç—ã
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('current-date').textContent = dateStr;
            document.getElementById('current-time').textContent = timeStr;
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã: –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã
        document.getElementById('main-game-interface').style.display = 'none';
        document.getElementById('pre-game-selector').style.display = 'block';
        logEvent('–°–ò–°–¢–ï–ú–ê: –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–∏—Å—Å–∏–∏. –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é.', true);
        
        // –ù–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏—Å–ø–ª–µ–µ–≤
        updateResourceDisplay();
    }

    window.onload = initGame;
</script>
</body>
</html>
