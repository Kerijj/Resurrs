<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Экспедиция Арес 7: Марсианский Кодекс</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Марсианский Стиль */
        body { 
            font-family: 'Orbitron', sans-serif;
            background: #2c0b0b;
            color: #d1b4a6;
            padding: 20px; 
            line-height: 1.5;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%232c0b0b"/><circle cx="50" cy="50" r="10" fill="%236e3c3c" opacity="0.3"/></svg>');
        }
        .container { 
            max-width: 950px; 
            margin: 0 auto; 
            padding: 30px; 
            background: rgba(44, 11, 11, 0.9); 
            border: 3px solid #e74c3c; 
            border-radius: 15px; 
            box-shadow: 0 0 25px #c0392b; 
        }
        
        /* Заголовки */
        h1 { color: #f1c40f; text-align: center; text-shadow: 0 0 5px #f1c40f; }
        h2 { color: #3498db; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; margin-top: 25px; }
        h3 { color: #2ecc71; margin-top: 15px; }
        
        /* Основные блоки */
        .intro, .round-content, .status-panel { 
            margin-bottom: 20px; 
            padding: 18px; 
            border: 1px solid #c0392b; 
            border-radius: 10px; 
            background: rgba(18, 5, 5, 0.7); 
        }

        /* Панель Статуса */
        .status-panel { display: flex; justify-content: space-between; align-items: flex-start; }
        .info-block { flex: 1; margin-right: 20px; }
        
        /* Дисплей ресурсов */
        .inventory-list { 
            list-style-type: none; 
            padding: 0; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px;
            max-width: 60%;
        }
        .inventory-item { 
            padding: 8px 15px; 
            border-radius: 6px; 
            background: #e74c3c; 
            color: #2c0b0b; 
            font-weight: bold; 
            font-size: 0.95em;
            box-shadow: 0 0 8px #c0392b;
        }

        /* Журнал */
        .log-box { 
            margin-top: 20px; 
            background: #180505; 
            padding: 15px; 
            height: 120px; 
            overflow-y: scroll; 
            border-radius: 8px; 
            font-size: 0.8em; 
            border: 1px solid #c0392b;
        }
        .log-box p { margin: 3px 0; }
        
        /* Кнопки */
        button { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 8px; 
            font-weight: bold; 
            background: #3498db; 
            color: #d1b4a6; 
            transition: background 0.3s, transform 0.1s; 
            box-shadow: 0 4px #2980b9; 
        }
        button:hover:not(:disabled) { background: #2980b9; transform: translateY(1px); box-shadow: 0 3px #2980b9; }
        button:disabled { background: #604040; cursor: not-allowed; opacity: 0.7; box-shadow: none;}
        
        .group-select button { width: 30%; }

        /* Таблица закупок */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #180505; }
        th, td { border: 1px solid #c0392b; padding: 10px; text-align: left; }
        th { background: #6e3c3c; color: #f1c40f; }

        /* Панель Ведущего */
        .mod-panel { 
            margin-top: 25px; 
            padding: 15px; 
            background: rgba(44, 11, 11, 0.9);
            border-radius: 8px; 
            border: 1px solid #3498db;
        }
        #mod-input { 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid #7f8c8d; 
            margin-right: 10px; 
            background: #2c0b0b; 
            color: #d1b4a6; 
            width: 300px;
        }
        .final-message { 
            padding: 20px; 
            background: #2ecc71; 
            color: #2c0b0b; 
            border-radius: 10px; 
            font-size: 1.3em; 
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>👽 Экспедиция Арес 7: Марсианский Кодекс</h1>
        <div id="game-area">
            
            <div class="intro" id="intro-screen">
                <h2>Протокол: Инициализация</h2>
                <p>Ваш орбитальный модуль разбился. Вы - последние, кто может отправить сигнал спасения. Марс суров. Выберите специализацию группы для начала миссии и получите **100 кредитов** на закупку оборудования.</p>
                
                <div class="group-select">
                    <button onclick="startGame('Technocrats')">🛠️ Технократы</button>
                    <button onclick="startGame('Bioengineers')">🧪 Биоинженеры</button>
                    <button onclick="startGame('Constructors')">🧱 Конструкторы</button>
                </div>
            </div>

            <div id="game-round" style="display:none;">
                <h2 id="round-title"></h2>
                
                <div class="status-panel">
                    <div class="info-block">
                        <h3>Группа: <span id="player-group-name"></span></h3>
                        <p>Жизнеобеспечение (HP): <span id="res-hp" style="color: #e74c3c; font-weight: bold;"></span></p>
                        <p>Кредиты (КР): <span id="res-credits" style="color: #f1c40f; font-weight: bold;"></span></p>
                        <p>Действий осталось: <span id="actions-remaining" style="color: #3498db; font-weight: bold;"></span> / 3</p>
                    </div>
                    <div>
                        <h3>Инвентарь:</h3>
                        <ul class="inventory-list" id="inventory-list-display"></ul>
                    </div>
                </div>

                <div class="round-content" id="round-description"></div>

                <div class="action-area" id="action-area"></div>
                
                <div class="log-box">
                    **Журнал Бортовой Системы**
                    <div id="game-log"></div>
                </div>

                <div class="mod-panel">
                    <h4>📡 Протокол Связи (Ведущий)</h4>
                    <p>Для крафта: **КРАФТ M/W/K** (промежуточный) или **СБОР** (финальный) в Раунде 7.</p>
                    <p>Для обмена/модификации (по запросу): **ОТДАТЬ/ПОЛУЧИТЬ [код] [кол-во]**</p>
                    <input type="text" id="mod-input" placeholder="Введите команду Ведущего (КРАФТ, ОТДАТЬ/ПОЛУЧИТЬ, СБОР)">
                    <button onclick="processModCommand()">Ввод Команды</button>
                    <button onclick="checkNextRound()" style="background: #e74c3c;">Завершить Цикл (Списание HP)</button>
                </div>
            </div>
            
            <div id="game-over" style="display:none; text-align: center;">
                 <h2 style="color: #e74c3c;">🔴 СИГНАЛ ПОТЕРЯН</h2>
                 <p id="game-over-message" style="font-size: 1.2em;"></p>
            </div>
        </div>
    </div>

    <script>
        // --- ДАННЫЕ ИГРЫ (Коды оставлены для работы логики JS) ---
        const RESOURCES = {
            // Базовые ресурсы (5 шт)
            E: { name: 'Энергоячейка', code: 'E', icon: '⚡', cost: 10 },
            B: { name: 'Биомасса', code: 'B', icon: '🌱', cost: 10 },
            S: { name: 'Композитный Сплав', code: 'S', icon: '🔩', cost: 10 },
            L: { name: 'Гидро-Реагент', code: 'L', icon: '💧', cost: 15 },
            F: { name: 'Изоволокно', code: 'F', icon: '🧶', cost: 15 },
            
            // Промежуточные/Контрактные ресурсы (4 шт)
            M: { name: 'Крио-Модуль', code: 'M', icon: '❄️', cost: 30 },
            W: { name: 'Синтезатор Воды', code: 'W', icon: '🌊', cost: 30 },
            K: { name: 'Гермо-Контейнер', code: 'K', icon: '📦', cost: 30 },
            Z: { name: 'Оптический Кабель', code: 'Z', icon: '🔗', cost: 30 }, 
            
            // Финальный ресурс
            P: { name: 'Маяк Спасения', code: 'P', icon: '🛰️', cost: 0 },
            
            // Статус
            HP: { name: 'Жизнеобеспечение', code: 'HP', icon: '❤️', cost: 0 },
            CR: { name: 'Кредиты', code: 'CR', icon: '💰', cost: 0 }
        };
        
        const GROUP_NAMES = {
            Technocrats: '🛠️ Технократы', 
            Bioengineers: '🧪 Биоинженеры', 
            Constructors: '🧱 Конструкторы'
        };

        const ROUND_TITLES = [
            "Инициализация Миссии",
            "Раунд 1: Закупка Оборудования (Протокол)",
            "Раунд 2: Плановое Исследование",
            "Раунд 3: Аварийный Сигнал",
            "Раунд 4: Марсианский Феномен",
            "Раунд 5: Угроза Песчаной Бури",
            "Раунд 6: Контракт и Доставка",
            "Раунд 7: Финальная Сборка"
        ];
        
        const CRAFT_COSTS = {
            M: { E: 3, B: 2 }, // Крио-Модуль: Энергия + Биомасса
            W: { B: 3, S: 2 }, // Синтезатор Воды: Биомасса + Сплав
            K: { S: 3, L: 2 }, // Гермо-Контейнер: Сплав + Реагент
            P: { M: 1, W: 1, K: 1, Z: 1 } // Маяк: M+W+K+Z (Финальная сборка)
        };

        let gameState = {
            group: null,
            inventory: { 
                E: 0, B: 0, S: 0, L: 0, F: 0, 
                M: 0, W: 0, K: 0, Z: 0, P: 0, 
                HP: 15, CR: 100 
            }, 
            currentRound: 0,
            actionsTaken: 0,
            maxActions: 3,
            historyLog: [] // Для финального статуса
        };

        // --- УПРАВЛЕНИЕ ИГРОЙ ---

        function updateLog(message, isError = false) {
            const logBox = document.getElementById('game-log');
            const prefix = isError ? '🛑' : '💬';
            logBox.innerHTML += `<p>${prefix} ${message}</p>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function takeAction() {
            if (gameState.actionsTaken >= gameState.maxActions) {
                updateLog("🛑 Максимальное количество действий (3) в этом цикле достигнуто.", true);
                return false;
            }
            gameState.actionsTaken++;
            document.getElementById('actions-remaining').textContent = gameState.maxActions - gameState.actionsTaken;
            return true;
        }

        function checkNextRound() {
            if (gameState.currentRound === 1) { // Проверка на Раунд 1 (закупка)
                // Не обязываем тратить все, но даем предупреждение
                if (gameState.inventory.CR > 0) {
                     updateLog("⚠️ Вы завершаете цикл закупки с оставшимися Кредитами. Вы уверены, что хотите пропустить возможность закупиться?", true);
                }
            } else if (gameState.currentRound !== 7 && gameState.actionsTaken < gameState.maxActions) {
                updateLog("🛑 Вы еще не использовали все 3 действия этого цикла.", true);
                return;
            }
            
            if (gameState.currentRound === 7) return; 

            // Списание HP 
            const hpLoss = 3; 
            gameState.inventory.HP -= hpLoss;
            updateLog(`--- ЕЖЕДНЕВНЫЙ РАСХОД ---`);
            updateLog(`💔 Жизнеобеспечение -${hpLoss} HP. Текущий HP: ${gameState.inventory.HP}`);

            if (gameState.inventory.HP <= 0) {
                gameOver("Критический сбой жизнеобеспечения. Миссия Арес 7 завершена провалом.");
                return;
            }
            
            // Переход к следующему раунду
            gameState.currentRound++;
            gameState.actionsTaken = 0; // Сброс действий
            updateLog(`=== Переход в ${ROUND_TITLES[gameState.currentRound]} ===`);
            loadRound(gameState.currentRound);
            updateUI();
        }

        function gameOver(message) {
            document.getElementById('game-round').style.display = 'none';
            document.getElementById('game-over').style.display = 'block';
            document.getElementById('game-over-message').textContent = message;
        }

        // --- UI И ИНИЦИАЛИЗАЦИЯ ---

        function updateUI() {
            document.getElementById('player-group-name').textContent = GROUP_NAMES[gameState.group];
            document.getElementById('res-hp').textContent = gameState.inventory.HP;
            document.getElementById('res-credits').textContent = gameState.inventory.CR;
            document.getElementById('actions-remaining').textContent = gameState.maxActions - gameState.actionsTaken;
            
            // Список инвентаря
            const inventoryList = document.getElementById('inventory-list-display');
            let html = '';
            
            // Фильтруем и сортируем: Базовые, Промежуточные
            const orderedKeys = Object.keys(RESOURCES).filter(k => gameState.inventory[k] > 0 && k !== 'HP' && k !== 'CR' && k !== 'P').sort((a, b) => {
                const isBaseA = ['E', 'B', 'S', 'L', 'F'].includes(a);
                const isBaseB = ['E', 'B', 'S', 'L', 'F'].includes(b);
                if (isBaseA && !isBaseB) return -1;
                if (!isBaseA && isBaseB) return 1;
                return a.localeCompare(b);
            });
            
            orderedKeys.forEach(code => {
                const count = gameState.inventory[code];
                const res = RESOURCES[code];
                html += `<li class="inventory-item">${res.icon} ${res.name} (${count})</li>`;
            });
            
            // Добавляем Маяк Спасения, если собран
            if (gameState.inventory.P > 0) {
                html += `<li class="inventory-item" style="background: #2ecc71;">${RESOURCES.P.icon} ${RESOURCES.P.name} (Готов)</li>`;
            }
            
            inventoryList.innerHTML = html || '<li class="inventory-item" style="background: #c0392b;">Инвентарь пуст</li>';
        }

        function startGame(groupName) {
            gameState.group = groupName;
            gameState.currentRound = 1;

            // Начисление бонусного ресурса
            let bonusCode = '';
            if (groupName === 'Technocrats') { bonusCode = 'E'; }
            else if (groupName === 'Bioengineers') { bonusCode = 'B'; }
            else if (groupName === 'Constructors') { bonusCode = 'S'; }
            
            if (bonusCode) {
                gameState.inventory[bonusCode]++;
                updateLog(`Получен стартовый бонус: **1 ${RESOURCES[bonusCode].icon} ${RESOURCES[bonusCode].name}**.`);
            }

            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('game-round').style.display = 'block';
            
            updateLog(`Группа выбрана **${GROUP_NAMES[groupName]}**. Доступен Протокол Закупок (100 КР).`);
            updateUI();
            loadRound(1);
        }
        
        // --- РАУНД 1: ЗАКУПКА ---

        function buyResource(code) {
            const res = RESOURCES[code];
            if (gameState.currentRound !== 1) {
                updateLog("🛑 Закупка возможна только в Раунде 1.", true);
                return;
            }
            if (gameState.inventory.CR < res.cost) {
                updateLog(`🛑 Недостаточно кредитов. Требуется ${res.cost} КР для покупки ${res.name}.`, true);
                return;
            }
            
            gameState.inventory.CR -= res.cost;
            gameState.inventory[code]++;
            updateLog(`✅ Куплен 1 ${res.icon} ${res.name}. Остаток: ${gameState.inventory.CR} КР.`);
            loadRound(1); // Перезагружаем UI раунда для обновления кнопок заработка/покупки
            updateUI();
        }
        
        // НОВАЯ ФУНКЦИЯ: Заработок Кредитов
        function earnCredits(amount) {
            if (gameState.currentRound !== 1) {
                updateLog("🛑 Заработок кредитов возможен только в Раунде 1.", true);
                return;
            }
            if (gameState.inventory.CR >= 10) {
                updateLog("🛑 У вас достаточно Кредитов для покупки самого дешевого ресурса. Пожалуйста, совершите покупку, чтобы продолжить.", true);
                return;
            }
            
            const group = gameState.group;
            let taskName = "";

            if (group === 'Technocrats') {
                taskName = amount === 5 ? `Настройка энергосети` : `Ремонт резервного генератора`;
            } else if (group === 'Bioengineers') {
                taskName = amount === 5 ? `Сбор образцов почвы` : `Анализ биотехнологического сбоя`;
            } else if (group === 'Constructors') {
                taskName = amount === 5 ? `Дозаправка ровера` : `Устранение микротрещин в корпусе`;
            }
            
            gameState.inventory.CR += amount;
            updateLog(`✅ Выполнено задание "${taskName}". Получено **+${amount} Кредитов**. Текущий баланс: ${gameState.inventory.CR} КР.`);
            loadRound(1); // Reload UI
            updateUI();
        }

        // --- ЛОГИКА ВЕДУЩЕГО ---

        function processModCommand() {
            const input = document.getElementById('mod-input').value.trim().toLowerCase();
            const words = input.split(' ');
            document.getElementById('mod-input').value = '';

            // 1. КРАФТ [код]
            if (words[0] === 'крафт' && words.length === 2) {
                const resCode = words[1].toUpperCase();
                if (['M', 'W', 'K'].includes(resCode)) {
                    craftIntermediate(resCode);
                    return;
                }
            }
            
            // 2. СБОР (Финальная сборка маяка)
            if (words[0] === 'сбор' && gameState.currentRound === 7) {
                assembleBeacon();
                return;
            }

            // 3. ОТДАТЬ / ПОЛУЧИТЬ [код] [кол-во] (Модерирование обмена)
            if ((words[0] === 'отдать' || words[0] === 'получить') && words.length === 3) {
                const action = words[0];
                const resCode = words[1].toUpperCase();
                const amount = parseInt(words[2]);

                if (RESOURCES[resCode] && !isNaN(amount) && amount > 0 && resCode !== 'HP' && resCode !== 'CR' && resCode !== 'P') {
                    const resName = RESOURCES[resCode].icon + ' ' + RESOURCES[resCode].name;
                    if (action === 'отдать') {
                        if (gameState.inventory[resCode] >= amount) {
                            gameState.inventory[resCode] -= amount;
                            updateLog(`[ВЕДУЩИЙ] Группа отдала **-${amount} ${resName}**`);
                        } else {
                            updateLog(`🛑 Недостаточно ${resName} для отдачи.`, true);
                        }
                    } else if (action === 'получить') {
                        gameState.inventory[resCode] += amount;
                        updateLog(`[ВЕДУЩИЙ] Группа получила **+${amount} ${resName}**`);
                    }
                    updateUI();
                    return;
                }
            }
            
            if (input) updateLog("Неверный или недопустимый Протокол Связи. Используйте КРАФТ/ОТДАТЬ/ПОЛУЧИТЬ.", true);
        }

        // --- ЛОГИКА ДЕЙСТВИЙ (Крафт) ---

        function craftIntermediate(resCode) {
            const cost = CRAFT_COSTS[resCode];
            let canCraft = true;

            for (const res in cost) {
                if (gameState.inventory[res] < cost[res]) {
                    updateLog(`🛑 Крафт невозможен. Не хватает ${RESOURCES[res].icon} ${RESOURCES[res].name} (${cost[res]} шт.).`, true);
                    canCraft = false;
                    break;
                }
            }

            if (canCraft) {
                for (const res in cost) {
                    gameState.inventory[res] -= cost[res];
                }
                gameState.inventory[resCode]++;
                updateLog(`🎉 Крафт успешен! Создан **1 ${RESOURCES[resCode].icon} ${RESOURCES[resCode].name}**. (Свободный Протокол)`);
            }
            updateUI();
        }

        // --- ЛОГИКА ДЕЙСТВИЙ (Раунды 2-6) ---

        function applyRoundAction(actionCode) {
            if (gameState.currentRound === 1 || gameState.currentRound === 7) return;
            if (!takeAction()) return;
            
            let statusChange = 0;
            let message = "";
            let hpChange = 0;
            let resChange = {}; // Изменения ресурсов
            
            const group = gameState.group;

            // --- РАУНД 2: ПЛАНОВОЕ ИССЛЕДОВАНИЕ (СВОЕ ЗАДАНИЕ) ---
            if (gameState.currentRound === 2) { 
                if (group === 'Technocrats') {
                    // ТЕХНОКРАТЫ: Оптимизация Энергосистемы (Цель: E -> Z)
                    if (actionCode === 'Opt_E') { 
                        if (gameState.inventory.E >= 1) { gameState.inventory.E--; resChange.Z = 1; statusChange = 1; message = `Оптимизация Энергоячейки. Получен ${RESOURCES.Z.icon} ${RESOURCES.Z.name}. +1 Статус.`; }
                        else { hpChange = -1; message = "Сбой оптимизации: нет Энергоячейки. -1 HP."; }
                    } else if (actionCode === 'Rec_S') { // Случайный сбор
                        resChange.S = 2; message = `Анализ почвы. Получено ${RESOURCES.S.icon} ${RESOURCES.S.name} (+2 шт.).`;
                    }
                } else if (group === 'Bioengineers') {
                    // БИОИНЖЕНЕРЫ: Запуск Гидропоники (Цель: B -> L)
                    if (actionCode === 'Opt_B') { 
                        if (gameState.inventory.B >= 1) { gameState.inventory.B--; resChange.L = 1; statusChange = 1; message = `Оптимизация Биомассы. Получен ${RESOURCES.L.icon} ${RESOURCES.L.name}. +1 Статус.`; }
                        else { hpChange = -1; message = "Сбой гидропоники: нет Биомассы. -1 HP."; }
                    } else if (actionCode === 'Rec_F') { // Случайный сбор
                        resChange.F = 2; message = `Сбор редкой марсианской флоры. Получено ${RESOURCES.F.icon} ${RESOURCES.F.name} (+2 шт.).`;
                    }
                } else if (group === 'Constructors') {
                    // КОНСТРУКТОРЫ: Укрепление Базы (Цель: S -> F)
                    if (actionCode === 'Opt_S') { 
                        if (gameState.inventory.S >= 1) { gameState.inventory.S--; resChange.F = 1; statusChange = 1; message = `Укрепление конструкции. Получено ${RESOURCES.F.icon} ${RESOURCES.F.name}. +1 Статус.`; }
                        else { hpChange = -1; message = "Сбой укрепления: нет Сплава. -1 HP."; }
                    } else if (actionCode === 'Rec_E') { // Случайный сбор
                        resChange.E = 2; message = `Анализ солнечных панелей. Получено ${RESOURCES.E.icon} ${RESOURCES.E.name} (+2 шт.).`;
                    }
                }
            }
            // --- РАУНД 3: АВАРИЙНЫЙ СИГНАЛ (ПОТЕРЯ РЕСУРСОВ ИЛИ HP) ---
            else if (gameState.currentRound === 3) {
                 if (actionCode === 'L_Fix' && gameState.inventory.L >= 1) { 
                     gameState.inventory.L--; statusChange = 2; message = `Применен ${RESOURCES.L.icon} ${RESOURCES.L.name} (-1 шт.). Поломка устранена, +2 Статус.`; 
                 } else if (actionCode === 'M_Fix' && gameState.inventory.M >= 1) { 
                     gameState.inventory.M--; hpChange = 2; message = `Применен ${RESOURCES.M.icon} ${RESOURCES.M.name} (-1 шт.). Улучшена вентиляция, +2 HP.`; 
                 } else { 
                     hpChange = -2; statusChange = -1; message = "Нет нужного ресурса. Поломка вызывает утечку тепла. -2 HP, -1 Статус."; 
                 }
            }
            // --- РАУНД 4: МАРСИАНСКИЙ ФЕНОМЕН (ВЫБОР РИСКА) ---
            else if (gameState.currentRound === 4) {
                 if (actionCode === 'K_Invest' && gameState.inventory.K >= 1) { 
                     gameState.inventory.K--; resChange.L = 3; message = `Герметизация ${RESOURCES.K.name} (-1 шт.). Захвачено ${RESOURCES.L.icon} ${RESOURCES.L.name} (+3 шт.).`; 
                 } else if (actionCode === 'W_Invest' && gameState.inventory.W >= 1) { 
                     gameState.inventory.W--; statusChange = 2; message = `Анализ ${RESOURCES.W.name} (-1 шт.). Найдена схема маяка, +2 Статус.`; 
                 } else { 
                     hpChange = -3; message = "Попытка без нужного компонента. Серьезное облучение. -3 HP."; 
                 }
            }
            // --- РАУНД 5: УГРОЗА БУРИ (КРАФТ ИЛИ СБОР) ---
            else if (gameState.currentRound === 5) {
                 if (actionCode === 'Craft_M_W_K') {
                    // Крафт M, W, K — это свободное действие, которое не тратит лимит!
                    updateLog("💬 Используйте Протокол Связи: **КРАФТ M/W/K**");
                    gameState.actionsTaken--; // Отменяем трату действия
                    document.getElementById('actions-remaining').textContent = gameState.maxActions - gameState.actionsTaken;
                    return; 
                 } else if (actionCode === 'Gather_E_B_S') { 
                     resChange.E = 1; resChange.B = 1; resChange.S = 1; statusChange = 1; message = `Сборка ресурсов перед бурей. +1 ${RESOURCES.E.name}, +1 ${RESOURCES.B.name}, +1 ${RESOURCES.S.name}. +1 Статус.`; 
                 }
            }
            // --- РАУНД 6: КОНТРАКТ И ДОСТАВКА (ОБМЕН ИЛИ ФИНАЛЬНЫЙ РЫВОК) ---
            else if (gameState.currentRound === 6) {
                 if (actionCode === 'Trade') {
                    // Обмен с Ведущим — это свободное действие!
                    updateLog("💬 Используйте Протокол Связи для обмена: **ОТДАТЬ/ПОЛУЧИТЬ [код] [кол-во]**");
                    gameState.actionsTaken--; // Отменяем трату действия
                    document.getElementById('actions-remaining').textContent = gameState.maxActions - gameState.actionsTaken;
                    return; 
                 } else if (actionCode === 'Final_Dash') { 
                     if (gameState.inventory.E >= 2) { 
                         gameState.inventory.E -= 2; statusChange = 3; message = `Финальный рывок на полной мощности (-2 ${RESOURCES.E.name}). +3 Статус.`; 
                     } else { 
                         hpChange = -3; statusChange = -1; message = "Нет энергии для рывка. -3 HP, -1 Статус."; 
                     }
                 }
            }

            // Применение изменений
            gameState.inventory.HP += hpChange;
            if (statusChange !== 0) {
                 gameState.historyLog.push({ round: gameState.currentRound, statusChange: statusChange, details: `Действие ${actionCode}` });
            }
            for (const res in resChange) {
                gameState.inventory[res] = (gameState.inventory[res] || 0) + resChange[res];
            }
            
            if (message) updateLog(`✅ Действие завершено. ${message}`);

            if (gameState.inventory.HP <= 0) {
                 gameOver("Критический сбой жизнеобеспечения после последнего действия.");
                 return;
            }

            loadRound(gameState.currentRound); // Перезагрузка UI для обновления кнопок
            updateUI();
        }

        // --- ФИНАЛ ---
        function assembleBeacon() {
            if (gameState.currentRound !== 7) return;
            if (!takeAction()) return; 
            
            const required = CRAFT_COSTS.P;
            let canAssemble = true;
            let finalMessage = "";

            for (const res in required) {
                if (gameState.inventory[res] < required[res]) {
                    canAssemble = false;
                    finalMessage += `Не хватает ${RESOURCES[res].icon} ${RESOURCES[res].name} (${required[res]} шт.). `;
                }
            }

            if (canAssemble) {
                // Трата ресурсов
                gameState.inventory.M -= required.M;
                gameState.inventory.W -= required.W;
                gameState.inventory.K -= required.K;
                gameState.inventory.Z -= required.Z;
                gameState.inventory.P = 1;
                
                updateLog(`🎉 **Маяк Спасения Собран!** Начинается передача сигнала.`);
                
                const finalScore = calculateFinalScore();
                let resultText = "";

                if (finalScore >= 10) {
                    resultText = `👽 КРИТИЧЕСКИЙ УСПЕХ! Счет: **${finalScore}**. Сигнал принят мгновенно. Ваша команда спасена и признана героями!`;
                } else if (finalScore >= 5) {
                    resultText = `✅ УСПЕХ! Счет: **${finalScore}**. Сигнал принят с задержкой. Вы выжили, но потребуется время на восстановление базы.`;
                } else {
                    resultText = `⚠️ НИЗКИЙ УСПЕХ! Счет: **${finalScore}**. Сигнал очень слаб. Спасательная миссия отправлена, но ваше выживание под вопросом.`;
                }
                
                document.getElementById('action-area').innerHTML = `<div class="final-message">${resultText}</div>`;
                document.getElementById('round-title').textContent = "🛰️ ФИНАЛ МИССИИ";
            } else {
                updateLog(`🛑 Сборка Маяка провалена: ${finalMessage}`, true);
            }
            updateUI();
        }

        function calculateFinalScore() {
            const assemblyBonus = gameState.inventory.P > 0 ? 5 : 0; 
            const historyScore = gameState.historyLog.reduce((sum, log) => sum + log.statusChange, 0);
            return assemblyBonus + historyScore;
        }


        // --- ЗАГРУЗКА РАУНДОВ ---

        function getRoundDescription(round) {
            const group = gameState.group;
            
            switch(round) {
                case 1: 
                    let tableHtml = `
                        <h3>Протокол: Закупка Оборудования</h3>
                        <p>Вам выделено **100 КР**. Вы можете закупить любые необходимые компоненты. Это единственный этап закупки.</p>
                        <table>
                            <tr><th>Ресурс</th><th>Иконка</th><th>Цена (КР)</th><th>В наличии</th><th>Действие</th></tr>
                            <tr><td>${RESOURCES.E.name}</td><td>${RESOURCES.E.icon}</td><td>${RESOURCES.E.cost}</td><td>${gameState.inventory.E}</td><td><button onclick="buyResource('E')" ${gameState.inventory.CR < RESOURCES.E.cost ? 'disabled' : ''}>Купить</button></td></tr>
                            <tr><td>${RESOURCES.B.name}</td><td>${RESOURCES.B.icon}</td><td>${RESOURCES.B.cost}</td><td>${gameState.inventory.B}</td><td><button onclick="buyResource('B')" ${gameState.inventory.CR < RESOURCES.B.cost ? 'disabled' : ''}>Купить</button></td></tr>
                            <tr><td>${RESOURCES.S.name}</td><td>${RESOURCES.S.icon}</td><td>${RESOURCES.S.cost}</td><td>${gameState.inventory.S}</td><td><button onclick="buyResource('S')" ${gameState.inventory.CR < RESOURCES.S.cost ? 'disabled' : ''}>Купить</button></td></tr>
                            <tr><td>${RESOURCES.L.name}</td><td>${RESOURCES.L.icon}</td><td>${RESOURCES.L.cost}</td><td>${gameState.inventory.L}</td><td><button onclick="buyResource('L')" ${gameState.inventory.CR < RESOURCES.L.cost ? 'disabled' : ''}>Купить</button></td></tr>
                            <tr><td>${RESOURCES.F.name}</td><td>${RESOURCES.F.icon}</td><td>${RESOURCES.F.cost}</td><td>${gameState.inventory.F}</td><td><button onclick="buyResource('F')" ${gameState.inventory.CR < RESOURCES.F.cost ? 'disabled' : ''}>Купить</button></td></tr>
                        </table>
                    `;
                    
                    let earnHtml = '';
                    // Новая логика для заработка (активна, если Кредитов меньше 10)
                    if (gameState.inventory.CR < 10) { 
                        let taskName = '';
                        if (group === 'Technocrats') { taskName = 'Техническое задание'; }
                        else if (group === 'Bioengineers') { taskName = 'Био-исследовательское задание'; }
                        else if (group === 'Constructors') { taskName = 'Инфраструктурное задание'; }
                        
                        earnHtml = `
                            <h3 style="color: #3498db;">Подработка (${taskName})</h3>
                            <p>Выполните микрозадачу, связанную с вашей специализацией, чтобы заработать недостающие средства.</p>
                            <button onclick="earnCredits(5)">Выполнить краткое задание (+5 КР)</button>
                            <button onclick="earnCredits(10)">Выполнить обширное задание (+10 КР)</button>
                        `;
                    }
                    
                    return tableHtml + earnHtml + `<p style="margin-top: 15px; color: #f1c40f;">Осталось КР: ${gameState.inventory.CR}</p>`;

                case 2: 
                    let desc2 = "<h3>Марсианская Поверхность: Плановое Исследование</h3><p>Начальный этап сбора данных. У вас есть 3 действия. Выберите специализацию или проведите обычный сбор.</p>";
                    if (group === 'Technocrats') { desc2 += `<p>**🛠️ ТЕХНОКРАТЫ:** Оптимизация Энергосистемы (требует ${RESOURCES.E.icon} ${RESOURCES.E.name}) дает ${RESOURCES.Z.icon} ${RESOURCES.Z.name}, необходимый для финальной сборки.</p>`; }
                    else if (group === 'Bioengineers') { desc2 += `<p>**🧪 БИОИНЖЕНЕРЫ:** Запуск Гидропоники (требует ${RESOURCES.B.icon} ${RESOURCES.B.name}) дает ${RESOURCES.L.icon} ${RESOURCES.L.name} для жизненных систем.</p>`; }
                    else if (group === 'Constructors') { desc2 += `<p>**🧱 КОНСТРУКТОРЫ:** Укрепление Базы (требует ${RESOURCES.S.icon} ${RESOURCES.S.name}) дает ${RESOURCES.F.icon} ${RESOURCES.F.name} для изоляции.</p>`; }
                    return desc2;
                case 3: return "<h3>Протокол: Аварийный Сигнал</h3><p>Обнаружена критическая поломка в модуле жизнеобеспечения. Срочно примените ресурс для устранения утечки тепла, иначе понесете урон.</p>";
                case 4: return "<h3>Протокол: Марсианский Феномен</h3><p>Обнаружен неизвестный артефакт. Вам нужно использовать один из сложных компонентов для его захвата или анализа. Это рискованно!</p>";
                case 5: return "<h3>Протокол: Угроза Бури (Крафт)</h3><p>Надвигается мощная песчаная буря. Крафт модулей (${RESOURCES.M.icon} ${RESOURCES.M.name}, ${RESOURCES.W.icon} ${RESOURCES.W.name}, ${RESOURCES.K.icon} ${RESOURCES.K.name}) — это теперь приоритетное действие, чтобы успеть укрепить базу. Крафт **не тратит** лимит хода!</p><p>Для крафта: введите **КРАФТ [M/W/K]** в Протокол Связи.</p>";
                case 6: return "<h3>Протокол: Контракт и Доставка</h3><p>Последний цикл перед финальной сборкой. Вы можете обменять излишки ресурсов с внешним поставщиком (**Ведущий**). Обмен **не тратит** лимит хода, а **Рывок** требует энергии.</p>";
                case 7: return "<h3>Финальный Протокол: Сборка Маяка</h3><p>Это ваш последний шанс. Объедините ключевые компоненты (**1 ${RESOURCES.M.name}, 1 ${RESOURCES.W.name}, 1 ${RESOURCES.K.name}**) и бонусный кабель (**1 ${RESOURCES.Z.name}**) для отправки сигнала спасения. У вас 3 попытки, но только одна успешная сборка. Используйте команду **СБОР** в Протоколе Связи.</p>";
            }
        }

        function loadRound(round) {
            const desc = document.getElementById('round-description');
            const actions = document.getElementById('action-area');
            actions.innerHTML = '';
            document.getElementById('round-title').textContent = ROUND_TITLES[round];
            desc.innerHTML = getRoundDescription(round);
            const group = gameState.group;
            
            if (round === 1) {
                 // Кнопки закупки и заработка уже в getRoundDescription
                 return;
            } else if (round === 2) {
                 if (group === 'Technocrats') {
                     actions.innerHTML = `<button onclick="applyRoundAction('Opt_E')">🛠️ Оптимизировать Энергию (-1 ${RESOURCES.E.icon}, +1 ${RESOURCES.Z.icon}, +1 Статус)</button><button onclick="applyRoundAction('Rec_S')">🔩 Обычный сбор Сплава (+2 ${RESOURCES.S.icon})</button>`;
                 } else if (group === 'Bioengineers') {
                     actions.innerHTML = `<button onclick="applyRoundAction('Opt_B')">🧪 Запуск Гидропоники (-1 ${RESOURCES.B.icon}, +1 ${RESOURCES.L.icon}, +1 Статус)</button><button onclick="applyRoundAction('Rec_F')">🧶 Сбор Флоры (+2 ${RESOURCES.F.icon})</button>`;
                 } else if (group === 'Constructors') {
                     actions.innerHTML = `<button onclick="applyRoundAction('Opt_S')">🧱 Укрепить Базу (-1 ${RESOURCES.S.icon}, +1 ${RESOURCES.F.icon}, +1 Статус)</button><button onclick="applyRoundAction('Rec_E')">⚡ Обычный сбор Энергоячеек (+2 ${RESOURCES.E.icon})</button>`;
                 }
            } else if (round === 3) {
                 actions.innerHTML = `
                    <button onclick="applyRoundAction('L_Fix')">💧 Устранить Реагентом (-1 ${RESOURCES.L.icon}, +2 Статус)</button>
                    <button onclick="applyRoundAction('M_Fix')">❄️ Улучшить Крио-Модулем (-1 ${RESOURCES.M.icon}, +2 HP)</button>
                    <button onclick="applyRoundAction('Fail_3')">🔴 Ничего не делать (-2 HP, -1 Статус)</button>
                 `;
            } else if (round === 4) {
                 actions.innerHTML = `
                    <button onclick="applyRoundAction('K_Invest')">📦 Герметичный Захват (-1 ${RESOURCES.K.icon}, +3 ${RESOURCES.L.icon})</button>
                    <button onclick="applyRoundAction('W_Invest')">🌊 Анализ Синтезатором (-1 ${RESOURCES.W.icon}, +2 Статус)</button>
                    <button onclick="applyRoundAction('Fail_4')">🔴 Рискованное Обследование (-3 HP)</button>
                 `;
            } else if (round === 5) {
                 actions.innerHTML = `
                    <button onclick="applyRoundAction('Craft_M_W_K')">⚙️ Создать Промежуточный Компонент (M/W/K)</button>
                    <button onclick="applyRoundAction('Gather_E_B_S')">🔄 Собрать Базовые Ресурсы (+1 ${RESOURCES.E.icon}, +1 ${RESOURCES.B.icon}, +1 ${RESOURCES.S.icon}, +1 Статус)</button>
                 `;
            } else if (round === 6) {
                 actions.innerHTML = `
                    <button onclick="applyRoundAction('Trade')">🤝 Обмен Ресурсами (Протокол Связи)</button>
                    <button onclick="applyRoundAction('Final_Dash')">⚡ Финальный Рывок (-2 ${RESOURCES.E.icon}, +3 Статус)</button>
                 `;
            } else if (round === 7) {
                 actions.innerHTML = `
                    <button onclick="assembleBeacon()" style="background: #2ecc71;">🛰️ Попытка Собрать Маяк (Требуется M, W, K, Z)</button>
                    <button onclick="applyRoundAction('Fail_7')">🔴 Бездействие (Завершить игру)</button>
                 `;
            }
        }

        // Инициализация на всякий случай, если пользователь запускает код напрямую
        document.addEventListener('DOMContentLoaded', () => {
            // Скрыть игровую область, пока не выбрана группа
            document.getElementById('game-round').style.display = 'none';
        });
    </script>
</body>

</html>
