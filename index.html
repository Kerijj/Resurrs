<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–∫—Å–ø–µ–¥–∏—Ü–∏—è –ê—Ä–µ—Å 7 –≠–∫–æ–Ω–æ–º–∏–∫–∞ –í—ã–∂–∏–≤–∞–Ω–∏—è</title>
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #1c1c1c; color: #dcdcdc; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; background: #2a2a2a; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); }
        h1, h2 { color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; margin-top: 0; }
        .intro, .round-content, #trade-dialogue { margin-bottom: 20px; padding: 15px; border: 1px dashed #555; border-radius: 5px; }
        .resources-display { background: #3c3c3c; padding: 10px; border-radius: 5px; margin-top: 15px; }
        .resources-display h3 { color: #2ecc71; margin-top: 0; }
        .log-box { margin-top: 15px; background: #1c1c1c; padding: 10px; height: 100px; overflow-y: scroll; border-radius: 5px; font-size: 0.9em; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; background: #3498db; color: white; margin-right: 10px; transition: background 0.2s; }
        button:hover:not(:disabled) { background: #2980b9; }
        button:disabled { background: #555; cursor: not-allowed; }
        #mod-input { padding: 8px; border-radius: 4px; border: 1px solid #7f8c8d; margin-right: 10px; background: #1c1c1c; color: #dcdcdc; }
        .group-select button { width: 150px; }
        .current-round-title { color: #f1c40f; }
        .task-list { list-style-type: none; padding: 0; }
        .task-list li { margin-bottom: 8px; }
        .inventory-list { margin-top: 10px; list-style-type: none; padding: 0; display: flex; flex-wrap: wrap; gap: 10px;}
        .inventory-item { padding: 5px 10px; border-radius: 5px; background: #444;}
        .hp-bar { color: #e74c3c; font-weight: bold; }
        .actions-count { color: #f1c40f; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üåå –≠–∫—Å–ø–µ–¥–∏—Ü–∏—è –ê—Ä–µ—Å 7 –≠–∫–æ–Ω–æ–º–∏–∫–∞</h1>
        <div id="game-area">
            <div class="intro" id="intro-screen">
                <h2>–ù–∞—á–∞–ª–æ –ú–∏—Å—Å–∏–∏</h2>
                <p>–í—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–∂–∏–≤—à–∏–µ —á–ª–µ–Ω—ã —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏ –ê—Ä–µ—Å 7 –Ω–∞ –ö—Ä–∞—Å–Ω–æ–π –ø–ª–∞–Ω–µ—Ç–µ –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é –≥—Ä—É–ø–ø—É —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
                
                <div class="group-select">
                    <button onclick="startGame('Technocrats')">üõ†Ô∏è –¢–µ—Ö–Ω–æ–∫—Ä–∞—Ç—ã –ò—Å—Ç–æ—á–Ω –≠–Ω–µ—Ä–≥–∏–∏</button>
                    <button onclick="startGame('Bioengineers')">üß™ –ë–∏–æ–∏–Ω–∂–µ–Ω–µ—Ä—ã –û—Ä–≥ –ú–∞—Ç–µ—Ä–∏—è</button>
                    <button onclick="startGame('Constructors')">üß± –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –ü—Ä–æ—á–Ω—ã–π –ú–µ—Ç–∞–ª–ª</button>
                </div>
            </div>

            <div id="game-round" style="display:none;">
                <h2 class="current-round-title" id="round-title"></h2>
                
                <div class="round-content" id="round-description"></div>

                <div id="trade-dialogue" style="display:none;">
                    <h3>ü§ù –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã —Å –ü–µ—Ä–µ–∫—É–ø—â–∏–∫–æ–º</h3>
                    <p style="color: #f1c40f;">–í–≤–µ–¥–∏—Ç–µ –≤ –ø–∞–Ω–µ–ª—å –í–µ–¥—É—â–µ–≥–æ —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ **–û–¢–î–ê–¢–¨ [–∫–æ–¥] [–∫–æ–ª –≤–æ]** –∏ **–ü–û–õ–£–ß–ò–¢–¨ [–∫–æ–¥] [–∫–æ–ª –≤–æ]**</p>
                    <p style="font-size: 0.9em;">–ù–∞–ø—Ä–∏–º–µ—Ä –û–¢–î–ê–¢–¨ S 1 –∏ –ü–û–õ–£–ß–ò–¢–¨ B 1</p>
                </div>

                <div class="resources-display">
                    <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: <span id="player-group-name"></span></h3>
                    <p>–ñ–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ (HP): <span id="res-hp" class="hp-bar"></span></p>
                    <p>–î–µ–π—Å—Ç–≤–∏–π –æ—Å—Ç–∞–ª–æ—Å—å: <span id="actions-remaining" class="actions-count"></span> / 3</p>

                    <ul class="inventory-list" id="inventory-list-display"></ul>
                    <p id="group-status"></p>
                </div>

                <div class="action-area" id="action-area">
                    </div>
                
                <div class="log-box">
                    **–ñ—É—Ä–Ω–∞–ª –í–µ–¥—É—â–µ–≥–æ**
                    <div id="game-log"></div>
                </div>

                <div style="margin-top: 20px; padding: 10px; background: #444; border-radius: 5px;">
                    <h4>–ü–∞–Ω–µ–ª—å –í–µ–¥—É—â–µ–≥–æ –í–≤–æ–¥ –∫–æ–º–∞–Ω–¥</h4>
                    <input type="text" id="mod-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –í–µ–¥—É—â–µ–≥–æ">
                    <button onclick="processModCommand()">–í–≤–æ–¥</button>
                    <button onclick="checkNextRound()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –î–µ–π—Å—Ç–≤–∏—è –†–∞—É–Ω–¥–∞</button>
                </div>
            </div>
            
            <div id="game-over" style="display:none; text-align: center;">
                 <h2 style="color: #e74c3c;">üî¥ –ú–ò–°–°–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê</h2>
                 <p id="game-over-message"></p>
            </div>
        </div>
    </div>

    <script>
        const RESOURCES = {
            // –ë–∞–∑–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã (5 —à—Ç)
            E: { name: '–ò—Å—Ç–æ—á–Ω –≠–Ω–µ—Ä–≥–∏–∏', code: 'E' },
            B: { name: '–û—Ä–≥ –ú–∞—Ç–µ—Ä–∏—è', code: 'B' },
            S: { name: '–ü—Ä–æ—á–Ω—ã–π –ú–µ—Ç–∞–ª–ª', code: 'S' },
            L: { name: '–ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä L', code: 'L' },
            F: { name: '–í–æ–ª–æ–∫–Ω–æ F', code: 'F' },
            
            // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (4 —à—Ç)
            M: { name: '–ö—Ä–∏–æ –ú–æ–¥—É–ª—å', code: 'M' },
            W: { name: '–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –í–æ–¥—ã', code: 'W' },
            K: { name: '–ì–µ—Ä–º–æ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä', code: 'K' },
            Z: { name: '–û–ø—Ç–∏—á –ö–∞–±–µ–ª—å', code: 'Z' }, 
            
            P: { name: '–ú–∞—è–∫ –°–ø–∞—Å–µ–Ω–∏—è', code: 'P' },
            HP: { name: '–ñ–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ', code: 'HP' }
        };
        
        const GROUP_BONUSES = {
            Technocrats: 'E', 
            Bioengineers: 'B', 
            Constructors: 'S'
        };

        const ROUND_TITLES = [
            "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ú–∏—Å—Å–∏–∏",
            "–†–∞—É–Ω–¥ 1 –°–±–æ—Ä –ë–∞–∑–æ–≤—ã—Ö –≠–ª–µ–º–µ–Ω—Ç–æ–≤",
            "–†–∞—É–Ω–¥ 2 –ö—Ä–∞—Ñ—Ç –∏ –õ–æ–≥–∏—Å—Ç–∏–∫–∞",
            "–†–∞—É–Ω–¥ 3 –ê–Ω–æ–º–∞–ª–∏—è –∏ –†–∏—Å–∫",
            "–†–∞—É–Ω–¥ 4 –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –û—Å–∫–æ–ª–∫–∞",
            "–†–∞—É–Ω–¥ 5 –ë—É—Ä—è –∏ –ó–∞—â–∏—Ç–∞",
            "–†–∞—É–Ω–¥ 6 –§–∏–Ω–∞–ª—å–Ω—ã–π –ü–æ–¥—ä–µ–º –∏ –ö–û–ù–¢–†–ê–ö–¢",
            "–†–∞—É–Ω–¥ 7 –°–±–æ—Ä–∫–∞ –ú–∞—è–∫–∞ –∏ –§–∏–Ω–∞–ª"
        ];
        
        const CRAFT_COSTS = {
            M: { E: 3, B: 2 }, 
            W: { B: 3, S: 2 }, 
            K: { S: 3, L: 2 }, 
            Z: { L: 3, F: 2 }
        };

        let gameState = {
            group: null,
            inventory: { E: 2, B: 2, S: 2, L: 0, F: 0, M: 0, W: 0, K: 0, Z: 0, P: 0, HP: 15 }, // HP = 15
            currentRound: 0,
            actionsTaken: 0,
            maxActions: 3,
            status: "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –º–∏—Å—Å–∏–∏",
            historyLog: []
        };

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ì–†–û–ô ---

        function checkNextRound() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞: –ò–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ 3 –¥–µ–π—Å—Ç–≤–∏—è 
            if (gameState.currentRound !== 6 && gameState.actionsTaken < gameState.maxActions) {
                updateLog("üõë –í—ã –µ—â–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ 3 –¥–µ–π—Å—Ç–≤–∏—è —ç—Ç–æ–≥–æ —Ä–∞—É–Ω–¥–∞", true);
                return;
            }
            if (gameState.currentRound === 6 && document.getElementById('trade-dialogue').style.display === 'block') {
                 updateLog("üõë –û–±–º–µ–Ω –∞–∫—Ç–∏–≤–µ–Ω –ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –ø—Ä–µ–∂–¥–µ —á–µ–º –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ", true);
                 return;
            }

            if (gameState.currentRound === 7) return; 

            // –°–ø–∏—Å–∞–Ω–∏–µ HP –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ–∏–≥—Ä—ã—à
            const hpLoss = 3; 
            gameState.inventory.HP -= hpLoss;
            updateLog(`üíî –ñ–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ -${hpLoss} HP. –¢–µ–∫—É—â–∏–π HP: ${gameState.inventory.HP}`);

            if (gameState.inventory.HP <= 0) {
                gameOver("–ñ–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–≥–ª–æ –Ω—É–ª—è –í–∞—à–∞ –≥—Ä—É–ø–ø–∞ –ø–æ–≥–∏–±–ª–∞ –Ω–∞ –ú–∞—Ä—Å–µ");
                return;
            }
            
            // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É
            gameState.currentRound++;
            gameState.actionsTaken = 0; // –°–±—Ä–æ—Å –¥–µ–π—Å—Ç–≤–∏–π
            document.getElementById('trade-dialogue').style.display = 'none';
            updateLog(`=== –ü–µ—Ä–µ—Ö–æ–¥ –≤ ${ROUND_TITLES[gameState.currentRound]} ===`, true);
            gameState.status = "";
            loadRound(gameState.currentRound);
            updateUI();
        }

        function takeAction() {
            if (gameState.actionsTaken >= gameState.maxActions) {
                updateLog("üõë –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏–π (3) –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ", true);
                return false;
            }
            gameState.actionsTaken++;
            document.getElementById('actions-remaining').textContent = gameState.maxActions - gameState.actionsTaken;
            return true;
        }

        function gameOver(message) {
            document.getElementById('game-round').style.display = 'none';
            document.getElementById('game-over').style.display = 'block';
            document.getElementById('game-over-message').textContent = message;
        }


        // --- UI –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---

        function updateUI() {
            document.getElementById('player-group-name').textContent = gameState.group;
            
            const hpElement = document.getElementById('res-hp');
            hpElement.textContent = gameState.inventory.HP;
            if (gameState.inventory.HP <= 6) {
                hpElement.style.color = '#ff0000'; // –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –ø—Ä–∏ –Ω–∏–∑–∫–æ–º HP
            } else {
                hpElement.style.color = '#e74c3c';
            }
            
            document.getElementById('actions-remaining').textContent = gameState.maxActions - gameState.actionsTaken;
            
            // –°–ø–∏—Å–æ–∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
            const inventoryList = document.getElementById('inventory-list-display');
            let html = '';
            const orderedKeys = Object.keys(gameState.inventory).filter(k => k !== 'HP' && k !== 'P').sort((a, b) => {
                 const isBaseA = ['E', 'B', 'S', 'L', 'F'].includes(a);
                 const isBaseB = ['E', 'B', 'S', 'L', 'F'].includes(b);
                 if (isBaseA && !isBaseB) return -1;
                 if (!isBaseA && isBaseB) return 1;
                 return a.localeCompare(b);
            });
            
            orderedKeys.forEach(code => {
                const count = gameState.inventory[code];
                if (count > 0) {
                    html += `<li class="inventory-item">${RESOURCES[code].name} (${count})</li>`;
                }
            });
            inventoryList.innerHTML = html || '<li>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</li>';
            
            document.getElementById('group-status').innerHTML = gameState.status;
            document.getElementById('round-title').textContent = ROUND_TITLES[gameState.currentRound];
        }

        function startGame(groupName) {
            gameState.group = groupName;
            gameState.currentRound = 1;
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('game-round').style.display = 'block';
            
            updateLog(`–ì—Ä—É–ø–ø–∞ –≤—ã–±—Ä–∞–Ω–∞ **${groupName}** –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è ${ROUND_TITLES[gameState.currentRound]}`);
            updateUI();
            loadRound(1);
        }
        
        // --- –õ–û–ì–ò–ö–ê –í–ï–î–£–©–ï–ì–û (—Ç–æ–ª—å–∫–æ –¥–ª—è –ö—Ä–∞—Ñ—Ç–∞ –∏ –û–±–º–µ–Ω–∞) ---

        function processModCommand() {
            const input = document.getElementById('mod-input').value.trim().toLowerCase();
            const words = input.split(' ');
            document.getElementById('mod-input').value = '';

            // 1. –ö–†–ê–§–¢ [–∫–æ–¥] (–†2 –∏ –¥–∞–ª–µ–µ)
            if (words[0] === '–∫—Ä–∞—Ñ—Ç' && words.length === 2) {
                const resCode = words[1].toUpperCase();
                if (['M', 'W', 'K', 'Z'].includes(resCode)) {
                    craftIntermediate(resCode);
                    return;
                }
            }

            // 2. –ö–û–ù–¢–†–ê–ö–¢ (–†6)
            if (input === '–∫–æ–Ω—Ç—Ä–∞–∫—Ç' && gameState.currentRound === 6) {
                updateLog("ü§ù **–ü–ï–†–ï–ö–£–ü–©–ò–ö –ê–ö–¢–ò–í–ò–†–û–í–ê–ù** –ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –û–¢–î–ê–¢–¨ –ü–û–õ–£–ß–ò–¢–¨");
                document.getElementById('trade-dialogue').style.display = 'block';
                return;
            }
            
            // 3. –û–¢–î–ê–¢–¨ / –ü–û–õ–£–ß–ò–¢–¨ [–∫–æ–¥] [–∫–æ–ª –≤–æ] (–†6 –º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–º–µ–Ω–∞)
            if ((words[0] === '–æ—Ç–¥–∞—Ç—å' || words[0] === '–ø–æ–ª—É—á–∏—Ç—å') && words.length === 3) {
                 const action = words[0];
                 const resCode = words[1].toUpperCase();
                 const amount = parseInt(words[2]);

                 if (RESOURCES[resCode] && !isNaN(amount) && document.getElementById('trade-dialogue').style.display === 'block') {
                    if (action === '–æ—Ç–¥–∞—Ç—å') {
                        if (gameState.inventory[resCode] >= amount) {
                            gameState.inventory[resCode] -= amount;
                            updateLog(`–ü–µ—Ä–µ–∫—É–ø—â–∏–∫ –ì—Ä—É–ø–ø–∞ ${gameState.group} –æ—Ç–¥–∞–ª–∞ **-${amount} ${RESOURCES[resCode].name}**`);
                        } else {
                            updateLog(`üõë –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ${RESOURCES[resCode].name} –¥–ª—è –æ—Ç–¥–∞—á–∏ –û–±–º–µ–Ω –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω`, true);
                        }
                    } else if (action === '–ø–æ–ª—É—á–∏—Ç—å') {
                        gameState.inventory[resCode] += amount;
                        updateLog(`–ü–µ—Ä–µ–∫—É–ø—â–∏–∫ –ì—Ä—É–ø–ø–∞ ${gameState.group} –ø–æ–ª—É—á–∏–ª–∞ **+${amount} ${RESOURCES[resCode].name}**`);
                    }
                    updateUI();
                    return;
                }
            }
            
            updateLog("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–ª–∏ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è –∫–æ–º–∞–Ω–¥–∞ –í–µ–¥—É—â–µ–≥–æ", true);
        }

        // --- –õ–û–ì–ò–ö–ê –î–ï–ô–°–¢–í–ò–ô ---

        function craftIntermediate(resCode) {
            const cost = CRAFT_COSTS[resCode];
            let canCraft = true;

            for (const res in cost) {
                if (gameState.inventory[res] < cost[res]) {
                    updateLog(`üõë –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ${RESOURCES[res].name} —Ç—Ä–µ–±—É–µ—Ç—Å—è ${cost[res]} –ö—Ä–∞—Ñ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω`, true);
                    canCraft = false;
                    break;
                }
            }

            if (canCraft) {
                for (const res in cost) {
                    gameState.inventory[res] -= cost[res];
                }
                gameState.inventory[resCode]++;
                updateLog(`üéâ –ö—Ä–∞—Ñ—Ç —É—Å–ø–µ—à–µ–Ω –°–æ–∑–¥–∞–Ω **1 ${RESOURCES[resCode].name}**`);
            }
            updateUI();
        }

        function applyRoundAction(actionCode) {
             // –†2 (–ö—Ä–∞—Ñ—Ç) –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è, –†6 (–û–±–º–µ–Ω) –Ω–µ —Ç—Ä–∞—Ç–∏—Ç –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–ø—Ä—è–º—É—é
             if (gameState.currentRound !== 2 && gameState.currentRound !== 6) {
                 if (!takeAction()) return;
             }
             
             let statusChange = 0;
             let message = "";

             if (gameState.currentRound === 1) { // –°–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤
                 const bonusRes = GROUP_BONUSES[gameState.group];
                 const isBonus = actionCode === bonusRes;
                 const gain = isBonus ? 5 : 3; // –ë–æ–Ω—É—Å–Ω–∞—è –¥–æ–±—ã—á–∞
                 
                 gameState.inventory[actionCode] += gain;
                 message = `–î–æ–±—ã—á–∞ ${RESOURCES[actionCode].name}: +${gain}. ${isBonus ? "–ë–æ–Ω—É—Å–Ω—ã–π –£—Å–ø–µ—Ö" : "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –°–±–æ—Ä"}`;
             } else if (gameState.currentRound === 3) { // –ê–Ω–æ–º–∞–ª–∏—è –∏ –†–∏—Å–∫
                 const hasRes = gameState.inventory[actionCode] > 0;
                 if (actionCode === 'S' || actionCode === 'B') {
                     if (hasRes) {
                        gameState.inventory[actionCode]--; // –¢—Ä–∞—Ç–∏–º —Ä–µ—Å—É—Ä—Å
                        statusChange = 1; message = `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω ${RESOURCES[actionCode].name} -1 —Ä–µ—Å—É—Ä—Å +1 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É`;
                     } else {
                        statusChange = -2; message = `–ù–µ —Ö–≤–∞—Ç–∏–ª–æ ${RESOURCES[actionCode].name} -2 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É –∏ -2 HP`;
                        gameState.inventory.HP -= 2;
                     }
                 } else if (actionCode === 'Risk') {
                     // –†–∏—Å–∫–Ω—É—Ç—å –±–µ–∑ —Ä–µ—Å—É—Ä—Å–∞, –Ω–æ —ç—Ç–æ —É–∂–µ –º–∏–Ω—É—Å 1 –¥–µ–π—Å—Ç–≤–∏–µ, –ø–æ—ç—Ç–æ–º—É –ª–æ–≥–∏–∫–∞ –≤—ã—à–µ –ª—É—á—à–µ
                     statusChange = -1; message = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ –Ω–∞—É–≥–∞–¥ -1 –∫ —Å—Ç–∞—Ç—É—Å—É";
                 }
             } else if (gameState.currentRound === 4) { // –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –û—Å–∫–æ–ª–∫–∞
                 const hasRes = gameState.inventory[actionCode] > 0;
                 if (hasRes) {
                      if (actionCode === 'M') { statusChange = 1; message = "–ò–∑—É—á–µ–Ω–∏–µ —Å M –¥–∞–ª–æ +1 –ü–æ–¥—Å–∫–∞–∑–∫–∞ –û—Å–∫–æ–ª–æ–∫ —á–∞—Å—Ç—å –∞–Ω—Ç–µ–Ω–Ω—ã –ú–∞—è–∫–∞"; }
                      else if (actionCode === 'W') { statusChange = -1; message = "–ê–Ω–∞–ª–∏–∑ W –±—ã–ª –Ω–µ–≤–µ—Ä–Ω—ã–º -1"; }
                      else if (actionCode === 'K') { statusChange = 2; message = "–ì–µ—Ä–º–µ—Ç–∏–∑–∞—Ü–∏—è K —Å –û—Å–∫–æ–ª–∫–æ–º **+2 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É**"; }
                 } else {
                     statusChange = -1; message = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ –Ω–∞—É–≥–∞–¥ -1 –∫ —Å—Ç–∞—Ç—É—Å—É";
                 }
             } else if (gameState.currentRound === 5) { // –ë—É—Ä—è –∏ –ó–∞—â–∏—Ç–∞
                 const hasK = gameState.inventory.K > 0;
                 if (actionCode === 'Defend') {
                     if (hasK) {
                          statusChange = 1; message = "–ó–∞—â–∏—Ç–∞ —Å –ì–µ—Ä–º–æ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º (K) —É—Å–ø–µ—à–Ω–∞ +1 –∫ —Å—Ç–∞—Ç—É—Å—É";
                     } else {
                          statusChange = -1; message = "–ó–∞—â–∏—Ç–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞ –ù–µ—Ç –ì–µ—Ä–º–æ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -1 –∫ —Å—Ç–∞—Ç—É—Å—É –∏ -1 HP"; gameState.inventory.HP -= 1;
                     }
                 } else if (actionCode === 'Repair') {
                     if (gameState.inventory.E > 0 || gameState.inventory.B > 0) {
                         const usedRes = gameState.inventory.E > 0 ? 'E' : 'B';
                         gameState.inventory[usedRes]--;
                         gameState.inventory.HP += 3;
                         message = `–í—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç —Å ${RESOURCES[usedRes].name} -1 —Ä–µ—Å—É—Ä—Å +3 HP`;
                     } else {
                         statusChange = -2; message = "–†–µ–º–æ–Ω—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω –ù–µ—Ç E –∏–ª–∏ B -2 –∫ —Å—Ç–∞—Ç—É—Å—É";
                     }
                 }
             } else if (gameState.currentRound === 6) { // –§–∏–Ω–∞–ª—å–Ω—ã–π –ü–æ–¥—ä–µ–º
                 if (actionCode === 'Race') {
                     if (gameState.inventory.E > 0) {
                         gameState.inventory.E -= 1; statusChange = 1; message = "–†—ã–≤–æ–∫ –Ω–∞ —ç–Ω–µ—Ä–≥–∏–∏ -1 E +1 –∫ —Å—Ç–∞—Ç—É—Å—É";
                     } else {
                         statusChange = -2; message = "–†—ã–≤–æ–∫ –±–µ–∑ —ç–Ω–µ—Ä–≥–∏–∏ -2 –∫ —Å—Ç–∞—Ç—É—Å—É –∏ -2 HP"; gameState.inventory.HP -= 2;
                     }
                 } else if (actionCode === 'Trade') {
                    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –æ–±–º–µ–Ω–∞
                    gameState.actionsTaken--; // –ù–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
                    document.getElementById('trade-dialogue').style.display = 'block';
                    message = "–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –í–≤–µ–¥–∏—Ç–µ –ö–û–ù–¢–†–ê–ö–¢";
                    updateLog(message);
                    updateUI();
                    return; 
                 } else if (actionCode === 'Safe') {
                     statusChange = 1; message = "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å +1 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É";
                 }
             }
             
             if (message) updateLog(`‚úÖ –î–µ–π—Å—Ç–≤–∏–µ —É—Å–ø–µ—à–Ω–æ ${message}`);
             
             if (gameState.inventory.HP <= 0) {
                gameOver("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ä–∏—Å–∫–æ–≤ –ñ–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —É–ø–∞–ª–æ –¥–æ –Ω—É–ª—è");
                return;
             }

             if (statusChange !== 0) {
                 gameState.historyLog.push({ round: gameState.currentRound, statusChange: statusChange, details: `–î–µ–π—Å—Ç–≤–∏–µ ${actionCode}` });
             }
             gameState.status = `–°—Ç–∞—Ç—É—Å ${message}`;
             loadRound(gameState.currentRound); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ UI
             updateUI();
        }

        // --- –§–ò–ù–ê–õ ---

        function assembleBeacon() {
            const required = { M: 1, W: 1, K: 1 };
            let canAssemble = true;

            for (const res in required) {
                if (gameState.inventory[res] < required[res]) {
                    updateLog(`üõë –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ${RESOURCES[res].name} –¥–ª—è —Å–±–æ—Ä–∫–∏ –ú–∞—è–∫–∞`, true);
                    canAssemble = false;
                    break;
                }
            }

            if (canAssemble) {
                gameState.inventory.M -= 1;
                gameState.inventory.W -= 1;
                gameState.inventory.K -= 1;
                gameState.inventory.P = 1;
                updateLog(`üéâ **–ú–∞—è–∫ –°–ø–∞—Å–µ–Ω–∏—è –°–æ–±—Ä–∞–Ω** –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—á–∞ —Å–∏–≥–Ω–∞–ª–∞`);
                updateUI();
                setTimeout(() => {
                    document.getElementById('action-area').innerHTML = `<h3>${getFinalMessage()}</h3>`;
                }, 500);
            }
        }

        function calculateFinalScore() {
            const assemblyBonus = gameState.inventory.P > 0 ? 5 : 0;
            const Z_bonus = gameState.inventory.Z > 0 ? 2 : 0; 
            const historyScore = gameState.historyLog.reduce((sum, log) => sum + log.statusChange, 0);
            return assemblyBonus + historyScore + Z_bonus;
        }

        function getFinalMessage() {
            const score = calculateFinalScore();
            if (gameState.inventory.P === 0) return "‚ùå –ü—Ä–æ–≤–∞–ª –º–∏—Å—Å–∏–∏ –ú–∞—è–∫ –Ω–µ —Å–æ–±—Ä–∞–Ω –°–∏–≥–Ω–∞–ª –æ —Å–ø–∞—Å–µ–Ω–∏–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –°—á–µ—Ç " + score;
            if (score >= 8) return "üåü –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –£—Å–ø–µ—Ö –°—á–µ—Ç " + score + " –í—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç–µ—Å—å –≥–µ—Ä–æ–µ–º –ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–¥–µ–∞–ª—å–Ω–æ";
            if (score >= 4) return "‚úÖ –£—Å–ø–µ—Ö –°—á–µ—Ç " + score + " –°–∏–≥–Ω–∞–ª –ø—Ä–∏–Ω—è—Ç –í—ã –≤—ã–∂–∏–ª–∏ –Ω–æ –≤–∞—à–∞ –º–∏—Å—Å–∏—è –±—ã–ª–∞ –Ω–∞ –≥—Ä–∞–Ω–∏";
            return "‚ö†Ô∏è –ù–∏–∑–∫–∏–π –£—Å–ø–µ—Ö –°—á–µ—Ç " + score + " –ú–∞—è–∫ —Å–æ–±—Ä–∞–Ω –Ω–æ —Å–ª–∞–±—ã–π —Å–∏–≥–Ω–∞–ª –í–∞—à–µ –≤—ã–∂–∏–≤–∞–Ω–∏–µ –ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º";
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê –†–ê–£–ù–î–û–í ---

        function getRoundDescription(round) {
            switch(round) {
                case 1: return "<h3>–ó–∞–¥–∞–Ω–∏–µ: –°–±–æ—Ä –ë–∞–∑–æ–≤—ã—Ö –≠–ª–µ–º–µ–Ω—Ç–æ–≤</h3><p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫–æ–π —Ä–µ—Å—É—Ä—Å –≤—ã –±—É–¥–µ—Ç–µ –¥–æ–±—ã–≤–∞—Ç—å –≤ —ç—Ç–æ–º –¥–µ–π—Å—Ç–≤–∏–∏ (–ª–∏–º–∏—Ç 3 –¥–µ–π—Å—Ç–≤–∏—è)</p><p>–í–∞—à–∞ –≥—Ä—É–ø–ø–∞ **" + gameState.group + "** –ø–æ–ª—É—á–∞–µ—Ç **+5** —Å–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ –∏ **+3** –¥—Ä—É–≥–∏—Ö</p>";
                case 2: return "<h3>–ó–∞–¥–∞–Ω–∏–µ: –ö—Ä–∞—Ñ—Ç –∏ –õ–æ–≥–∏—Å—Ç–∏–∫–∞</h3><p>–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –ú–∞—è–∫–∞ –∏–ª–∏ –±–æ–Ω—É—Å–Ω—ã–π –∫–∞–±–µ–ª—å (Z) –ö–ª—é—á–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É **–ö–†–ê–§–¢ [–∫–æ–¥]**</p><hr><h4>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</h4><ul class='task-list'><li>**M** (3 E + 2 B)</li><li>**W** (3 B + 2 S)</li><li>**K** (3 S + 2 L)</li><li>**Z** (3 L + 2 F) –ë–æ–Ω—É—Å</li></ul>";
                case 3: return "<h3>–ó–∞–¥–∞–Ω–∏–µ: –ê–Ω–æ–º–∞–ª–∏—è –∏ –†–∏—Å–∫</h3><p>–ù–∞ –≤–∞—à–µ–º –ø—É—Ç–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ –≥–µ–æ—Ç–µ—Ä–º–∞–ª—å–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ—Å—É—Ä—Å –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∏–ª–∏ —Ä–∏—Å–∫—É–π—Ç–µ –ø–æ—Ç–µ—Ä–µ–π HP –∏ —Å—Ç–∞—Ç—É—Å–∞</p>";
                case 4: return "<h3>–ó–∞–¥–∞–Ω–∏–µ: –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –û—Å–∫–æ–ª–∫–∞</h3><p>–ù–∞–π–¥–µ–Ω –º–µ—Ä—Ü–∞—é—â–∏–π –û—Å–∫–æ–ª–æ–∫ –ü—Ä–∏–º–µ–Ω–∏—Ç–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∏–ª–∏ –∑–∞—Ö–≤–∞—Ç–∞</p>";
                case 5: return "<h3>–ó–∞–¥–∞–Ω–∏–µ: –ë—É—Ä—è –∏ –ó–∞—â–∏—Ç–∞</h3><p>–ù–∞–¥–≤–∏–≥–∞–µ—Ç—Å—è –±—É—Ä—è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–ì–µ—Ä–º–æ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä (K)** –¥–ª—è –∑–∞—â–∏—Ç—ã –∏–ª–∏ –±–∞–∑–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞ (+3 HP)</p>";
                case 6: return "<h3>–ó–∞–¥–∞–Ω–∏–µ: –§–∏–Ω–∞–ª—å–Ω—ã–π –ü–æ–¥—ä–µ–º</h3><p>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä—ã–≤–æ–∫ –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é **–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ** –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Å–ª–æ–≤–æ–º **–ö–û–ù–¢–†–ê–ö–¢**</p>";
                case 7: return "<h3>–ó–∞–¥–∞–Ω–∏–µ: –°–±–æ—Ä–∫–∞ –ú–∞—è–∫–∞ –∏ –§–∏–Ω–∞–ª</h3><p>–°–æ–±–µ—Ä–∏—Ç–µ 1 **M** 1 **W** 1 **K** –¥–ª—è –ø–æ–±–µ–¥—ã</p>";
            }
        }

        function loadRound(round) {
            const desc = document.getElementById('round-description');
            const actions = document.getElementById('action-area');
            actions.innerHTML = '';
            desc.innerHTML = getRoundDescription(round);

            if (round === 1) {
                actions.innerHTML = `
                    <button onclick="applyRoundAction('E')">–î–æ–±—ã—Ç—å –ò—Å—Ç–æ—á–Ω –≠–Ω–µ—Ä–≥–∏–∏ (E)</button>
                    <button onclick="applyRoundAction('B')">–î–æ–±—ã—Ç—å –û—Ä–≥ –ú–∞—Ç–µ—Ä–∏—é (B)</button>
                    <button onclick="applyRoundAction('S')">–î–æ–±—ã—Ç—å –ü—Ä–æ—á–Ω—ã–π –ú–µ—Ç–∞–ª–ª (S)</button>
                    <button onclick="applyRoundAction('L')">–î–æ–±—ã—Ç—å –ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä L (L)</button>
                    <button onclick="applyRoundAction('F')">–î–æ–±—ã—Ç—å –í–æ–ª–æ–∫–Ω–æ F (F)</button>
                `;
            } else if (round === 2) {
                actions.innerHTML = `<button disabled>–î–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å –í–µ–¥—É—â–µ–≥–æ –ö–†–ê–§–¢</button>`;
            } else if (round === 3) {
                actions.innerHTML = `
                    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–ü—Ä–æ—á–Ω—ã–π –ú–µ—Ç–∞–ª–ª (S)** –∏–ª–∏ **–û—Ä–≥ –ú–∞—Ç–µ—Ä–∏—é (B)**</p>
                    <button onclick="applyRoundAction('S')">–£–∫—Ä–µ–ø–∏—Ç—å –ø—É—Ç—å (S) -1 S</button>
                    <button onclick="applyRoundAction('B')">–û–±—Ö–æ–¥ (B) -1 B</button>
                    <button onclick="applyRoundAction('Risk')">–†–∏—Å–∫–Ω—É—Ç—å (–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–∞) -2 HP</button>
                `;
            } else if (round === 4) {
                 actions.innerHTML = `
                    <button onclick="applyRoundAction('M')">–ò–∑—É—á–∏—Ç—å –ö—Ä–∏–æ –ú–æ–¥—É–ª—å (M)</button>
                    <button onclick="applyRoundAction('W')">–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–æ–º (W)</button>
                    <button onclick="applyRoundAction('K')">–ì–µ—Ä–º–µ—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º (K)</button>
                `;
            } else if (round === 5) {
                 actions.innerHTML = `
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ: **–ó–∞—â–∏—Ç–∞** (–Ω—É–∂–µ–Ω K) –∏–ª–∏ **–†–µ–º–æ–Ω—Ç** (—Ç—Ä–∞—Ç–∏—Ç E –∏–ª–∏ B, +3 HP)</p>
                    <button onclick="applyRoundAction('Defend')">–ó–∞—â–∏—Ç–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (K)</button>
                    <button onclick="applyRoundAction('Repair')">–í—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç (-1 E/B, +3 HP)</button>
                `;
            } else if (round === 6) {
                 actions.innerHTML = `
                    <button onclick="applyRoundAction('Race')">–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ -1 E</button>
                    <button onclick="applyRoundAction('Trade')">–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –û–±–º–µ–Ω</button>
                    <button onclick="applyRoundAction('Safe')">–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å +1 —Å—Ç–∞—Ç—É—Å</button>
                `;
            } else if (round === 7) {
                actions.innerHTML = `<button onclick="assembleBeacon()">–°–æ–±—Ä–∞—Ç—å –ú–∞—è–∫ –°–ø–∞—Å–µ–Ω–∏—è</button>`;
            }
        }
    </script>
</body>
</html>
