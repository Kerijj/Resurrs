<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–†–û–¢–û–ö–û–õ: –≠–ö–°–ü–ï–î–ò–¶–ò–Ø –ê–†–ï–° | –ë–û–†–¢–û–í–û–ô –ñ–£–†–ù–ê–õ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            background-color: #0b111e;
            color: #1aff00; /* –Ø—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ */
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            padding: 20px;
            text-shadow: 0 0 5px rgba(26, 255, 0, 0.5);
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            border: 2px solid #1aff00;
            box-shadow: 0 0 20px #1aff00;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.7);
        }
        h1, h2, h3 {
            color: #1aff00;
            text-align: center;
            border-bottom: 1px dashed rgba(26, 255, 0, 0.3);
            padding-bottom: 10px;
            margin-top: 20px;
        }
        .intro p {
            font-size: 0.9em;
            color: #00ffaa;
        }
        .status-panel {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border: 1px solid rgba(26, 255, 0, 0.5);
            margin-bottom: 20px;
        }
        .info-block {
            padding: 0 15px;
        }
        .info-block h3 {
            text-align: left;
            border: none;
            margin: 0;
            padding: 0;
            color: #ffcc00; /* –ñ–µ–ª—Ç—ã–π –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
        }
        .inventory-list {
            list-style: none;
            padding: 0;
        }
        .inventory-item {
            font-size: 0.8em;
            color: #00eeff; /* –ì–æ–ª—É–±–æ–π –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */
        }
        .round-content {
            border: 1px solid #1aff00;
            padding: 15px;
            margin-bottom: 20px;
        }
        .group-select button {
            background-color: #004d40;
            color: #1aff00;
            border: 2px solid #1aff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
        }
        .group-select button:hover:not(:disabled) {
            background-color: #00796b;
            box-shadow: 0 0 10px #1aff00;
        }
        .group-select button:disabled {
            background-color: #333;
            color: #666;
            border-color: #666;
            cursor: not-allowed;
        }
        .group-select button.active-group {
            background-color: #ff0000; /* –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π */
            box-shadow: 0 0 15px #ff0000;
            color: #fff;
            border-color: #ff0000;
        }
        .round-action-button {
            background-color: #34495e;
            color: #fff;
            border: 1px solid #7f8c8d;
            padding: 10px 15px;
            margin: 5px 0;
            cursor: pointer;
            width: 100%;
            text-align: left;
            transition: background-color 0.3s;
            font-family: 'Orbitron', sans-serif;
        }
        .round-action-button:hover:not(:disabled) {
            background-color: #2c3e50;
            border-color: #1aff00;
        }
        .round-action-button:disabled {
            background-color: #1a1a1a;
            color: #444;
            border-color: #222;
            cursor: not-allowed;
        }
        .end-round-button {
            background-color: #c0392b;
            color: #fff;
            border: 2px solid #e74c3c;
            padding: 15px;
            margin-top: 20px;
            cursor: pointer;
            width: 100%;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .end-round-button:hover:not(:disabled) {
            background-color: #e74c3c;
            box-shadow: 0 0 15px #e74c3c;
        }
        .end-round-button:disabled {
            background-color: #555;
            color: #aaa;
            border-color: #777;
            cursor: not-allowed;
        }
        .log-box {
            background-color: rgba(0, 0, 0, 0.9);
            border: 1px solid #00eeff;
            height: 200px;
            overflow-y: scroll;
            padding: 10px;
            font-size: 0.8em;
            color: #00ffaa;
        }
        .log-box p {
            margin: 3px 0;
        }
        .log-box .error {
            color: #ff6666; /* –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –æ—à–∏–±–æ–∫ */
            font-weight: bold;
        }
        .final-message {
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            padding: 30px;
            margin: 30px 0;
            border: 3px solid #ffcc00;
            box-shadow: 0 0 30px #ffcc00;
            color: #ffcc00;
        }
        input[type="text"] {
            background-color: #000;
            border: 1px solid #1aff00;
            color: #1aff00;
            padding: 8px;
            font-family: monospace;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ –≤—ã–±–æ—Ä–∞ */
        .pre-game-setup {
            text-align: center;
            padding: 50px 0;
            border: 1px solid #ffcc00;
            margin-bottom: 20px;
        }
        .pre-game-setup button {
            font-size: 1.1em;
            padding: 15px 30px;
            margin: 10px;
            width: 250px;
        }
    </style>
    
</head>
<body>

    <div class="container">
        
        <h1>–ú–ê–†–°–ò–ê–ù–°–ö–ò–ô –¢–ï–†–ú–ò–ù–ê–õ: –ü–†–û–¢–û–ö–û–õ "–ê–õ–¨–§–ê"</h1>
        
        <h2>üö® –ü–†–û–¢–û–ö–û–õ: –ó–ê–ü–£–°–ö (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –°–¢–ê–¢–£–°)</h2>
        <div class="intro" id="preamble-story">
            <p>
                **[–ü–ï–†–ï–î–ê–ß–ê –î–ê–ù–ù–´–•]** –ù–∞—à —Å–ø—É—Å–∫–∞–µ–º—ã–π –∞–ø–ø–∞—Ä–∞—Ç, *¬´–ì–µ—Ä–º–µ—Å V¬ª*, —Å–æ–≤–µ—Ä—à–∏–ª –∂–µ—Å—Ç–∫—É—é –ø–æ—Å–∞–¥–∫—É –≤ —Ä–µ–≥–∏–æ–Ω–µ –≠–ª–∏–∑–∏—É–º –ü–ª–∞–Ω–∏—Ü–∏—è. –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∞–∫—Ç–æ—Ä –ø–∏—Ç–∞–Ω–∏—è –≤—ã—à–µ–ª –∏–∑ —Å—Ç—Ä–æ—è, —Å–∏—Å—Ç–µ–º—ã —Å–≤—è–∑–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ø–µ—Ä–µ–±–æ—è–º–∏. –ú—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã, –∞ –∑–∞–ø–∞—Å—ã –≤–æ–∑–¥—É—Ö–∞ –∏ –≤–æ–¥—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –≤—Å–µ–≥–æ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∞—Ä—Å–∏–∞–Ω—Å–∫–∏—Ö —Å—É—Ç–æ–∫. 
            </p>
            <p>
                **[–û–°–ù–û–í–ù–ê–Ø –¶–ï–õ–¨]** –ù–∞—à–∞ –º–∏—Å—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å. –¢–µ–ø–µ—Ä—å —ç—Ç–æ –Ω–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ, –∞ **–í–´–ñ–ò–í–ê–ù–ò–ï**. –ù–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –¥–æ–±—ã—á–∏ —Ä–µ—Å—É—Ä—Å–æ–≤, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å –∏, —Å–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ, –æ–±–µ—Å–ø–µ—á–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –ø—Ä–∏—Ç–æ–∫ –∂–∏–∑–Ω–µ–Ω–Ω–æ –≤–∞–∂–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: **–≠–Ω–µ—Ä–≥–∏–∏ (üîã), –í–æ–¥—ã (üíß) –∏ –í–æ–∑–¥—É—Ö–∞ (üí®)**. –ö–æ–º–∞–Ω–¥–∏—Ä, –≤—ã –ø–æ–ª—É—á–∏–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –±–æ—Ä—Ç–æ–≤—ã–º —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º. –ö–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥ ‚Äî —ç—Ç–æ —Å—É—Ç–∫–∏. **–û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –≤ –∂–∏–≤—ã—Ö.**
            </p>
        </div>
        
        <hr style="border-top: 1px solid #1aff00;">

        <div id="pre-game-selector" class="pre-game-setup">
            <h2>‚≠ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø: –í–´–ë–û–† –û–°–ù–û–í–ù–û–ô –ì–†–£–ü–ü–´</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É, –∫–æ—Ç–æ—Ä—É—é –≤—ã –±—É–¥–µ—Ç–µ –≤–æ–∑–≥–ª–∞–≤–ª—è—Ç—å. –≠—Ç–∞ –≥—Ä—É–ø–ø–∞ —Å—Ç–∞–Ω–µ—Ç **–ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ–π** –∏ –ø–æ–ª—É—á–∏—Ç **–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –£1** –≤ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã.</p>
            <div class="group-select">
                <button id="pre-select-group-a" onclick="setPrimaryGroup('A')" style="border-color: #00ffaa;">–ì—Ä—É–ø–ø–∞ –ê (–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è)</button>
                <button id="pre-select-group-b" onclick="setPrimaryGroup('B')" style="border-color: #00ffaa;">–ì—Ä—É–ø–ø–∞ –ë (–ë–∏–æ–ª–æ–≥–∏—è)</button>
                <button id="pre-select-group-c" onclick="setPrimaryGroup('C')" style="border-color: #00ffaa;">–ì—Ä—É–ø–ø–∞ –í (–ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)</button>
            </div>
            <p id="group-selection-status" style="margin-top: 15px; color: #ffcc00; font-weight: bold;">–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞...</p>
        </div>

        <div id="main-game-interface" style="display: none;">
            
            <hr style="border-top: 1px solid #1aff00;">

            <div class="intro">
                <p><strong>[–°–ò–°–¢–ï–ú–ê]</strong> –°—Ç–∞—Ç—É—Å: <strong>–û–ù–õ–ê–ô–ù</strong> | –î–∞—Ç–∞: <span id="current-date">20.11.2077</span> | –í—Ä–µ–º—è –ú–∞—Ä—Å–∞ (UTC+1): <span id="current-time">09:35:00</span></p>
                <p><strong>[–ú–ò–°–°–ò–Ø]</strong> –¶–µ–ª—å: –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø–∞—Å–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑ —Å—Ä–µ–¥—ã. –ö–æ–º–∞–Ω–¥–∏—Ä: <strong>–ò–º—è –í–µ–¥—É—â–µ–≥–æ</strong></p>
            </div>
            
            <hr style="border-top: 1px solid #1aff00;">

            <h2>üìä –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´ –ò –ò–ù–í–ï–ù–¢–ê–†–¨</h2>
            <div class="status-panel">
                
                <div class="info-block">
                    <h3>–¢–ï–ö–£–©–ò–ï –†–ï–°–£–†–°–´</h3>
                    <p>üíµ –ë–∞–ª–ª—ã –ø–æ–∫—É–ø–∫–∏: <span id="resource-points">100</span> (–µ–¥.)</p>
                    <p>‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: <span id="resource-health">100</span> (–µ–¥.)</p>
                    <p>üîã –≠–Ω–µ—Ä–≥–∏—è: <span id="resource-power">50</span> (–µ–¥.)</p>
                    <p>üíß –í–æ–¥–∞ (H‚ÇÇO): <span id="resource-water">50</span> (–ª)</p>
                    <p>üí® –í–æ–∑–¥—É—Ö (O‚ÇÇ): <span id="resource-air">50</span> (–º¬≥)</p>
                </div>

                <div class="info-block">
                    <h3>–ò–ù–í–ï–ù–¢–ê–†–¨ (–£1, –£2, –£3)</h3>
                    <ul id="inventory-list" class="inventory-list">
                        <li class="inventory-item">–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤</li>
                    </ul>
                </div>

            </div>
            
            <hr style="border-top: 1px solid #1aff00;">

            <h2>üéØ –†–ê–£–ù–î <span id="round-number">1</span>: –í–´–ë–û–† –î–ï–ô–°–¢–í–ò–Ø</h2>
            <div class="round-content">

                <h3><span id="action-header-text">1. –§–ê–ó–ê –ó–ê–ö–£–ü–ö–ò</span> | <span id="active-group-display"></span></h3>
                <p id="action-prompt">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—É—Ä—Å –£1 –¥–ª—è –ø–æ–∫—É–ø–∫–∏...</p>
                
                <div id="action-buttons" style="margin-top: 10px;">
                    <button class="round-action-button" disabled>–û–ñ–ò–î–ê–ù–ò–ï</button>
                </div>
                
                <hr style="border-top: 1px dashed #1aff00; margin: 20px 0;">

                <h3>2. –ó–ê–í–ï–†–®–ï–ù–ò–ï –§–ê–ó–´</h3>
                <button id="end-round-button" class="end-round-button" disabled>–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î <span id="next-round-indicator">(2)</span></button>
            </div>
            
            <hr style="border-top: 1px solid #1aff00;">

            <h2>üì¢ –ñ–£–†–ù–ê–õ –°–û–ë–´–¢–ò–ô</h2>
            <div id="log-box" class="log-box">
                <p><strong>[09:35:25]</strong> –°–∏—Å—Ç–µ–º–Ω—ã–π –ü—Ä–æ—Ç–æ–∫–æ–ª –∑–∞–ø—É—â–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞...</p>
            </div>
            
            <div id="game-over-message" class="final-message" style="display: none; margin-top: 30px;">
                –ú–ò–°–°–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê. –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í.
            </div>

        </div> </div>

    <script>
    // ====================================================================
    // === –í–ï–°–¨ –ö–û–î JAVASCRIPT –î–õ–Ø –ò–ì–†–´ "–ú–ê–†–°–ò–ê–ù–°–ö–ò–ô –¢–ï–†–ú–ò–ù–ê–õ" ===
    // ====================================================================

    // --- 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–û–í–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–• ---

    const INITIAL_RESOURCES = {
        POWER: 50,      // –≠–Ω–µ—Ä–≥–∏—è
        WATER: 50,      // –í–æ–¥–∞
        AIR: 50,        // –í–æ–∑–¥—É—Ö
        HEALTH: 100,    // –ó–¥–æ—Ä–æ–≤—å–µ –≠–∫–∏–ø–∞–∂–∞
    };
    
    let gameData = {
        round: 0, 
        points: 100, 
        resources: { ...INITIAL_RESOURCES },
        inventory: {}, 
        primaryGroup: null, // –û—Å–Ω–æ–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞ –∏–≥—Ä–æ–∫–∞ (A, B, –∏–ª–∏ C)
        activeGroup: null, // –í–°–ï–ì–î–ê –¢–û –ñ–ï –°–ê–ú–û–ï, –ß–¢–û primaryGroup
        taskCompleted: false, // –§–ª–∞–≥ –¥–ª—è –†1/–†2
        r6Resolved: false, 
        r5ResolvedGroups: { 'A': false, 'B': false, 'C': false } // –î–ª—è –†5
    };
    
    // --- 2. –°–ò–°–¢–ï–ú–ê –ö–†–ê–§–¢–ò–ù–ì–ê/–†–ï–°–£–†–°–û–í –ò –¶–ï–ù–´ ---
    
    const RESOURCE_PRICES = {
        '–†–ì': 22, 'CO2': 16, '–ú–¢': 18, '–ñ–ï': 17, '–•–õ': 20, 
        '–õ–î': 15, 'N': 19, '–ö–õ': 14, '–°–õ': 23, '–§–°': 11,
        '–ê–õ': 13, '–¢–¢': 25, '–ó–û': 10, '–°–í': 24, '–ù–ö': 21
    };

    const RESOURCE_DATABASE = {
        'A': { // TECH_ENERGY
            name: "–ì—Ä—É–ø–ø–∞ –ê (–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è)",
            level1: [ 
                { code: '–†–ì', name: '–†–µ–≥–æ–ª–∏—Ç', description: '–ú–∞—Ä—Å–∏–∞–Ω—Å–∫–∏–π –≥—Ä—É–Ω—Ç, –æ—Å–Ω–æ–≤–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è.', level: 1 },
                { code: 'CO2', name: '–£–≥–ª–µ–∫–∏—Å–ª—ã–π –ì–∞–∑', description: '–ò–∑ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã (–°–æ–±—Ä–∞–Ω–Ω—ã–π –≥–∞–∑).', level: 1 },
                { code: '–ú–¢', name: '–ú–µ—Ç–∞–Ω', description: '–°–ª–µ–¥–æ–≤—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–¥–ª—è —Ä–∞–∫–µ—Ç–Ω–æ–≥–æ —Ç–æ–ø–ª–∏–≤–∞).', level: 1 },
                { code: '–ñ–ï', name: '–ñ–µ–ª–µ–∑–æ', description: '–û–∫—Å–∏–¥ –∂–µ–ª–µ–∑–∞, –∏–∑–≤–ª–µ–∫–∞–µ–º—ã–π –∏–∑ –≥—Ä—É–Ω—Ç–∞.', level: 1 },
                { code: '–•–õ', name: '–•–ª–æ—Ä', description: '–ò–∑ –º–∏–Ω–µ—Ä–∞–ª–æ–≤ (–æ—á–∏—Å—Ç–∫–∞).', level: 1 },
            ],
            level2: [ 
                { code: '–ö–ü', name: '–ö—Ä–µ–º–Ω–∏–µ–≤—ã–µ –ü–ª–∞—Å—Ç–∏–Ω—ã', description: '–î–ª—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏ –∏ —Å–æ–ª–Ω–µ—á–Ω—ã—Ö –±–∞—Ç–∞—Ä–µ–π.', level: 2 },
                { code: 'CO', name: '–ú–æ–Ω–æ–æ–∫—Å–∏–¥ –£–≥–ª–µ—Ä–æ–¥–∞', description: '–ö–ª—é—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ç–æ–ø–ª–∏–≤–∞.', level: 2 },
                { code: '–ì–†', name: '–ì—Ä–∞—Ñ–µ–Ω', description: '–°–≤–µ—Ä—Ö–ª–µ–≥–∫–∏–µ –∏ –ø—Ä–æ—á–Ω—ã–µ –Ω–∞–Ω–æ—Ç—Ä—É–±–∫–∏.', level: 2 },
                { code: '–§–°', name: '–§–µ—Ä—Ä–æ—Å–ø–ª–∞–≤', description: '–°–ø–ª–∞–≤ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö —á–∞—Å—Ç–µ–π.', level: 2 },
                { code: '–≠–õ', name: '–≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç', description: '–î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –≤—ã—Å–æ–∫–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –±–∞—Ç–∞—Ä–µ–π.', level: 2 },
            ],
            level3: [ 
                { code: '–°–§', name: '–°–æ–ª–Ω–µ—á–Ω–∞—è –§–µ—Ä–º–∞', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫—É –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–∞ (–≠) –Ω–∞ +1/—Ö–æ–¥.', bonus: { type: 'POWER_BONUS', value: 1 }, level: 3 },
                { code: '–ê–í–£', name: '–ê–Ω—Ç–µ–Ω–Ω–∞ –í—ã—Å–æ–∫–æ–≥–æ –£—Å–∏–ª–µ–Ω–∏—è', description: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –ë–æ–Ω—É—Å –∫ –ó–ß –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è.', level: 3 },
                { code: '–°–¢', name: '–°–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¢–æ–ø–ª–∏–≤–æ', description: '–£—Å—Ç—Ä–∞–Ω—è–µ—Ç —à—Ç—Ä–∞—Ñ –≠ –¥–ª—è –¥–∞–ª—å–Ω–∏—Ö –ø–æ–µ–∑–¥–æ–∫ –Ω–∞ —Ä–æ–≤–µ—Ä–µ.', level: 3 },
                { code: '–ì–°', name: '–ì–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –°–∫–∞–Ω–µ—Ä', description: '–®–∞–Ω—Å –Ω–∞–π—Ç–∏ —Ä–µ–¥–∫–∏–π —Ä–µ—Å—É—Ä—Å (+1 –•–°) –≤ —Ñ–∞–∑–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.', level: 3 },
                { code: '–ò–ì', name: '–ò–∑–æ—Ç–æ–ø–Ω—ã–π –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', description: '+0.5 –≠ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏.', bonus: { type: 'POWER_BONUS', value: 0.5 }, level: 3 },
            ],
        },
        'B': { // BIO_LIFE
            name: "–ì—Ä—É–ø–ø–∞ –ë (–ë–∏–æ–ª–æ–≥–∏—è)",
            level1: [ { code: '–õ–î', name: '–õ–µ–¥', description: '–õ–µ–¥', level: 1 }, { code: 'N', name: '–ê–∑–æ—Ç', description: '–ê–∑–æ—Ç', level: 1 }, { code: '–ö–õ', name: '–ö–∞–ª–∏–π', description: '–ö–∞–ª–∏–π', level: 1 }, { code: '–°–õ', name: '–°–æ–ª–∏', description: '–°–æ–ª–∏', level: 1 }, { code: '–§–°', name: '–§–æ—Å—Ñ–æ—Ä', description: '–§–æ—Å—Ñ–æ—Ä', level: 1 }],
            level2: [ { code: 'H2O', name: '–ñ–∏–¥–∫–∞—è –í–æ–¥–∞', description: '–í–æ–¥–∞', level: 2 }, { code: '–ü–†', name: '–ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–π –†–∞—Å—Ç–≤–æ—Ä', description: '–ü–†', level: 2 }, { code: '–ö–£', name: '–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –£–¥–æ–±—Ä–µ–Ω–∏–π', description: '–ö–£', level: 2 }, { code: '–ú–î', name: '–ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã', description: '–ú–î', level: 2 }, { code: '–ü–ì', name: '–ü–∏—â–µ–≤–æ–π –ì–µ–ª—å', description: '–ü–ì', level: 2 }],
            level3: [ { code: '–ú–ë', name: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ë–æ—Ç', description: '–ú–ë', level: 3, bonus: { type: 'HEALTH_BONUS', value: 5 } }, { code: '–°–†–í', name: '–°–∏—Å—Ç–µ–º–∞ –†–µ—Ü–∏—Ä–∫—É–ª—è—Ü–∏–∏ –í–æ–¥—ã', description: '–°–†–í', level: 3 }, { code: '–ë–†', name: '–ë–∏–æ-–†–µ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (–û‚ÇÇ)', description: '–ë–†', level: 3 }, { code: '–ì–°–ï–ö', name: '–ì–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –°–µ–∫–≤–µ–Ω—Å–æ—Ä', description: '–ì–°–ï–ö', level: 3 }, { code: '–ê–û', name: '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –û–≥–æ—Ä–æ–¥', description: '–ê–û', level: 3 }],
        },
        'C': { // CONSTRUCTION_REPAIR
            name: "–ì—Ä—É–ø–ø–∞ –í (–ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)",
            level1: [ { code: '–ê–õ', name: '–ê–ª—é–º–∏–Ω–∏–π', description: '–ê–ª—é–º–∏–Ω–∏–π', level: 1 }, { code: '–¢–¢', name: '–¢–∏—Ç–∞–Ω', description: '–¢–∏—Ç–∞–Ω', level: 1 }, { code: '–ó–û', name: '–ó–∞–≥—Ä—è–∑–Ω–µ–Ω–Ω—ã–µ –û—Ç—Ö–æ–¥—ã', description: '–û—Ç—Ö–æ–¥—ã', level: 1 }, { code: '–°–í', name: '–°—Ç–µ–∫–ª–æ–≤–æ–ª–æ–∫–Ω–æ', description: '–°—Ç–µ–∫–ª–æ–≤–æ–ª–æ–∫–Ω–æ', level: 1 }, { code: '–ù–ö', name: '–ù–∏–∫–µ–ª—å', description: '–ù–∏–∫–µ–ª—å', level: 1 }],
            level2: [ { code: '–õ–°', name: '–õ–µ–≥–∫–∏–π –°–ø–ª–∞–≤', description: '–°–ø–ª–∞–≤', level: 2 }, { code: '–ó–°', name: '–ó–∞–∫–∞–ª–µ–Ω–Ω—ã–π –°–ø–ª–∞–≤', description: '–°–ø–ª–∞–≤', level: 2 }, { code: '–í–ö', name: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã', description: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã', level: 2 }, { code: '–£–ü', name: '–£–ø—Ä–æ—á–Ω–µ–Ω–Ω—ã–π –ü–æ–ª–∏–º–µ—Ä', description: '–ü–æ–ª–∏–º–µ—Ä', level: 2 }, { code: '–ò–ö', name: '–ò–Ω–¥—É–∫—Ü–∏–æ–Ω–Ω–∞—è –ö–∞—Ç—É—à–∫–∞', description: '–ö–∞—Ç—É—à–∫–∞', level: 2 }],
            level3: [ { code: '–ê–°–ì', name: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –°–∏—Å—Ç–µ–º–∞ –ì–µ—Ä–º–µ—Ç–∏–∑–∞—Ü–∏–∏', description: '–ê–°–ì', level: 3 }, { code: '–†–≠', name: '–†–∞–¥–∏–∞—Ü–∏–æ–Ω–Ω—ã–π –≠–∫—Ä–∞–Ω', description: '–†–≠', level: 3 }, { code: '–ê–ë–ü', name: '–ê–≤–∞—Ä–∏–π–Ω—ã–π –ë–ª–æ–∫ –ü–∏—Ç–∞–Ω–∏—è', description: '–ê–ë–ü', level: 3 }, { code: '–ö–û', name: '–ö–µ–≤–ª–∞—Ä–æ–≤–∞—è –û–±–æ–ª–æ—á–∫–∞', description: '–ö–û', level: 3 }, { code: '–°–°', name: '–°–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–∏–π—Å—è –°–∫–∞—Ñ–∞–Ω–¥—Ä', description: '–°–°', level: 3 }],
        },
    };
    
    // –ë–æ–Ω—É—Å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –£1 –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ—Å–Ω–æ–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã
    const PRIMARY_GROUP_BONUS_RESOURCES = {
        'A': ['–†–ì', 'CO2'], // –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è: –†–µ–≥–æ–ª–∏—Ç, CO2
        'B': ['–õ–î', 'N'],   // –ë–∏–æ–ª–æ–≥–∏—è: –õ–µ–¥, –ê–∑–æ—Ç
        'C': ['–ê–õ', '–¢–¢']   // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ê–ª—é–º–∏–Ω–∏–π, –¢–∏—Ç–∞–Ω
    };

    const RESOURCE_LOOKUP = {};
    Object.values(RESOURCE_DATABASE).forEach(category => {
        Object.keys(category).filter(key => key.startsWith('level')).forEach(levelKey => {
            category[levelKey].forEach(resource => {
                RESOURCE_LOOKUP[resource.code] = resource;
            });
        });
    });

    const CRAFTING_RECIPES_R3 = {
        '–ö–ü': [{ code: '–†–ì', amount: 2 }], 'H2O': [{ code: '–õ–î', amount: 2 }], '–õ–°': [{ code: '–ê–õ', amount: 2 }],
        '–§–°': [{ code: '–ñ–ï', amount: 2 }], '–ü–†': [{ code: 'N', amount: 2 }], '–ó–°': [{ code: '–¢–¢', amount: 2 }],
        'CO': [{ code: 'CO2', amount: 2 }], '–ö–£': [{ code: '–ö–õ', amount: 2 }], '–í–ö': [{ code: '–°–í', amount: 2 }],
        '–ì–†': [{ code: '–ú–¢', amount: 2 }], '–ú–î': [{ code: '–°–õ', amount: 2 }], '–£–ü': [{ code: '–ù–ö', amount: 2 }],
    };

    const CRAFTING_RECIPES_R4 = {
        '–°–§': [{ code: '–ö–ü', amount: 2 }], '–ú–ë': [{ code: 'H2O', amount: 2 }], '–ê–°–ì': [{ code: '–õ–°', amount: 2 }],
        '–ò–ì': [{ code: '–§–°', amount: 2 }], '–°–†–í': [{ code: '–ü–†', amount: 2 }], '–†–≠': [{ code: '–ó–°', amount: 2 }],
        '–ê–í–£': [{ code: 'CO', amount: 2 }], '–ë–†': [{ code: '–ö–£', amount: 2 }], '–ê–ë–ü': [{ code: '–í–ö', amount: 2 }],
        '–°–¢': [{ code: '–ì–†', amount: 2 }], '–ì–°–ï–ö': [{ code: '–ú–î', amount: 2 }], '–ö–û': [{ code: '–£–ü', amount: 2 }],
    };
    
    // –ó–∞–¥–∞–Ω–∏—è –¥–ª—è –†–∞—É–Ω–¥–∞ 1 (—Ç–æ–ª—å–∫–æ –£1)
    const ROUND_1_TASKS = {
        'A': { group: 'A', question: "–ö–∞–∫–æ–≤–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ (–ì–°)?", answer: "–ø–æ–∏—Å–∫ —Ä–µ–¥–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤", reward: { code: '–ñ–ï', amount: 1 }, points: 17 },
        'B': { group: 'B', question: "–ù–∞–∑–æ–≤–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É –≤–æ–¥—ã, –∫–æ—Ç–æ—Ä—É—é –¥–æ–±—ã–≤–∞—é—Ç –Ω–∞ –ú–∞—Ä—Å–µ.", answer: "–ª–µ–¥", reward: { code: '–õ–î', amount: 1 }, points: 15 },
        'C': { group: 'C', question: "–ö–∞–∫–æ–π —Ä–µ—Å—É—Ä—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –∏ –∏–º–µ–µ—Ç –∫–æ–¥ '–°–í'?", answer: "—Å—Ç–µ–∫–ª–æ–≤–æ–ª–æ–∫–Ω–æ", reward: { code: '–°–í', amount: 1 }, points: 24 },
    };
    
    // –ó–∞–¥–∞–Ω–∏—è –¥–ª—è –†–∞—É–Ω–¥–∞ 2 (–£1 —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–∏–µ - —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã)
    const ROUND_2_TASKS = {
        'A': { question: "–î–ª—è —á–µ–≥–æ –Ω—É–∂–µ–Ω –ò–∑–æ—Ç–æ–ø–Ω—ã–π –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä (–ò–ì)?", answer: "–ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è", reward: { code: 'CO2', amount: 1 }, penalty: { type: 'POWER', value: 3 } },
        'B': { question: "–ö–∞–∫–∏–µ —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è —É–¥–æ–±—Ä–µ–Ω–∏–π (–∫—Ä–æ–º–µ –≤–æ–¥—ã)?", answer: "–∞–∑–æ—Ç –∫–∞–ª–∏–π —Ñ–æ—Å—Ñ–æ—Ä", reward: { code: 'N', amount: 1 }, penalty: { type: 'WATER', value: 3 } },
        'C': { question: "–ö–∞–∫–æ–π –º–µ—Ç–∞–ª–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–≤–µ—Ä—Ö–ø—Ä–æ—á–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏ –∏–º–µ–µ—Ç –∫–æ–¥ '–¢–¢'?", answer: "—Ç–∏—Ç–∞–Ω", reward: { code: '–¢–¢', amount: 1 }, penalty: { type: 'HEALTH', value: 5 } }
    };
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –†–∞—É–Ω–¥–∞ 5 (–ê–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å)
    const APOCALYPSE_PENALTIES = [
        { type: 'WATER', value: 15, msg: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–æ—Ç–µ—Ä—è –≤–æ–¥—ã –∏–∑-–∑–∞ –ø—Ä–æ–±–æ–∏–Ω—ã –≤ —Ç—Ä—É–±–µ.' },
        { type: 'AIR', value: 10, msg: '–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ –≤–æ–∑–¥—É—Ö–∞ –≤ –∂–∏–ª–æ–º –æ—Ç—Å–µ–∫–µ.' },
        { type: 'HEALTH', value: 20, msg: '–°–∏–ª—å–Ω—ã–µ —Ç—Ä–∞–≤–º—ã —ç–∫–∏–ø–∞–∂–∞ –æ—Ç –ø–∞–¥–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.' }
    ];
    // –í –†–∞—É–Ω–¥–µ 5 —Ç–µ–ø–µ—Ä—å —Ä–µ—à–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫—Ä–∏–∑–∏—Å –∞–∫—Ç–∏–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã!
    const CRISIS_DATABASE = {
        'A': { name: "–≠–ù–ï–†–ì–ï–¢–ò–ß–ï–°–ö–ò–ô –®–¢–û–†–ú", flaw: "–£—Ç–µ—á–∫–∞ –≠–Ω–µ—Ä–≥–∏–∏: -10 –≠ –≤ –∫–æ–Ω—Ü–µ —Ä–∞—É–Ω–¥–∞.", resolved: false, solution: { resource: '–ò–ì', task: { question: "–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Ç–æ–∫ (–≤ –ê), –µ—Å–ª–∏ U=20 –í, R=4 –û–º. ($I = U / R$)", answer: "5", rewardMsg: "–ê–≤–∞—Ä–∏–π–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—â–µ–Ω.", penalty: { type: 'POWER', value: 5 } } } },
        'B': { name: "–ë–ò–û–õ–û–ì–ò–ß–ï–°–ö–ê–Ø –£–ì–†–û–ó–ê", flaw: "–°–Ω–∞–±–∂–µ–Ω–∏–µ –í–æ–¥–æ–π (H‚ÇÇO) –∏ –ü–∏—â–µ–π (FOOD) –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–æ.", resolved: false, solution: { resource: '–°–†–í', task: { question: "–ö–∞–∫–æ–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏—è–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–∏—Å–ª–æ—Ä–æ–¥?", answer: "—Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑", rewardMsg: "–°–∏—Å—Ç–µ–º–∞ —Ä–µ—Ü–∏—Ä–∫—É–ª—è—Ü–∏–∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞.", penalty: { type: 'WATER', value: 5 } } } },
        'C': { name: "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–û–ò–ù–ê", flaw: "50% —à–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å -10 –ó–¥–æ—Ä–æ–≤—å—è —Å –∫–∞–∂–¥—ã–º –¥–µ–π—Å—Ç–≤–∏–µ–º.", resolved: false, solution: { resource: '–ê–°–ì', task: { question: "–ö–∞–∫–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –¥–∞–µ—Ç —Å–ø–ª–∞–≤ –¢–∏—Ç–∞–Ω–∞ (–¢–¢) –¥–ª—è –∫–æ—Ä–ø—É—Å–∞?", answer: "—Å–≤–µ—Ä—Ö–ø—Ä–æ—á–Ω–æ—Å—Ç—å", rewardMsg: "–ü—Ä–æ–±–æ–∏–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞.", penalty: { type: 'HEALTH', value: 10 } } } }
    };

    const ROUND_6_CHALLENGE = {
        name: "–°–û–ó–î–ê–ù–ò–ï –°–í–ï–†–•–î–ê–õ–¨–ù–ï–ì–û –¢–†–ê–ù–°–ü–û–ù–î–ï–†–ê",
        flaw: "–¢–æ–ª—å–∫–æ –º–æ—â–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä –º–æ–∂–µ—Ç –ø—Ä–æ–±–∏—Ç—å –∏–æ–Ω–Ω—É—é –±—É—Ä—é –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª —Å–ø–∞—Å–µ–Ω–∏—è.",
        cost: [
            { code: '–§–°', amount: 2, group: 'A' }, 
            { code: '–ü–†', amount: 2, group: 'B' }, 
            { code: '–ó–°', amount: 2, group: 'C' }  
        ],
        task: {
            question: "–ö–∞–∫–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫ –æ—Ä–±–∏—Ç–∞–ª—å–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∫–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—á–µ—Å—Ç—å –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –æ–∫–Ω–∞ –∑–∞–ø—É—Å–∫–∞ —Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞–ø–ø–∞—Ä–∞—Ç–∞?",
            answer: "–æ—Ä–±–∏—Ç–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ",
            rewardMsg: "–†–∞—Å—á–µ—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –¢—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É.",
            penalty: { type: 'HEALTH', value: 15 }
        }
    };
    
    // --- 3. –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ---
    
    function updateResourceDisplay() {
        document.getElementById('resource-power').textContent = gameData.resources.POWER;
        document.getElementById('resource-water').textContent = gameData.resources.WATER;
        document.getElementById('resource-air').textContent = gameData.resources.AIR;
        document.getElementById('resource-health').textContent = gameData.resources.HEALTH;
        document.getElementById('resource-points').textContent = gameData.points;

        const inventoryList = document.getElementById('inventory-list');
        inventoryList.innerHTML = '';
        
        let hasInventory = false;
        for (const code in gameData.inventory) {
            const count = gameData.inventory[code];
            if (count > 0) {
                hasInventory = true;
                const res = RESOURCE_LOOKUP[code];
                const item = document.createElement('li');
                item.className = 'inventory-item';
                item.textContent = `${res.name} (${res.code} - –£${res.level}): ${count}`;
                inventoryList.appendChild(item);
            }
        }
        if (!hasInventory) {
             inventoryList.innerHTML = '<li class="inventory-item">–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤</li>';
        }
    }

    function logEvent(message, isError = false) {
        const logBox = document.getElementById('log-box');
        const p = document.createElement('p');
        p.innerHTML = `[${new Date().toLocaleTimeString('ru-RU', { hour12: false })}] ${message}`;
        if (isError) {
            p.classList.add('error');
        }
        logBox.prepend(p); 
        if (logBox.children.length > 20) {
            logBox.removeChild(logBox.lastChild);
        }
    }

    function updateGroupDisplay() {
        const activeGroupDisplay = document.getElementById('active-group-display');
        if (gameData.primaryGroup) {
            activeGroupDisplay.textContent = `${gameData.primaryGroup} (${RESOURCE_DATABASE[gameData.primaryGroup].name})`;
        } else {
            activeGroupDisplay.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
        }
    }

    // --- –§–ê–ó–ê –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–û–ì–û –í–´–ë–û–†–ê (ROUND 0) ---

    function setPrimaryGroup(group) {
        if (gameData.primaryGroup) return; // –ó–∞–ø—Ä–µ—Ç –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–±–æ—Ä
        
        gameData.primaryGroup = group;
        gameData.activeGroup = group; // –ê–∫—Ç–∏–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞ —Ç–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê –æ—Å–Ω–æ–≤–Ω–∞—è
        
        // 1. –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
        PRIMARY_GROUP_BONUS_RESOURCES[group].forEach(code => {
            gameData.inventory[code] = (gameData.inventory[code] || 0) + 2; // +2 –µ–¥. –£1
            logEvent(`–ë–û–ù–£–°: –û—Å–Ω–æ–≤–Ω–∞—è –ì—Ä—É–ø–ø–∞ ${group} –ø–æ–ª—É—á–∏–ª–∞ 2 –µ–¥. ${RESOURCE_LOOKUP[code].name} (${code}).`);
        });

        // 2. –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
        document.getElementById('pre-select-group-a').disabled = true;
        document.getElementById('pre-select-group-b').disabled = true;
        document.getElementById('pre-select-group-c').disabled = true;
        document.getElementById(`pre-select-group-${group.toLowerCase()}`).classList.add('active-group');

        // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        document.getElementById('group-selection-status').textContent = `‚úÖ –í–´–ë–†–ê–ù–ê –ü–û–°–¢–û–Ø–ù–ù–ê–Ø –ì–†–£–ü–ü–ê ${group} (${RESOURCE_DATABASE[group].name}). –ù–∞—á–∏–Ω–∞–µ–º –†–∞—É–Ω–¥ 1.`;
        
        // 4. –ü–µ—Ä–µ—Ö–æ–¥ –∫ –†–∞—É–Ω–¥—É 1 (–ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä—ã)
        document.getElementById('pre-game-selector').style.display = 'none';
        document.getElementById('main-game-interface').style.display = 'block';
        gameData.round = 1; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞—É–Ω–¥
        updateGroupDisplay();
        initRound1();
    }
    
    // --- –†–ê–£–ù–î 1 –õ–û–ì–ò–ö–ê (–ó–ê–ö–£–ü–ö–ê –∏ –î–û–ë–´–ß–ê –£1) ---
    function renderRound1Actions() { 
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        document.getElementById('action-prompt').textContent = `–î–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–ª–ª—ã: ${gameData.points}. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—É—Ä—Å –£1 –¥–ª—è –ø–æ–∫—É–ø–∫–∏ (–§–∞–∑–∞ 1/2).`;
        
        const level1Resources = Object.values(RESOURCE_DATABASE).flatMap(cat => cat.level1);

        level1Resources.forEach(res => {
            const price = RESOURCE_PRICES[res.code];
            const button = document.createElement('button');
            button.className = 'round-action-button';
            button.textContent = `–ö—É–ø–∏—Ç—å ${res.name} (${res.code}) | –¶–µ–Ω–∞: ${price} –±–∞–ª–ª–æ–≤`;
            
            button.onclick = () => buyResource(res.code, price);
            
            if (gameData.points < price) {
                button.disabled = true;
                button.title = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏.";
            }
            actionsDiv.appendChild(button);
        });

        const endBuyPhaseButton = document.createElement('button');
        endBuyPhaseButton.id = 'end-buy-phase';
        endBuyPhaseButton.textContent = '–ó–ê–í–ï–†–®–ò–¢–¨ –ó–ê–ö–£–ü–ö–£ –ò –ü–ï–†–ï–ô–¢–ò –ö –î–û–ë–´–ß–ï (–ó–ê–î–ê–ù–ò–ï)';
        endBuyPhaseButton.style.backgroundColor = '#f39c12';
        endBuyPhaseButton.onclick = startRound1TaskPhase;
        actionsDiv.appendChild(endBuyPhaseButton);
    }
    
    function buyResource(code, price) { 
        if (gameData.points >= price) {
            gameData.points -= price;
            gameData.inventory[code] = (gameData.inventory[code] || 0) + 1;
            logEvent(`–ü–æ–∫—É–ø–∫–∞: 1 –µ–¥. ${RESOURCE_LOOKUP[code].name} (${code}). –û—Å—Ç–∞–ª–æ—Å—å –±–∞–ª–ª–æ–≤: ${gameData.points}`);
            renderRound1Actions();
            updateResourceDisplay();
        } else {
            logEvent('–û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è —ç—Ç–æ–π –ø–æ–∫—É–ø–∫–∏!', true);
        }
    }

    function startRound1TaskPhase() { 
        if (gameData.taskCompleted) {
             logEvent('–§–∞–∑–∞ –¥–æ–±—ã—á–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É.', true);
             return;
        }

        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        document.getElementById('action-prompt').textContent = `–§–∞–∑–∞ 2/2: –î–û–ë–´–ß–ê. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –≤–∞—à–µ–π –ì—Ä—É–ø–ø–µ ${gameData.primaryGroup}, –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –£1 –∏ –±–∞–ª–ª–æ–≤.`;
        document.getElementById('action-header-text').textContent = `2. –§–ê–ó–ê –î–û–ë–´–ß–ò (–ó–ê–î–ê–ù–ò–ï)`;

        // --- –¢–û–õ–¨–ö–û –ó–ê–î–ê–ù–ò–ï –í–´–ë–†–ê–ù–ù–û–ô –ì–†–£–ü–ü–´ ---
        const task = ROUND_1_TASKS[gameData.primaryGroup];
        const taskElement = document.createElement('div');
        taskElement.style.marginBottom = '15px';
        taskElement.innerHTML = `
            <h3>–ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} | üí° –ó–∞–¥–∞–Ω–∏–µ: ${task.question}</h3>
            <input type="text" id="task-input-R1" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç (1-2 —Å–ª–æ–≤–∞)" style="width: 300px; padding: 8px; margin-right: 10px;">
            <button id="task-button-R1" onclick="submitRound1Task()">
                –í–´–ü–û–õ–ù–ò–¢–¨ | –ù–∞–≥—Ä–∞–¥–∞: ${task.reward.amount} –µ–¥. ${RESOURCE_LOOKUP[task.reward.code].name} (${task.reward.code}) –∏ ${task.points} –±–∞–ª–ª–æ–≤
            </button>
        `;
        actionsDiv.appendChild(taskElement);

        document.getElementById('end-round-button').disabled = true;
    }

    function submitRound1Task() { 
        if (gameData.taskCompleted) {
            logEvent('–ó–∞–¥–∞–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É.', true);
            return;
        }

        const task = ROUND_1_TASKS[gameData.primaryGroup];
        const input = document.getElementById(`task-input-R1`);
        const button = document.getElementById(`task-button-R1`);
        
        const answer = input.value.trim().toLowerCase().replace(/ /g, "");
        const expected = task.answer.toLowerCase().replace(/ /g, "");
        
        button.disabled = true;
        input.disabled = true;

        if (answer === expected) {
            gameData.inventory[task.reward.code] = (gameData.inventory[task.reward.code] || 0) + task.reward.amount;
            gameData.points += task.points;
            gameData.taskCompleted = true;

            logEvent(`‚úÖ –£–°–ü–ï–•! –ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –¥–æ–±—ã–ª–∞ 1 –µ–¥. ${task.reward.code} –∏ –ø–æ–ª—É—á–∏–ª–∞ ${task.points} –±–∞–ª–ª–æ–≤.`);
            document.getElementById('action-prompt').textContent = '–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –†–∞—É–Ω–¥—É 2.';
            document.getElementById('end-round-button').disabled = false;

        } else {
            logEvent(`‚ùå –ü–†–û–í–ê–õ. –ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –†–∞—É–Ω–¥–µ 2.`, true);
            document.getElementById('action-prompt').textContent = '–ó–∞–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–ª–µ–Ω–æ. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –†–∞—É–Ω–¥—É 2.';
            document.getElementById('end-round-button').disabled = false;
            gameData.taskCompleted = true; // –ó–∞–¥–∞–Ω–∏–µ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        }

        updateResourceDisplay();
    }


    function initRound1() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        
        logEvent('–°–ò–°–¢–ï–ú–ê: –ó–∞–ø—É—Å–∫ –ü—Ä–æ—Ç–æ–∫–æ–ª–∞ –†–∞—É–Ω–¥–∞ 1. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–∫—É–ø–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤ –£—Ä–æ–≤–Ω—è 1 (100 –ë–∞–ª–ª–æ–≤).');
        renderRound1Actions();
        updateResourceDisplay();
        document.getElementById('end-round-button').onclick = nextRound;
        document.getElementById('end-round-button').disabled = true;
    }
    
    // --- –†–ê–£–ù–î 2 –õ–û–ì–ò–ö–ê (–î–û–ë–û–† –£1 - –û–î–ù–ê –ì–†–£–ü–ü–ê) ---
    function initRound2() {
        gameData.taskCompleted = false; // –°–±—Ä–æ—Å –¥–ª—è –†2
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –î–û–ë–´–ß–ò –£1`;
        
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–ü–ï–†–ï–ô–¢–ò –ö 3)`;
        
        renderRound2Actions();
        logEvent(`–°–ò–°–¢–ï–ú–ê: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –†–∞—É–Ω–¥ 2. –ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞–Ω–∏–µ –¥–æ–±—ã—á–∏ —Ä–µ—Å—É—Ä—Å–∞ –£1.`);
    }
    
    function renderRound2Actions() {
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        
        if (gameData.taskCompleted) {
            actionsDiv.innerHTML = `<p style="text-align: center; color: #00ffaa;">–î–µ–π—Å—Ç–≤–∏–µ –ì—Ä—É–ø–ø—ã ${gameData.primaryGroup} –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ñ–¥–∏—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥–∞.</p>`;
            document.getElementById('end-round-button').disabled = false;
            return;
        }

        const task = ROUND_2_TASKS[gameData.primaryGroup];
        
        actionsDiv.innerHTML = `
            <h3>–ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} | üí° –ó–∞–¥–∞–Ω–∏–µ: ${task.question}</h3>
            <p>–ù–∞–≥—Ä–∞–¥–∞: 1 –µ–¥. ${RESOURCE_LOOKUP[task.reward.code].name} (${task.reward.code}).</p>
            <input type="text" id="task-input-R2" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç" style="width: 300px; padding: 8px; margin-right: 10px;">
            <button id="task-button-R2" onclick="submitRound2Task()">–í–´–ü–û–õ–ù–ò–¢–¨ –î–ï–ô–°–¢–í–ò–ï</button>
            <p class="error">–®—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç: -${task.penalty.value} ${task.penalty.type.toUpperCase()}</p>
        `;
        document.getElementById('end-round-button').disabled = true;
    }

    function submitRound2Task() {
        const input = document.getElementById('task-input-R2');
        const button = document.getElementById('task-button-R2');
        const task = ROUND_2_TASKS[gameData.primaryGroup];

        const answer = input.value.trim().toLowerCase().replace(/ /g, "");
        const expected = task.answer.toLowerCase().replace(/ /g, "");
        
        button.disabled = true;
        input.disabled = true;
        
        gameData.taskCompleted = true; // –î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
        
        if (answer.includes(expected) || expected.includes(answer)) { // –ë–æ–ª–µ–µ –º—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            gameData.inventory[task.reward.code] = (gameData.inventory[task.reward.code] || 0) + task.reward.amount;
            logEvent(`‚úÖ –£–°–ü–ï–•! –ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –¥–æ–±—ã–ª–∞ 1 –µ–¥. ${task.reward.code}.`);
        } else {
            const penaltyType = task.penalty.type;
            const penaltyValue = task.penalty.value;
            
            gameData.resources[penaltyType.toUpperCase()] -= penaltyValue; 
            
            logEvent(`‚ùå –ü–†–û–í–ê–õ. –ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –Ω–µ —Å–º–æ–≥–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ. –®—Ç—Ä–∞—Ñ: -${penaltyValue} ${penaltyType.toUpperCase()}!`, true);
        }
        
        updateResourceDisplay();
        document.getElementById('action-prompt').textContent = `–î–µ–π—Å—Ç–≤–∏–µ –ì—Ä—É–ø–ø—ã ${gameData.primaryGroup} –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –†–∞—É–Ω–¥—É 3.`;
        renderRound2Actions(); 
        document.getElementById('end-round-button').disabled = false;
    }

    // --- –†–ê–£–ù–î 3 –õ–û–ì–ò–ö–ê (–ö–†–ê–§–¢–ò–ù–ì –£2) ---
    function initRound3() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –ö–†–ê–§–¢–ò–ù–ì–ê –£2`;
        
        document.getElementById('action-prompt').textContent = `–ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –Ω–∞—á–∏–Ω–∞–µ—Ç –∫—Ä–∞—Ñ—Ç–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ –£—Ä–æ–≤–Ω—è 2.`;
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–ü–ï–†–ï–ô–¢–ò –ö 4)`;

        renderRound3Actions();
        logEvent(`–°–ò–°–¢–ï–ú–ê: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –†–∞—É–Ω–¥ 3. –ö—Ä–∞—Ñ—Ç–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ –£—Ä–æ–≤–Ω—è 2, –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ì—Ä—É–ø–ø—ã ${gameData.primaryGroup}.`);
        document.getElementById('end-round-button').disabled = false; // –†–∞–∑—Ä–µ—à–∞–µ–º —Å—Ä–∞–∑—É, —Ç.–∫. –∫—Ä–∞—Ñ—Ç–∏–Ω–≥ - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
    }
    
    function renderRound3Actions() {
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        
        const category = gameData.primaryGroup;
        const level2Resources = RESOURCE_DATABASE[category].level2;
        
        level2Resources.forEach(res => {
            const recipe = CRAFTING_RECIPES_R3[res.code];
            if (!recipe) return; 
            
            const neededText = recipe.map(r => `${r.amount} –µ–¥. ${RESOURCE_LOOKUP[r.code].name} (${r.code})`).join(', ');
            
            const button = document.createElement('button');
            button.className = 'round-action-button';
            button.textContent = `–ü—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ ${res.name} (${res.code}) | –¢—Ä–µ–±—É–µ—Ç—Å—è: ${neededText}`;
            
            button.onclick = () => tryCrafting(res.code, recipe, false);
            
            let canCraft = true;
            recipe.forEach(r => {
                if ((gameData.inventory[r.code] || 0) < r.amount) {
                    canCraft = false;
                }
            });

            if (!canCraft) {
                button.disabled = true;
                button.title = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –£1.";
            }

            actionsDiv.appendChild(button);
        });
    }
    
    function tryCrafting(outputCode, recipe, isR4 = false) {
        let missingResources = [];

        recipe.forEach(r => {
            if ((gameData.inventory[r.code] || 0) < r.amount) {
                missingResources.push({ code: r.code, needed: r.amount, have: (gameData.inventory[r.code] || 0) });
            }
        });

        if (missingResources.length > 0) {
            const missingText = missingResources.map(m => `${m.code} (–ù–∞–¥–æ: ${m.needed}, –ï—Å—Ç—å: ${m.have})`).join(', ');
            logEvent(`‚ùå –û–®–ò–ë–ö–ê –ö–†–ê–§–¢–ò–ù–ì–ê: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤. –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: ${missingText}.`, true);
            return;
        }

        recipe.forEach(r => {
            gameData.inventory[r.code] -= r.amount;
        });

        gameData.inventory[outputCode] = (gameData.inventory[outputCode] || 0) + 1;
        
        logEvent(`‚úÖ –£–°–ü–ï–•! –ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –ø—Ä–æ–∏–∑–≤–µ–ª–∞ 1 –µ–¥. ${RESOURCE_LOOKUP[outputCode].name} (${outputCode}).`);

        updateResourceDisplay();
        if (!isR4) {
            renderRound3Actions();
        } else {
            renderRound4Actions();
        }
    }

    // --- –†–ê–£–ù–î 4 –õ–û–ì–ò–ö–ê (–ö–†–ê–§–¢–ò–ù–ì –£3) ---
    function initRound4() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –ö–†–ê–§–¢–ò–ù–ì–ê –£3`;
        
        document.getElementById('action-prompt').textContent = `–ì—Ä—É–ø–ø–∞ ${gameData.primaryGroup} –Ω–∞—á–∏–Ω–∞–µ—Ç –∫—Ä–∞—Ñ—Ç–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º –£—Ä–æ–≤–Ω—è 3.`;
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–ü–ï–†–ï–ô–¢–ò –ö –ê–ü–û–ö–ê–õ–ò–ü–°–ò–°–£)`;
        
        renderRound4Actions();
        logEvent(`–°–ò–°–¢–ï–ú–ê: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –†–∞—É–Ω–¥ 4. –ö—Ä–∞—Ñ—Ç–∏–Ω–≥ –≥–æ—Ç–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –£—Ä–æ–≤–Ω—è 3, –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ì—Ä—É–ø–ø—ã ${gameData.primaryGroup}.`);
        document.getElementById('end-round-button').disabled = false;
    }

    function renderRound4Actions() {
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        
        const category = gameData.primaryGroup;
        const level3Resources = RESOURCE_DATABASE[category].level3;
        
        level3Resources.forEach(res => {
            const recipe = CRAFTING_RECIPES_R4[res.code];
            if (!recipe) return;

            const neededText = recipe.map(r => `${r.amount} –µ–¥. ${RESOURCE_LOOKUP[r.code].name} (${r.code})`).join(', ');
            
            const button = document.createElement('button');
            button.className = 'round-action-button';
            button.textContent = `–°–û–ó–î–ê–¢–¨: ${res.name} (${res.code}) | –¢—Ä–µ–±—É–µ—Ç—Å—è: ${neededText}`;
            
            button.onclick = () => tryCrafting(res.code, recipe, true); // True –¥–ª—è –£3
            
            let canCraft = true;
            recipe.forEach(r => {
                if ((gameData.inventory[r.code] || 0) < r.amount) {
                    canCraft = false;
                }
            });

            if (!canCraft) {
                button.disabled = true;
                button.title = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –£2.";
            }

            actionsDiv.appendChild(button);
        });
    }

    // --- –†–ê–£–ù–î 5 –õ–û–ì–ò–ö–ê (–ê–ü–û–ö–ê–õ–ò–ü–°–ò–° - –û–î–ò–ù –ö–†–ò–ó–ò–°) ---
    function initRound5() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –£–°–¢–†–ê–ù–ï–ù–ò–Ø –ö–†–ò–ó–ò–°–ê`;
        
        // –£—Ä–æ–Ω –æ—Ç –ê–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å–∞
        APOCALYPSE_PENALTIES.forEach(p => {
            gameData.resources[p.type.toUpperCase()] -= p.value;
            logEvent(`üö® –ö–†–ò–ó–ò–°–ù–´–ô –£–†–û–ù: -${p.value} ${p.type.toUpperCase()}. ${p.msg}`, true);
        });
        
        document.getElementById('action-prompt').textContent = `–†–ê–£–ù–î 5: –ö–†–ò–ó–ò–° –ê–ö–¢–ò–í–ù–û–ô –ì–†–£–ü–ü–´! –£—Å—Ç—Ä–∞–Ω–∏—Ç–µ —É–≥—Ä–æ–∑—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å –ì—Ä—É–ø–ø–æ–π ${gameData.primaryGroup}.`;
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–ü–ï–†–ï–ô–¢–ò –ö 6)`;
        
        CRISIS_DATABASE[gameData.primaryGroup].resolved = gameData.r5ResolvedGroups[gameData.primaryGroup]; // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å
        
        renderRound5Actions();
        logEvent(`–°–ò–°–¢–ï–ú–ê: –ó–∞–ø—É—â–µ–Ω –†–∞—É–Ω–¥ 5. –ö—Ä–∏–∑–∏—Å ${CRISIS_DATABASE[gameData.primaryGroup].name} –∞–∫—Ç–∏–≤–µ–Ω! –°—Ä–æ—á–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç–µ —É–≥—Ä–æ–∑—É!`, true);
        updateResourceDisplay();
    }
    
    function renderRound5Actions() {
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        
        const groupCode = gameData.primaryGroup;
        const crisis = CRISIS_DATABASE[groupCode];

        if (crisis.resolved) {
            document.getElementById('action-prompt').textContent = '–ö—Ä–∏–∑–∏—Å —É—Å–ø–µ—à–Ω–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞—É–Ω–¥.';
            actionsDiv.innerHTML = `<p style="text-align: center; color: #2ecc71;">‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É–≥—Ä–æ–∑–∞ ${crisis.name} —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞.</p>`;
            document.getElementById('end-round-button').disabled = false;
            return;
        }

        const resourceCode = crisis.solution.resource;
        const task = crisis.solution.task;
        const hasResource = (gameData.inventory[resourceCode] || 0) > 0;
        
        actionsDiv.innerHTML = `
            <h2>üö® –ö–†–ò–ó–ò–° –ì–†–£–ü–ü–´ ${groupCode}: ${crisis.name}</h2>
            <p class="error">**–£–ì–†–û–ó–ê:** ${crisis.flaw}</p>
            <p><strong>–ú–ï–¢–û–î–´ –£–°–¢–†–ê–ù–ï–ù–ò–Ø:</strong></p>
            
            ${hasResource ? `
                <button class="round-action-button" onclick="resolveCrisisResource('${groupCode}')" style="background: #2ecc71;">
                    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ${RESOURCE_LOOKUP[resourceCode].name} (${resourceCode}) (–°–ù–ò–ú–ê–ï–¢ –£–ì–†–û–ó–£)
                </button>
                <p>‚Äî –¢—Ä–µ–±—É–µ—Ç—Å—è: 1 –µ–¥. ${RESOURCE_LOOKUP[resourceCode].name}.</p>
            ` : `
                <button class="round-action-button" disabled style="background: #7f8c8d;">
                    –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: ${RESOURCE_LOOKUP[resourceCode].name} (${resourceCode}) (–†–µ—Å—É—Ä—Å –£3)
                </button>
            `}
            
            <hr style="border-top: 1px dashed #e74c3c; margin: 20px 0;">

            <h3>–†–£–ß–ù–û–ô –ü–†–û–¢–û–ö–û–õ: ${task.question}</h3>
            <input type="text" id="task-input-R5" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç (1-2 —Å–ª–æ–≤–∞)" style="width: 300px; padding: 8px; margin-right: 10px;">
            <button id="task-button-R5" onclick="resolveCrisisTask('${groupCode}')" style="background: #f1c40f; color: #0f0a05;">
                –í—ã–ø–æ–ª–Ω–∏—Ç—å –í—Ä—É—á–Ω—É—é
            </button>
            <p>‚Äî –ù–∞–≥—Ä–∞–¥–∞: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —É–≥—Ä–æ–∑—ã. –®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–≤–∞–ª: -${task.penalty.value} ${task.penalty.type.toUpperCase()}.</p>
        `;
        document.getElementById('end-round-button').disabled = true;
    }

    function resolveCrisis(groupCode, isSuccess) {
        const crisis = CRISIS_DATABASE[groupCode];
        
        if (isSuccess) {
            CRISIS_DATABASE[groupCode].resolved = true;
            gameData.r5ResolvedGroups[groupCode] = true;
            logEvent(`‚úÖ –£–ì–†–û–ó–ê –£–°–¢–†–ê–ù–ï–ù–ê: –ö—Ä–∏–∑–∏—Å ${crisis.name} —Ä–µ—à–µ–Ω.`, false);
        } else {
            const penaltyType = crisis.solution.task.penalty.type.toUpperCase();
            const penaltyValue = crisis.solution.task.penalty.value;
            gameData.resources[penaltyType] -= penaltyValue;
            logEvent(`‚ùå –ü–†–û–í–ê–õ: –†—É—á–Ω–æ–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è ${crisis.name} –Ω–µ —É–¥–∞–ª—Å—è. –®—Ç—Ä–∞—Ñ: -${penaltyValue} ${penaltyType}!`, true);
        }

        updateResourceDisplay();
        document.getElementById('end-round-button').disabled = false; // –ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –º–æ–∂–Ω–æ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ
        renderRound5Actions();
    }

    function resolveCrisisResource(groupCode) {
        const crisis = CRISIS_DATABASE[groupCode];
        const resourceCode = crisis.solution.resource;
        
        if ((gameData.inventory[resourceCode] || 0) > 0) {
            gameData.inventory[resourceCode] -= 1; 
            resolveCrisis(groupCode, true);
        } else {
            logEvent('–û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è!', true);
        }
    }

    function resolveCrisisTask(groupCode) {
        const task = CRISIS_DATABASE[groupCode].solution.task;
        const input = document.getElementById('task-input-R5');
        const button = document.getElementById('task-button-R5');
        const answer = input.value.trim().toLowerCase().replace(/ /g, "");
        const expected = task.answer.toLowerCase().replace(/ /g, "");

        button.disabled = true;
        input.disabled = true;
        
        if (answer.includes(expected) || expected.includes(answer)) {
            resolveCrisis(groupCode, true);
        } else {
            resolveCrisis(groupCode, false);
        }
    }

    // --- –†–ê–£–ù–î 6 –õ–û–ì–ò–ö–ê (–°–û–¢–†–£–î–ù–ò–ß–ï–°–¢–í–û) ---
    function initRound6() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(${gameData.round + 1})`;
        document.getElementById('action-header-text').textContent = `1. –§–ê–ó–ê –°–í–Ø–ó–ò –ò –°–ü–ê–°–ï–ù–ò–Ø`;
        
        document.getElementById('action-prompt').textContent = `–†–ê–£–ù–î 6: –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–¢–†–£–î–ù–ò–ß–ï–°–¢–í–û. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ—Å—É—Ä—Å—ã –£2 –æ—Ç –≤—Å–µ—Ö –≥—Ä—É–ø–ø –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¢—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä–∞.`;
        document.getElementById('end-round-button').textContent = `–ó–ê–í–ï–†–®–ò–¢–¨ –†–ê–£–ù–î ${gameData.round} (–§–ò–ù–ê–õ)`;
        
        renderRound6Actions();
        logEvent('–°–ò–°–¢–ï–ú–ê: –ó–∞–ø—É—â–µ–Ω –†–∞—É–Ω–¥ 6. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–±—Ä–∞—Ç—å –£2 —Ä–µ—Å—É—Ä—Å—ã –∏–∑ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –¢—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä–∞!', true);
        document.getElementById('end-round-button').disabled = gameData.r6Resolved ? false : true;
        updateResourceDisplay();
    }

    function renderRound6Actions() {
        const actionsDiv = document.getElementById('action-buttons');
        actionsDiv.innerHTML = '';
        
        const challenge = ROUND_6_CHALLENGE;
        let hasAllResources = true;
        let missingText = [];

        challenge.cost.forEach(item => {
            if ((gameData.inventory[item.code] || 0) < item.amount) {
                hasAllResources = false;
                missingText.push(`${item.code} (–ù–∞–¥–æ: ${item.amount}, –ï—Å—Ç—å: ${gameData.inventory[item.code] || 0})`);
            }
        });
        
        actionsDiv.innerHTML = `
            <h2>üì° ${challenge.name} (–ü–û–°–¢–†–û–ô–ö–ê)</h2>
            <p><strong>–¢–†–ï–ë–û–í–ê–ù–ò–Ø:</strong> –î–ª—è –ø–æ—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ—Ç –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã (–£—Ä–æ–≤–µ–Ω—å 2):</p>
            <ul>
                ${challenge.cost.map(item => `
                    <li>${item.amount} –µ–¥. ${RESOURCE_LOOKUP[item.code].name} (${item.code}) [–ì—Ä—É–ø–ø–∞ ${item.group}]</li>
                `).join('')}
            </ul>

            <hr style="border-top: 1px dashed #5dade2; margin: 20px 0;">

            ${hasAllResources ? `
                <button class="round-action-button" onclick="resolveRound6Resource()" style="background: #2ecc71;" ${gameData.r6Resolved ? 'disabled' : ''}>
                    –ü–û–°–¢–†–û–ò–¢–¨ –¢–†–ê–ù–°–ü–û–ù–î–ï–† (–ü–æ—Ç—Ä–∞—Ç–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª)
                </button>
            ` : (gameData.r6Resolved ? 
                `<button class="round-action-button" disabled style="background: #27ae60;">–¢–†–ê–ù–°–ü–û–ù–î–ï–† –£–ñ–ï –ü–û–°–¢–†–û–ï–ù</button>` :
                `<button class="round-action-button" disabled style="background: #e74c3c;">
                    –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –†–ï–°–£–†–°–û–í! –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: ${missingText.join('; ')}
                </button>
            `)}
            
            <hr style="border-top: 1px dashed #e74c3c; margin: 20px 0;">

            <h3>–†–£–ß–ù–û–ô –ü–†–û–¢–û–ö–û–õ (–ê–≤–∞—Ä–∏–π–Ω—ã–π –†–∞—Å—á–µ—Ç): ${challenge.task.question}</h3>
            <input type="text" id="task-input-R6" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç (1-2 —Å–ª–æ–≤–∞)" style="width: 300px; padding: 8px; margin-right: 10px;" ${gameData.r6Resolved ? 'disabled' : ''}>
            <button id="task-button-R6" onclick="resolveRound6Task()" style="background: #f1c40f; color: #0f0a05;" ${gameData.r6Resolved ? 'disabled' : ''}>
                –í—ã–ø–æ–ª–Ω–∏—Ç—å –ê–≤–∞—Ä–∏–π–Ω—ã–π –†–∞—Å—á–µ—Ç
            </button>
            <p>‚Äî –ù–∞–≥—Ä–∞–¥–∞: –£—Å–ø–µ—Ö –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö. –®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–≤–∞–ª: -${challenge.task.penalty.value} ${challenge.task.penalty.type.toUpperCase()}.</p>
        `;
        document.getElementById('end-round-button').disabled = gameData.r6Resolved ? false : true;
    }

    function resolveRound6Resource() {
        if (gameData.r6Resolved) return;
        const challenge = ROUND_6_CHALLENGE;
        
        challenge.cost.forEach(item => {
            gameData.inventory[item.code] -= item.amount;
        });

        gameData.r6Resolved = true; 
        logEvent(`‚úÖ –°–ò–ì–ù–ê–õ –£–°–ü–ï–•–ê: –°–≤–µ—Ä—Ö–¥–∞–ª—å–Ω–∏–π –¢—Ä–∞–Ω—Å–ø–æ–Ω–¥–µ—Ä –ø–æ—Å—Ç—Ä–æ–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω! –û–∂–∏–¥–∞–Ω–∏–µ —Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞–ø–ø–∞—Ä–∞—Ç–∞.`, false);
        
        gameData.resources.HEALTH += 20; 
        logEvent(`–ë–û–ù–£–°: –≠–∫–∏–ø–∞–∂ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. +20 –ó–¥–æ—Ä–æ–≤—å—è.`, false);
        
        updateResourceDisplay();
        renderRound6Actions(); 
        document.getElementById('end-round-button').disabled = false;
    }

    function resolveRound6Task() {
        if (gameData.r6Resolved) return;

        const task = ROUND_6_CHALLENGE.task;
        const input = document.getElementById('task-input-R6');
        const button = document.getElementById('task-button-R6');
        const answer = input.value.trim().toLowerCase().replace(/ /g, "");
        const expected = task.answer.toLowerCase().replace(/ /g, "");

        button.disabled = true;
        input.disabled = true;
        
        if (answer.includes(expected) || expected.includes(answer)) {
            gameData.r6Resolved = true; 
            logEvent(`‚úÖ –°–ò–ì–ù–ê–õ –£–°–ü–ï–•–ê: –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! –°–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.`, false);
        } else {
            const penaltyType = task.penalty.type.toUpperCase();
            const penaltyValue = task.penalty.value;
            gameData.resources[penaltyType] -= penaltyValue;
            
            logEvent(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ: –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–∞—Å—á–µ—Ç –Ω–µ —É–¥–∞–ª—Å—è. –®—Ç—Ä–∞—Ñ: -${penaltyValue} ${penaltyType}!`, true);
        }
        
        document.getElementById('end-round-button').disabled = false;
        updateResourceDisplay();
        renderRound6Actions();
    }

    // --- –†–ê–£–ù–î 7 –õ–û–ì–ò–ö–ê (–§–ò–ù–ê–õ) ---

    function initRound7() {
        document.getElementById('round-number').textContent = gameData.round;
        document.getElementById('next-round-indicator').textContent = `(–ó–ê–í–ï–†–®–ï–ù–ò–ï)`;
        document.getElementById('action-header-text').textContent = `1. –§–ò–ù–ê–õ–¨–ù–´–ô –ü–†–û–¢–û–ö–û–õ`;
        
        document.getElementById('end-round-button').textContent = '–ó–ê–í–ï–†–®–ò–¢–¨ –ú–ò–°–°–ò–Æ';
        
        document.getElementById('end-round-button').disabled = true; 

        if (gameData.r6Resolved) {
            document.getElementById('action-prompt').textContent = '–†–ê–£–ù–î 7: –§–ò–ù–ê–õ–¨–ù–´–ô –≠–¢–ê–ü. –°–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –°–ø–∞—Å–∞—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç –ø—Ä–∏–±—ã–≤–∞–µ—Ç. –ù–∞—á–Ω–∏—Ç–µ —ç–≤–∞–∫—É–∞—Ü–∏—é.';
            
            const actionsDiv = document.getElementById('action-buttons');
            actionsDiv.innerHTML = `
                <h2>üöÄ –§–ò–ù–ê–õ–¨–ù–´–ô –ü–†–û–¢–û–ö–û–õ: –≠–í–ê–ö–£–ê–¶–ò–Ø</h2>
                <p>–°–ø–∞—Å–∞—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –æ—Ä–±–∏—Ç–µ. –¢—Ä–µ–±—É–µ—Ç—Å—è <strong>10 –µ–¥. –≠–Ω–µ—Ä–≥–∏–∏</strong> –∏ <strong>5 –µ–¥. –í–æ–∑–¥—É—Ö–∞</strong> –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —á–µ–ª–Ω–æ–∫–∞ –∫ –∫–æ—Ä–∞–±–ª—é.</p>
                
                <button class="round-action-button" onclick="finalEvacuate()" style="background: #00b894; font-size: 1.2em;">
                    –ù–ê–ß–ê–¢–¨ –≠–í–ê–ö–£–ê–¶–ò–Æ
                </button>
            `;
        } else {
             document.getElementById('action-prompt').textContent = '–†–ê–£–ù–î 7: –§–ò–ù–ê–õ–¨–ù–´–ô –≠–¢–ê–ü. –°–∏–≥–Ω–∞–ª —Å–ø–∞—Å–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –í—Ä–µ–º—è –Ω–∞ –ú–∞—Ä—Å–µ –∏—Å—Ç–µ–∫–∞–µ—Ç...';
             document.getElementById('action-buttons').innerHTML = `
                <p class="error">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –°–∏–≥–Ω–∞–ª –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ú–∏—Å—Å–∏—è –ø—Ä–æ–≤–∞–ª–µ–Ω–∞.</p>
             `;
             document.getElementById('game-over-message').textContent = '–ú–ò–°–°–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê. –°–ò–ì–ù–ê–õ –°–ü–ê–°–ï–ù–ò–Ø –ù–ï –û–¢–ü–†–ê–í–õ–ï–ù.';
             document.getElementById('game-over-message').style.display = 'block';
        }

        logEvent('–°–ò–°–¢–ï–ú–ê: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –†–∞—É–Ω–¥ 7. –§–ò–ù–ê–õ–¨–ù–ê–Ø –§–ê–ó–ê.', true);
    }

    function finalEvacuate() {
        const requiredPower = 10;
        const requiredAir = 5;

        if (gameData.resources.POWER >= requiredPower && gameData.resources.AIR >= requiredAir) {
            gameData.resources.POWER -= requiredPower;
            gameData.resources.AIR -= requiredAir;
            
            logEvent('‚úÖ –≠–í–ê–ö–£–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê: –®–∞—Ç—Ç–ª –∑–∞–ø—É—â–µ–Ω. –≠–∫–∏–ø–∞–∂ –Ω–∞ –ø—É—Ç–∏ –¥–æ–º–æ–π!', false);
            
            document.getElementById('game-over-message').textContent = '–ú–ò–°–°–ò–Ø –í–´–ü–û–õ–ù–ï–ù–ê. –≠–ö–ò–ü–ê–ñ –°–ü–ê–°–ï–ù.';
            document.getElementById('game-over-message').style.display = 'block';
            document.getElementById('action-buttons').innerHTML = '';
            
            document.getElementById('end-round-button').disabled = true; 

        } else {
            logEvent(`‚ùå –û–¢–ú–ï–ù–ê –≠–í–ê–ö–£–ê–¶–ò–ò: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —á–µ–ª–Ω–æ–∫–∞. –ù—É–∂–Ω–æ ${requiredPower} –≠–Ω–µ—Ä–≥–∏–∏ (–µ—Å—Ç—å ${gameData.resources.POWER}) –∏ ${requiredAir} –í–æ–∑–¥—É—Ö–∞ (–µ—Å—Ç—å ${gameData.resources.AIR}).`, true);
            
            // –ï—Å–ª–∏ —ç–≤–∞–∫—É–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, —ç—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ—Ä–∞–∂–µ–Ω–∏–µ–º
            document.getElementById('game-over-message').textContent = '–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ö–ê–ó. –≠–í–ê–ö–£–ê–¶–ò–Ø –ù–ï–í–û–ó–ú–û–ñ–ù–ê. –ú–ò–°–°–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê.';
            document.getElementById('game-over-message').style.display = 'block';
            document.getElementById('action-buttons').innerHTML = '';
            document.getElementById('end-round-button').disabled = true;
        }
        updateResourceDisplay();
    }


    // --- –ì–õ–û–ë–ê–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï ---
    
    function nextRound() {
        if (gameData.round >= 7) return; 

        // 1. –£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        gameData.resources.WATER -= 5;
        gameData.resources.AIR -= 5;
        
        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ—Ä–∞–∂–µ–Ω–∏–µ
        if (gameData.resources.WATER <= 0 || gameData.resources.AIR <= 0 || gameData.resources.HEALTH <= 0) {
            document.getElementById('game-over-message').textContent = '–ú–ò–°–°–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ö–ê–ó –°–ò–°–¢–ï–ú –ñ–ò–ó–ù–ï–û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø.';
            document.getElementById('game-over-message').style.display = 'block';
            document.getElementById('end-round-button').disabled = true;
            logEvent('–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ö–ê–ó: –†–µ—Å—É—Ä—Å—ã –∂–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏—Å—á–µ—Ä–ø–∞–Ω—ã. –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.', true);
            updateResourceDisplay();
            return;
        }

        // 3. –ü–†–û–í–ï–†–ö–ê –ö–†–ò–ó–ò–°–ê –í –ö–û–ù–¶–ï –†–ê–£–ù–î–ê 5
        if (gameData.round === 5) {
            const groupCode = gameData.primaryGroup;
            const crisis = CRISIS_DATABASE[groupCode];
            
            if (!crisis.resolved) {
                logEvent(`‚ö†Ô∏è –û–°–¢–ê–í–®–ï–ï–°–Ø –ü–û–í–†–ï–ñ–î–ï–ù–ò–ï: –ö—Ä–∏–∑–∏—Å "${crisis.name}" –Ω–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω. –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è!`, true);
                if (crisis.name === "–≠–ù–ï–†–ì–ï–¢–ò–ß–ï–°–ö–ò–ô –®–¢–û–†–ú") {
                     gameData.resources.POWER -= 10;
                     logEvent('–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –®–¢–†–ê–§: -10 –≠–Ω–µ—Ä–≥–∏–∏ –∏–∑-–∑–∞ –Ω–µ—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –®—Ç–æ—Ä–º–∞.', true);
                }
                 // –î–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ –¥—Ä—É–≥–∏–µ —à—Ç—Ä–∞—Ñ—ã, –µ—Å–ª–∏ –∫—Ä–∏–∑–∏—Å—ã –Ω–µ —Ä–µ—à–µ–Ω—ã
            }
        }

        // 4. –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É
        gameData.round++;
        logEvent(`--- –£–°–ü–ï–®–ù–´–ô –ü–ï–†–ï–•–û–î –ö –†–ê–£–ù–î–£ ${gameData.round}! ---`, true);
        
        // 5. –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞—É–Ω–¥–∞ –∏ –∑–∞–ø—É—Å–∫
        gameData.taskCompleted = false;
        
        if (gameData.round === 2) {
            initRound2();
        } else if (gameData.round === 3) {
            initRound3();
        } else if (gameData.round === 4) {
            initRound4();
        } else if (gameData.round === 5) {
            initRound5();
        } else if (gameData.round === 6) {
            initRound6();
        } else if (gameData.round === 7) {
            initRound7();
        }
        
        updateResourceDisplay(); 
    }
    
    function initGame() {
        // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã: –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã
        document.getElementById('main-game-interface').style.display = 'none';
        document.getElementById('pre-game-selector').style.display = 'block';
        logEvent('–°–ò–°–¢–ï–ú–ê: –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–∏—Å—Å–∏–∏.', true);
    }

    window.onload = initGame;
    </script>

</body>
</html>
