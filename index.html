
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ПРОТОКОЛ: ЭКСПЕДИЦИЯ АРЕС</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- МАРСИАНСКИЙ СТИЛЬ: ТЕРМИНАЛ --- */
        body { 
            font-family: 'Orbitron', sans-serif;
            background: #0f0a05; /* Почти черный, как вакуум */
            color: #e7825d; /* Ржаво-красный/оранжевый для основного текста */
            padding: 20px; 
            line-height: 1.6;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 40px; 
            background: rgba(25, 10, 5, 0.95); 
            border: 5px solid #c0392b; /* Критический контур */
            border-radius: 5px; 
            box-shadow: 0 0 30px #e74c3c, inset 0 0 10px #c0392b;
        }
        
        /* ЗАГОЛОВКИ */
        h1 { color: #f1c40f; text-align: center; text-shadow: 0 0 10px #f1c40f; font-size: 2.2em; }
        h2 { color: #5dade2; border-bottom: 2px dashed #e74c3c; padding-bottom: 10px; margin-top: 30px; }
        h3 { color: #2ecc71; margin-top: 20px; font-size: 1.1em; }
        
        /* ОСНОВНЫЕ БЛОКИ */
        .intro, .round-content, .status-panel { 
            margin-bottom: 25px; 
            padding: 20px; 
            border: 1px solid rgba(231, 76, 60, 0.5); 
            border-radius: 5px; 
            background: rgba(18, 5, 5, 0.3); 
        }

        /* ПАНЕЛЬ СТАТУСА */
        .status-panel { display: flex; justify-content: space-between; align-items: flex-start; }
        .info-block { flex: 1; margin-right: 20px; }
        .status-panel p { margin: 5px 0; }
        
        /* ДИСПЛЕЙ РЕСУРСОВ */
        .inventory-list { 
            list-style-type: none; 
            padding: 0; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px;
        }
        .inventory-item { 
            padding: 6px 12px; 
            border-radius: 4px; 
            background: #5a2e28; /* Темно-красный */
            color: #fdfefe; 
            font-weight: bold; 
            font-size: 0.9em;
            border: 1px solid #e74c3c;
        }

        /* ЖУРНАЛ СИСТЕМЫ */
        .log-box { 
            margin-top: 25px; 
            background: #0f0a05; 
            padding: 15px; 
            height: 150px; 
            overflow-y: scroll; 
            border-radius: 5px; 
            font-size: 0.85em; 
            border: 1px solid #7f8c8d;
            color: #ecf0f1; /* Светлый текст */
        }
        .log-box p { margin: 3px 0; }
        .log-box .error { color: #e74c3c; font-weight: bold; }
        
        /* КНОПКИ */
        button { 
            padding: 10px 18px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 6px; 
            font-weight: bold; 
            background: #34495e; /* Темно-синий/серый */
            color: #ecf0f1; 
            transition: background 0.2s; 
            box-shadow: 0 3px #2c3e50; 
        }
        button:hover:not(:disabled) { background: #3b536b; transform: translateY(1px); box-shadow: 0 2px #2c3e50; }
        button:disabled { background: #402020; cursor: not-allowed; opacity: 0.6; box-shadow: none;}
        
        /* Специальные кнопки */
        .group-select button { width: 30%; background: #c0392b; box-shadow: 0 4px #a93226; color: #fdfefe; }
        .group-select button:hover { background: #e74c3c; }
        .round-action-button { background: #2ecc71; box-shadow: 0 4px #27ae60; }
        .round-action-button:hover { background: #27ae60; }
        .end-round-button { background: #e74c3c; box-shadow: 0 4px #c0392b; }
        .end-round-button:hover { background: #c0392b; }

        /* Таблица закупок */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #0f0a05; }
        th, td { border: 1px solid #c0392b; padding: 10px; text-align: left; }
        th { background: #5a2e28; color: #f1c40f; }

        /* Панель Ведущего/Протокол Связи */
        .mod-panel { 
            margin-top: 30px; 
            padding: 20px; 
            background: rgba(5, 5, 20, 0.7);
            border-radius: 5px; 
            border: 1px solid #5dade2;
        }
        #mod-input { 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid #7f8c8d; 
            margin-right: 10px; 
            background: #0f0a05; 
            color: #e7825d; 
            width: 350px;
        }
        .final-message { 
            padding: 25px; 
            background: #1a5e37; 
            color: #fdfefe; 
            border-radius: 5px; 
            font-size: 1.4em; 
            font-weight: bold;
            text-align: center;
            box-shadow: 0 0 20px #2ecc71;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>🛰️ ПРОТОКОЛ: ЭКСПЕДИЦИЯ АРЕС 7</h1>
        
        <div id="game-area">
            
            <div class="intro" id="intro-screen">
                <h2>СБОЙ. СИСТЕМА ВОССТАНОВЛЕНА.</h2>
                <p>Орбитальный модуль потерян. Вы — единственная команда, способная восстановить связь с Землей. Марс — ваш дом на ближайшие недели. Для запуска миссии требуется **ИНИЦИАЛИЗАЦИЯ ГРУППЫ**.</p>
                <p>Выберите вашу специализацию. Вы получите **100 Кредитов (КР)** на экстренную закупку и **бонусный стартовый ресурс**.</p>
                
                <div class="group-select" style="margin-top: 20px; display: flex; justify-content: space-around;">
                    <button onclick="startGame('Technocrats')">🛠️ Технократы</button>
                    <button onclick="startGame('Bioengineers')">🧪 Биоинженеры</button>
                    <button onclick="startGame('Constructors')">🧱 Конструкторы</button>
                </div>
            </div>

            <div id="game-round" style="display:none;">
                <h2 id="round-title"></h2>
                
                <div class="status-panel">
                    <div class="info-block">
                        <h3>Группа: <span id="player-group-name" style="color: #5dade2;"></span></h3>
                        <p>Жизнеобеспечение (HP): <span id="res-hp" style="color: #e74c3c; font-weight: bold;"></span></p>
                        <p>Кредиты (КР): <span id="res-credits" style="color: #f1c40f; font-weight: bold;"></span></p>
                        <p>Действий осталось: <span id="actions-remaining" style="color: #2ecc71; font-weight: bold;"></span> / 3</p>
                    </div>
                    <div>
                        <h3>Инвентарь (Ключевые Ресурсы):</h3>
                        <ul class="inventory-list" id="inventory-list-display"></ul>
                    </div>
                </div>

                <div class="round-content" id="round-description"></div>

                <div class="action-area" id="action-area"></div>
                
                <div class="log-box">
                    **СИСТЕМНЫЙ ЖУРНАЛ**
                    <div id="game-log"></div>
                </div>

                <div class="mod-panel">
                    <h4>📡 ПРОТОКОЛ СВЯЗИ (КОМАНДЫ ВЕДУЩЕГО)</h4>
                    <p style="color: #e7825d; font-size: 0.9em;">Форматы: **КРАФТ M/W/K** (промежуточный) | **СБОР** (финальный Маяк) | **ОТДАТЬ/ПОЛУЧИТЬ [код] [кол-во]**</p>
                    <input type="text" id="mod-input" placeholder="Введите команду: КРАФТ, СБОР, ОТДАТЬ, ПОЛУЧИТЬ...">
                    <button onclick="processModCommand()" style="background: #5dade2; box-shadow: 0 4px #3498db;">ВВОД КОМАНДЫ</button>
                    <button onclick="checkNextRound()" class="end-round-button">ЗАВЕРШИТЬ ЦИКЛ (СПИСАНИЕ HP)</button>
                </div>
            </div>
            
            <div id="game-over" style="display:none; text-align: center;">
                 <h2 style="color: #e74c3c; font-size: 2em;">🔴 КАТАСТРОФИЧЕСКИЙ СБОЙ</h2>
                 <p id="game-over-message" style="font-size: 1.3em; color: #f1c40f;"></p>
            </div>
        </div>
    </div>

    <script>
        // --- ДАННЫЕ ИГРЫ (Коды оставлены для работы логики JS) ---
        const RESOURCES = {
            // Базовые ресурсы (5 шт)
            E: { name: 'Энергоячейка', code: 'E', icon: '⚡', cost: 10 },
            B: { name: 'Биомасса', code: 'B', icon: '🌱', cost: 10 },
            S: { name: 'Композитный Сплав', code: 'S', icon: '🔩', cost: 10 },
            L: { name: 'Гидро-Реагент', code: 'L', icon: '💧', cost: 15 },
            F: { name: 'Изоволокно', code: 'F', icon: '🧶', cost: 15 },
            
            // Промежуточные/Контрактные ресурсы (4 шт)
            M: { name: 'Крио-Модуль', code: 'M', icon: '❄️', cost: 30 },
            W: { name: 'Синтезатор Воды', code: 'W', icon: '🌊', cost: 30 },
            K: { name: 'Гермо-Контейнер', code: 'K', icon: '📦', cost: 30 },
            Z: { name: 'Оптический Кабель', code: 'Z', icon: '🔗', cost: 30 }, 
            
            // Финальный ресурс
            P: { name: 'Маяк Спасения', code: 'P', icon: '🛰️', cost: 0 },
            
            // Статус
            HP: { name: 'Жизнеобеспечение', code: 'HP', icon: '❤️', cost: 0 },
            CR: { name: 'Кредиты', code: 'CR', icon: '💰', cost: 0 }
        };
        
        const GROUP_NAMES = {
            Technocrats: '🛠️ Технократы', 
            Bioengineers: '🧪 Биоинженеры', 
            Constructors: '🧱 Конструкторы'
        };

        const ROUND_TITLES = [
            "Инициализация Миссии",
            "ЦИКЛ 1: АВАРИЙНАЯ ЗАКУПКА",
            "ЦИКЛ 2: РАЗВЕДКА И ОПТИМИЗАЦИЯ",
            "ЦИКЛ 3: ЛОКАЛИЗАЦИЯ СБОЯ",
            "ЦИКЛ 4: НЕИЗВЕСТНЫЙ АРТЕФАКТ",
            "ЦИКЛ 5: УКРЕПЛЕНИЕ ПЕРЕД БУРЕЙ",
            "ЦИКЛ 6: ПОДГОТОВКА И КОНТРАКТ",
            "ЦИКЛ 7: ФИНАЛЬНАЯ СБОРКА МАЯКА"
        ];
        
        const CRAFT_COSTS = {
            M: { E: 3, B: 2 }, // Крио-Модуль: Энергия + Биомасса
            W: { B: 3, S: 2 }, // Синтезатор Воды: Биомасса + Сплав
            K: { S: 3, L: 2 }, // Гермо-Контейнер: Сплав + Реагент
            P: { M: 1, W: 1, K: 1, Z: 1 } // Маяк: M+W+K+Z (Финальная сборка)
        };

        let gameState = {
            group: null,
            inventory: { 
                E: 0, B: 0, S: 0, L: 0, F: 0, 
                M: 0, W: 0, K: 0, Z: 0, P: 0, 
                HP: 15, CR: 100 
            }, 
            currentRound: 0,
            actionsTaken: 0,
            maxActions: 3,
            historyLog: [] // Для финального статуса
        };

        // --- УПРАВЛЕНИЕ ИГРОЙ ---

        function updateLog(message, isError = false) {
            const logBox = document.getElementById('game-log');
            const prefix = isError ? '<span class="error">🚨</span>' : '✅';
            const coloredMessage = isError ? `<p class="error">${prefix} ${message}</p>` : `<p>${prefix} ${message}</p>`;
            logBox.innerHTML += coloredMessage;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function takeAction() {
            if (gameState.actionsTaken >= gameState.maxActions) {
                updateLog("🚨 КРИТИЧЕСКИЙ ЛИМИТ: Максимальное количество действий (3) в этом цикле достигнуто.", true);
                return false;
            }
            gameState.actionsTaken++;
            document.getElementById('actions-remaining').textContent = gameState.maxActions - gameState.actionsTaken;
            return true;
        }

        function checkNextRound() {
            if (gameState.currentRound === 1) { // Проверка на Раунд 1 (закупка)
                if (gameState.inventory.CR > 0) {
                    updateLog("⚠️ Протокол: Закупка завершена с оставшимися Кредитами. Они сгорают.", true);
                    gameState.inventory.CR = 0; // Сгорание КР после Раунда 1
                }
            } else if (gameState.currentRound !== 7 && gameState.actionsTaken < gameState.maxActions) {
                updateLog("🚨 ПРЕДУПРЕЖДЕНИЕ: Вы не использовали все 3 действия этого цикла. Вы уверены, что хотите перейти к списанию HP?", true);
                // Не блокируем, но предупреждаем
            }
            
            if (gameState.currentRound === 7) return; 

            // Списание HP 
            const hpLoss = 3; 
            gameState.inventory.HP -= hpLoss;
            updateLog(`--- ИНФРАКРАСНЫЙ ОТЧЕТ: КОНЕЦ ЦИКЛА ${gameState.currentRound} ---`);
            updateLog(`💔 Списание Жизнеобеспечения: -${hpLoss} HP. Текущий HP: ${gameState.inventory.HP}`);

            if (gameState.inventory.HP <= 0) {
                gameOver("Критический сбой жизнеобеспечения. Миссия Арес 7 завершена провалом.");
                return;
            }
            
            // Переход к следующему раунду
            gameState.currentRound++;
            gameState.actionsTaken = 0; // Сброс действий
            updateLog(`=== ПЕРЕХОД: ${ROUND_TITLES[gameState.currentRound]} ===`);
            loadRound(gameState.currentRound);
            updateUI();
        }

        function gameOver(message) {
            document.getElementById('game-round').style.display = 'none';
            document.getElementById('game-over').style.display = 'block';
            document.getElementById('game-over-message').textContent = message;
        }

        // --- UI И ИНИЦИАЛИЗАЦИЯ ---

        function updateUI() {
            document.getElementById('player-group-name').textContent = GROUP_NAMES[gameState.group];
            document.getElementById('res-hp').textContent = gameState.inventory.HP;
            document.getElementById('res-credits').textContent = gameState.inventory.CR;
            document.getElementById('actions-remaining').textContent = gameState.maxActions - gameState.actionsTaken;
            
            // Список инвентаря
            const inventoryList = document.getElementById('inventory-list-display');
            let html = '';
            
            // Фильтруем и сортируем: Базовые, Промежуточные, кроме HP/CR/P
            const orderedKeys = Object.keys(RESOURCES).filter(k => gameState.inventory[k] > 0 && k !== 'HP' && k !== 'CR' && k !== 'P').sort((a, b) => {
                const isBaseA = ['E', 'B', 'S', 'L', 'F'].includes(a);
                const isBaseB = ['E', 'B', 'S', 'L', 'F'].includes(b);
                if (isBaseA && !isBaseB) return -1; // Базовые идут раньше
                if (!isBaseA && isBaseB) return 1;
                return a.localeCompare(b);
            });
            
            orderedKeys.forEach(code => {
                const count = gameState.inventory[code];
                const res = RESOURCES[code];
                html += `<li class="inventory-item">${res.icon} ${res.name} (${count})</li>`;
            });
            
            // Добавляем Маяк Спасения, если собран
            if (gameState.inventory.P > 0) {
                html += `<li class="inventory-item" style="background: #2ecc71; border-color: #f1c40f;">${RESOURCES.P.icon} ${RESOURCES.P.name} (Готов)</li>`;
            }
            
            inventoryList.innerHTML = html || '<li class="inventory-item" style="background: #e74c3c;">ИНВЕНТАРЬ ПУСТ</li>';
        }

        function startGame(groupName) {
            gameState.group = groupName;
            gameState.currentRound = 1;

            // Начисление бонусного ресурса
            let bonusCode = '';
            if (groupName === 'Technocrats') { bonusCode = 'E'; }
            else if (groupName === 'Bioengineers') { bonusCode = 'B'; }
            else if (groupName === 'Constructors') { bonusCode = 'S'; }
            
            if (bonusCode) {
                gameState.inventory[bonusCode]++;
                updateLog(`Получен стартовый бонус: **1 ${RESOURCES[bonusCode].icon} ${RESOURCES[bonusCode].name}**.`);
            }

            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('game-round').style.display = 'block';
            
            updateLog(`Группа **${GROUP_NAMES[groupName]}** активирована. Доступен ЦИКЛ 1.`);
            updateUI();
            loadRound(1);
        }
        
        // --- ЦИКЛ 1: ЗАКУПКА И ЗАРАБОТОК ---

        function buyResource(code) {
            const res = RESOURCES[code];
            if (gameState.currentRound !== 1) {
                updateLog("🚨 Закупка возможна только в ЦИКЛЕ 1.", true);
                return;
            }
            if (gameState.inventory.CR < res.cost) {
                updateLog(`🚨 КРЕДИТНЫЙ СБОЙ: Недостаточно кредитов. Требуется ${res.cost} КР для покупки ${res.name}.`, true);
                return;
            }
            
            gameState.inventory.CR -= res.cost;
            gameState.inventory[code]++;
            updateLog(`✅ АКТИВ ПОСТУПИЛ: Куплен 1 ${res.icon} ${res.name}. Остаток: ${gameState.inventory.CR} КР.`);
            loadRound(1); // Перезагружаем UI раунда для обновления кнопок заработка/покупки
            updateUI();
        }
        
        // ФУНКЦИЯ: Заработок Кредитов
        function earnCredits(amount) {
            if (gameState.currentRound !== 1) {
                updateLog("🚨 Заработок кредитов возможен только в ЦИКЛЕ 1 (Закупка).", true);
                return;
            }
            if (gameState.inventory.CR >= 10 && amount > 0) {
                updateLog("🚨 БЛОКИРОВКА: Ваш текущий баланс позволяет купить самый дешевый ресурс (10 КР). Пожалуйста, совершите покупку.", true);
                return;
            }
            
            const group = gameState.group;
            let taskName = "";

            if (group === 'Technocrats') {
                taskName = amount === 5 ? `Настройка энергосети` : `Ремонт резервного генератора`;
            } else if (group === 'Bioengineers') {
                taskName = amount === 5 ? `Сбор образцов почвы` : `Анализ биотехнологического сбоя`;
            } else if (group === 'Constructors') {
                taskName = amount === 5 ? `Дозаправка ровера` : `Устранение микротрещин в корпусе`;
            }
            
            gameState.inventory.CR += amount;
            updateLog(`✅ ЗАДАНИЕ ВЫПОЛНЕНО: "${taskName}". Получено **+${amount} Кредитов**. Баланс: ${gameState.inventory.CR} КР.`);
            loadRound(1); // Reload UI
            updateUI();
        }

        // --- ЛОГИКА ВЕДУЩЕГО (ПРОТОКОЛ СВЯЗИ) ---

        function processModCommand() {
            const input = document.getElementById('mod-input').value.trim().toLowerCase();
            const words = input.split(' ');
            document.getElementById('mod-input').value = '';

            // 1. КРАФТ [код]
            if (words[0] === 'крафт' && words.length === 2) {
                const resCode = words[1].toUpperCase();
                if (['M', 'W', 'K'].includes(resCode)) {
                    craftIntermediate(resCode);
                    return;
                }
            }
            
            // 2. СБОР (Финальная сборка маяка)
            if (words[0] === 'сбор' && gameState.currentRound === 7) {
                assembleBeacon();
                return;
            }

            // 3. ОТДАТЬ / ПОЛУЧИТЬ [код] [кол-во] (Модерирование обмена)
            if ((words[0] === 'отдать' || words[0] === 'получить') && words.length === 3) {
                const action = words[0];
                const resCode = words[1].toUpperCase();
                const amount = parseInt(words[2]);

                if (RESOURCES[resCode] && !isNaN(amount) && amount > 0 && resCode !== 'HP' && resCode !== 'CR' && resCode !== 'P') {
                    const res = RESOURCES[resCode];
                    if (action === 'отдать') {
                        if (gameState.inventory[resCode] >= amount) {
                            gameState.inventory[resCode] -= amount;
                            updateLog(`[СВЯЗЬ] Передача: **-${amount} ${res.icon} ${res.name}**.`);
                        } else {
                            updateLog(`🚨 КРИТИЧЕСКИЙ ОТКАЗ: Недостаточно ${res.icon} ${res.name} для передачи.`, true);
                        }
                    } else if (action === 'получить') {
                        gameState.inventory[resCode] += amount;
                        updateLog(`[СВЯЗЬ] Получение: **+${amount} ${res.icon} ${res.name}**.`);
                    }
                    updateUI();
                    return;
                }
            }
            
            if (input) updateLog("🚨 ОШИБКА ПРОТОКОЛА: Неверная или недопустимая команда.", true);
        }

        // --- ЛОГИКА ДЕЙСТВИЙ (КРАФТ) ---

        function craftIntermediate(resCode) {
            const cost = CRAFT_COSTS[resCode];
            const resultRes = RESOURCES[resCode];
            let canCraft = true;

            for (const res in cost) {
                if (gameState.inventory[res] < cost[res]) {
                    updateLog(`🚨 КРАФТ ОТМЕНЕН: Не хватает ${RESOURCES[res].icon} ${RESOURCES[res].name} (${cost[res]} шт.).`, true);
                    canCraft = false;
                    break;
                }
            }

            if (canCraft) {
                for (const res in cost) {
                    gameState.inventory[res] -= cost[res];
                }
                gameState.inventory[resCode]++;
                updateLog(`🎉 УСПЕШНЫЙ КРАФТ: Создан **1 ${resultRes.icon} ${resultRes.name}**.`);
            }
            updateUI();
        }

        // --- ЛОГИКА ДЕЙСТВИЙ (ЦИКЛЫ 2-6) ---

        function applyRoundAction(actionCode) {
            if (gameState.currentRound === 1 || gameState.currentRound === 7) return;
            if (actionCode === 'Craft_M_W_K' || actionCode === 'Trade') {
                updateLog("💬 Это действие выполняется через **Протокол Связи** (команды Ведущего).", false);
                return;
            }

            if (!takeAction()) return;
            
            let statusChange = 0;
            let message = "";
            let hpChange = 0;
            let resChange = {}; // Изменения ресурсов
            
            const group = gameState.group;

            // --- ЦИКЛ 2: РАЗВЕДКА И ОПТИМИЗАЦИЯ (СВОЕ ЗАДАНИЕ) ---
            if (gameState.currentRound === 2) { 
                if (group === 'Technocrats') {
                    if (actionCode === 'Opt_E') { 
                        if (gameState.inventory.E >= 1) { gameState.inventory.E--; resChange.Z = 1; statusChange = 1; message = `Оптимизация Энергоячейки. Получен ${RESOURCES.Z.icon} ${RESOURCES.Z.name} (+1). +1 Статус.`; }
                        else { hpChange = -1; message = "Сбой оптимизации: нет Энергоячейки. -1 HP."; }
                    } else if (actionCode === 'Rec_S') { // Случайный сбор
                        resChange.S = 2; message = `Анализ почвы. Получено ${RESOURCES.S.icon} ${RESOURCES.S.name} (+2).`;
                    }
                } else if (group === 'Bioengineers') {
                    if (actionCode === 'Opt_B') { 
                        if (gameState.inventory.B >= 1) { gameState.inventory.B--; resChange.L = 1; statusChange = 1; message = `Запуск Гидропоники. Получен ${RESOURCES.L.icon} ${RESOURCES.L.name} (+1). +1 Статус.`; }
                        else { hpChange = -1; message = "Сбой гидропоники: нет Биомассы. -1 HP."; }
                    } else if (actionCode === 'Rec_F') { // Случайный сбор
                        resChange.F = 2; message = `Сбор редкой марсианской флоры. Получено ${RESOURCES.F.icon} ${RESOURCES.F.name} (+2).`;
                    }
                } else if (group === 'Constructors') {
                    if (actionCode === 'Opt_S') { 
                        if (gameState.inventory.S >= 1) { gameState.inventory.S--; resChange.F = 1; statusChange = 1; message = `Укрепление конструкции. Получен ${RESOURCES.F.icon} ${RESOURCES.F.name} (+1). +1 Статус.`; }
                        else { hpChange = -1; message = "Сбой укрепления: нет Сплава. -1 HP."; }
                    } else if (actionCode === 'Rec_E') { // Случайный сбор
                        resChange.E = 2; message = `Анализ солнечных панелей. Получено ${RESOURCES.E.icon} ${RESOURCES.E.name} (+2).`;
                    }
                }
            }
            // --- ЦИКЛ 3: ЛОКАЛИЗАЦИЯ СБОЯ (АВАРИЙНЫЙ РЕМОНТ) ---
            else if (gameState.currentRound === 3) {
                 if (actionCode === 'L_Fix' && gameState.inventory.L >= 1) { 
                     gameState.inventory.L--; statusChange = 2; message = `Применен ${RESOURCES.L.icon} ${RESOURCES.L.name} (-1). Поломка устранена, +2 Статус.`; 
                 } else if (actionCode === 'M_Fix' && gameState.inventory.M >= 1) { 
                     gameState.inventory.M--; hpChange = 2; message = `Применен ${RESOURCES.M.icon} ${RESOURCES.M.name} (-1). Улучшена вентиляция, +2 HP.`; 
                 } else { 
                     hpChange = -2; statusChange = -1; message = "Нет нужного компонента. Утечка тепла. -2 HP, -1 Статус."; 
                 }
            }
            // --- ЦИКЛ 4: НЕИЗВЕСТНЫЙ АРТЕФАКТ (РИСК ИССЛЕДОВАНИЯ) ---
            else if (gameState.currentRound === 4) {
                 if (actionCode === 'K_Invest' && gameState.inventory.K >= 1) { 
                     gameState.inventory.K--; resChange.L = 3; message = `Герметизация ${RESOURCES.K.name} (-1). Захвачено ${RESOURCES.L.icon} ${RESOURCES.L.name} (+3).`; 
                 } else if (actionCode === 'W_Invest' && gameState.inventory.W >= 1) { 
                     gameState.inventory.W--; statusChange = 2; message = `Анализ Синтезатором Воды (-1). Найдена схема маяка, +2 Статус.`; 
                 } else { 
                     hpChange = -3; message = "Попытка без нужного компонента. Серьезное облучение. -3 HP."; 
                 }
            }
            // --- ЦИКЛ 5: УКРЕПЛЕНИЕ ПЕРЕД БУРЕЙ (СБОР) ---
            else if (gameState.currentRound === 5) {
                 if (actionCode === 'Gather_E_B_S') { 
                     resChange.E = 1; resChange.B = 1; resChange.S = 1; statusChange = 1; message = `Сборка ресурсов перед бурей. +1 ${RESOURCES.E.icon}, +1 ${RESOURCES.B.icon}, +1 ${RESOURCES.S.icon}. +1 Статус.`; 
                 }
            }
            // --- ЦИКЛ 6: ПОДГОТОВКА И КОНТРАКТ (ФИНАЛЬНЫЙ РЫВОК) ---
            else if (gameState.currentRound === 6) {
                 if (actionCode === 'Final_Dash') { 
                     if (gameState.inventory.E >= 2) { 
                         gameState.inventory.E -= 2; statusChange = 3; message = `Финальный рывок на полной мощности (-2 ${RESOURCES.E.icon}). +3 Статус.`; 
                     } else { 
                         hpChange = -3; statusChange = -1; message = "Нет энергии для рывка. -3 HP, -1 Статус."; 
                     }
                 }
            }

            // Применение изменений
            gameState.inventory.HP += hpChange;
            if (statusChange !== 0) {
                 gameState.historyLog.push({ round: gameState.currentRound, statusChange: statusChange, details: `Действие ${actionCode}` });
            }
            for (const res in resChange) {
                gameState.inventory[res] = (gameState.inventory[res] || 0) + resChange[res];
            }
            
            if (message) updateLog(`📢 ОТЧЕТ: ${message}`);

            if (gameState.inventory.HP <= 0) {
                 gameOver("Критический сбой жизнеобеспечения. Миссия провалена.");
                 return;
            }

            loadRound(gameState.currentRound); // Перезагрузка UI для обновления кнопок
            updateUI();
        }

        // --- ФИНАЛ: СБОР МАЯКА ---
        function assembleBeacon() {
            if (gameState.currentRound !== 7) return;
            if (!takeAction()) return; 
            
            const required = CRAFT_COSTS.P;
            let canAssemble = true;
            let finalMessage = "";

            for (const res in required) {
                if (gameState.inventory[res] < required[res]) {
                    canAssemble = false;
                    finalMessage += `Не хватает **1 ${RESOURCES[res].icon} ${RESOURCES[res].name}**. `;
                }
            }

            if (canAssemble) {
                // Трата ресурсов
                gameState.inventory.M -= required.M;
                gameState.inventory.W -= required.W;
                gameState.inventory.K -= required.K;
                gameState.inventory.Z -= required.Z;
                gameState.inventory.P = 1;
                
                updateLog(`🎉 СБОРКА: **Маяк Спасения** Собран! Начинается передача сигнала.`);
                
                const finalScore = calculateFinalScore();
                let resultText = "";

                if (finalScore >= 10) {
                    resultText = `👽 КРИТИЧЕСКИЙ УСПЕХ! Счет: ${finalScore}. Сигнал принят мгновенно. Ваша команда спасена! ВЕЛИКОЛЕПНО!`;
                } else if (finalScore >= 5) {
                    resultText = `✅ УСПЕХ! Счет: ${finalScore}. Сигнал принят с задержкой. Вы выжили, но потребуется время на восстановление.`;
                } else {
                    resultText = `⚠️ НИЗКИЙ УСПЕХ! Счет: ${finalScore}. Сигнал очень слаб. Спасательная миссия отправлена, но ваше выживание под вопросом.`;
                }
                
                document.getElementById('action-area').innerHTML = `<div class="final-message">${resultText}</div>`;
                document.getElementById('round-title').textContent = "🛰️ ФИНАЛ МИССИИ";
            } else {
                updateLog(`🚨 КРИТИЧЕСКИЙ ОТКАЗ СБОРКИ: ${finalMessage} Сборка невозможна.`, true);
                gameState.actionsTaken--; // Отменяем трату действия
                document.getElementById('actions-remaining').textContent = gameState.maxActions - gameState.actionsTaken;
            }
            updateUI();
        }

        function calculateFinalScore() {
            const assemblyBonus = gameState.inventory.P > 0 ? 5 : 0; 
            const historyScore = gameState.historyLog.reduce((sum, log) => sum + log.statusChange, 0);
            return assemblyBonus + historyScore;
        }


        // --- ЗАГРУЗКА ЦИКЛОВ ---

        function getRoundDescription(round) {
            const group = gameState.group;
            
            switch(round) {
                case 1: 
                    let tableHtml = `
                        <h3>ПРОТОКОЛ: АВАРИЙНАЯ ЗАКУПКА (ЦИКЛ 1)</h3>
                        <p>Выделено **${gameState.inventory.CR} КР** (Кредитов). Вы можете приобрести базовые компоненты для начала работ. **Оставшиеся КР сгорают при переходе к следующему циклу.**</p>
                        <table>
                            <tr><th>Ресурс</th><th>Иконка</th><th>Цена (КР)</th><th>В наличии</th><th>Действие</th></tr>
                            <tr><td>${RESOURCES.E.name}</td><td>${RESOURCES.E.icon}</td><td>${RESOURCES.E.cost}</td><td>${gameState.inventory.E}</td><td><button onclick="buyResource('E')" ${gameState.inventory.CR < RESOURCES.E.cost ? 'disabled' : ''}>КУПИТЬ</button></td></tr>
                            <tr><td>${RESOURCES.B.name}</td><td>${RESOURCES.B.icon}</td><td>${RESOURCES.B.cost}</td><td>${gameState.inventory.B}</td><td><button onclick="buyResource('B')" ${gameState.inventory.CR < RESOURCES.B.cost ? 'disabled' : ''}>КУПИТЬ</button></td></tr>
                            <tr><td>${RESOURCES.S.name}</td><td>${RESOURCES.S.icon}</td><td>${RESOURCES.S.cost}</td><td>${gameState.inventory.S}</td><td><button onclick="buyResource('S')" ${gameState.inventory.CR < RESOURCES.S.cost ? 'disabled' : ''}>КУПИТЬ</button></td></tr>
                            <tr><td>${RESOURCES.L.name}</td><td>${RESOURCES.L.icon}</td><td>${RESOURCES.L.cost}</td><td>${gameState.inventory.L}</td><td><button onclick="buyResource('L')" ${gameState.inventory.CR < RESOURCES.L.cost ? 'disabled' : ''}>КУПИТЬ</button></td></tr>
                            <tr><td>${RESOURCES.F.name}</td><td>${RESOURCES.F.icon}</td><td>${RESOURCES.F.cost}</td><td>${gameState.inventory.F}</td><td><button onclick="buyResource('F')" ${gameState.inventory.CR < RESOURCES.F.cost ? 'disabled' : ''}>КУПИТЬ</button></td></tr>
                        </table>
                    `;
                    
                    let earnHtml = '';
                    // Логика для заработка (активна, если Кредитов меньше 10)
                    if (gameState.inventory.CR < 10) { 
                        let taskDesc = '';
                        if (group === 'Technocrats') { taskDesc = 'Провести ремонтный цикл'; }
                        else if (group === 'Bioengineers') { taskDesc = 'Собрать и проанализировать образцы'; }
                        else if (group === 'Constructors') { taskDesc = 'Укрепить внешний контур базы'; }
                        
                        earnHtml = `
                            <h3 style="color: #3498db;">ПОДРАБОТКА (ЭКСТРЕННОЕ ФИНАНСИРОВАНИЕ)</h3>
                            <p>Ваш баланс ниже 10 КР. Выполните срочное ${taskDesc}, чтобы заработать недостающие средства.</p>
                            <button onclick="earnCredits(5)">КРАТКОЕ ЗАДАНИЕ (+5 КР)</button>
                            <button onclick="earnCredits(10)">ОБШИРНОЕ ЗАДАНИЕ (+10 КР)</button>
                        `;
                    }
                    
                    return tableHtml + earnHtml + `<p style="margin-top: 20px; color: #f1c40f; font-size: 1.1em;">ТЕКУЩИЙ БАЛАНС КР: **${gameState.inventory.CR}**</p>`;

                case 2: 
                    let desc2 = "<h3>МАРСИАНСКАЯ ПОВЕРХНОСТЬ: РАЗВЕДКА И ОПТИМИЗАЦИЯ</h3><p>Начальный этап сбора данных. Выберите либо специализированную задачу (дает промежуточный ресурс для финальной сборки), либо проведите обычный сбор.</p>";
                    if (group === 'Technocrats') { desc2 += `<p>**🛠️ ТЕХНОКРАТЫ:** Оптимизация Энергосистемы (требует **1 ${RESOURCES.E.icon} ${RESOURCES.E.name}**) дает **${RESOURCES.Z.icon} ${RESOURCES.Z.name}**, необходимый для Маяка.</p>`; }
                    else if (group === 'Bioengineers') { desc2 += `<p>**🧪 БИОИНЖЕНЕРЫ:** Запуск Гидропоники (требует **1 ${RESOURCES.B.icon} ${RESOURCES.B.name}**) дает **${RESOURCES.L.icon} ${RESOURCES.L.name}**.</p>`; }
                    else if (group === 'Constructors') { desc2 += `<p>**🧱 КОНСТРУКТОРЫ:** Укрепление Базы (требует **1 ${RESOURCES.S.icon} ${RESOURCES.S.name}**) дает **${RESOURCES.F.icon} ${RESOURCES.F.name}**.</p>`; }
                    return desc2;
                case 3: return "<h3>КРИТИЧЕСКИЙ СБОЙ: ЛОКАЛИЗАЦИЯ</h3><p>Обнаружена критическая поломка в модуле жизнеобеспечения. Срочно примените ресурс для устранения утечки тепла, иначе понесете урон.</p>";
                case 4: return "<h3>АНАЛИЗ: НЕИЗВЕСТНЫЙ АРТЕФАКТ</h3><p>Обнаружен неизвестный артефакт. Вам нужно использовать один из сложных компонентов для его захвата или анализа. Это рискованно!</p>";
                case 5: return "<h3>ОПОРА: УКРЕПЛЕНИЕ ПЕРЕД БУРЕЙ</h3><p>Надвигается мощная песчаная буря. Крафт модулей (${RESOURCES.M.icon} ${RESOURCES.M.name}, ${RESOURCES.W.icon} ${RESOURCES.W.name}, ${RESOURCES.K.icon} ${RESOURCES.K.name}) — это теперь приоритетное действие. Используйте команду **КРАФТ [M/W/K]** в Протоколе Связи. Это **не тратит** лимит хода!</p>";
                case 6: return "<h3>РЕШЕНИЕ: ПОДГОТОВКА И КОНТРАКТ</h3><p>Последний цикл перед финальной сборкой. Вы можете обменять излишки ресурсов с внешним поставщиком. Обмен через **ОТДАТЬ/ПОЛУЧИТЬ** **не тратит** лимит хода. Также доступен **Финальный Рывок** для повышения статуса.</p>";
                case 7: return "<h3>ТРАНСЛЯЦИЯ: ФИНАЛЬНАЯ СБОРКА МАЯКА</h3><p>Это ваш последний шанс. Объедините ключевые компоненты (**1 ${RESOURCES.M.name}, 1 ${RESOURCES.W.name}, 1 ${RESOURCES.K.name}**) и кабель (**1 ${RESOURCES.Z.name}**) для отправки сигнала спасения. Используйте команду **СБОР** в Протоколе Связи.</p>";
            }
        }

        function loadRound(round) {
            const desc = document.getElementById('round-description');
            const actions = document.getElementById('action-area');
            actions.innerHTML = '';
            document.getElementById('round-title').textContent = ROUND_TITLES[round];
            desc.innerHTML = getRoundDescription(round);
            const group = gameState.group;
            
            if (round === 1) {
                 return;
            } else if (round === 2) {
                 if (group === 'Technocrats') {
                     actions.innerHTML = `<button onclick="applyRoundAction('Opt_E')" class="round-action-button">🛠️ ОПТИМИЗАЦИЯ ЭНЕРГИИ (требует 1 ${RESOURCES.E.icon})</button><button onclick="applyRoundAction('Rec_S')">🔩 СБОР КОМПОЗИТНОГО СПЛАВА (+2 ${RESOURCES.S.icon})</button>`;
                 } else if (group === 'Bioengineers') {
                     actions.innerHTML = `<button onclick="applyRoundAction('Opt_B')" class="round-action-button">🧪 ЗАПУСК ГИДРОПОНИКИ (требует 1 ${RESOURCES.B.icon})</button><button onclick="applyRoundAction('Rec_F')">🧶 СБОР ИЗОВОЛОКНА (+2 ${RESOURCES.F.icon})</button>`;
                 } else if (group === 'Constructors') {
                     actions.innerHTML = `<button onclick="applyRoundAction('Opt_S')" class="round-action-button">🧱 УКРЕПЛЕНИЕ БАЗЫ (требует 1 ${RESOURCES.S.icon})</button><button onclick="applyRoundAction('Rec_E')">⚡ СБОР ЭНЕРГОЯЧЕЕК (+2 ${RESOURCES.E.icon})</button>`;
                 }
            } else if (round === 3) {
                 actions.innerHTML = `
                    <button onclick="applyRoundAction('L_Fix')" class="round-action-button">💧 РЕМОНТ (требует 1 ${RESOURCES.L.icon})</button>
                    <button onclick="applyRoundAction('M_Fix')" class="round-action-button">❄️ СТАБИЛИЗАЦИЯ (требует 1 ${RESOURCES.M.icon})</button>
                    <button onclick="applyRoundAction('Fail_3')" class="end-round-button">🔴 ОТКАЗ (потери HP/Статуса)</button>
                 `;
            } else if (round === 4) {
                 actions.innerHTML = `
                    <button onclick="applyRoundAction('K_Invest')" class="round-action-button">📦 ГЕРМЕТИЧНЫЙ ЗАХВАТ (требует 1 ${RESOURCES.K.icon})</button>
                    <button onclick="applyRoundAction('W_Invest')" class="round-action-button">🌊 АНАЛИЗ СИНТЕЗАТОРОМ (требует 1 ${RESOURCES.W.icon})</button>
                    <button onclick="applyRoundAction('Fail_4')" class="end-round-button">🔴 НЕПОДГОТОВЛЕННОЕ ОБСЛЕДОВАНИЕ (-3 HP)</button>
                 `;
            } else if (round === 5) {
                 actions.innerHTML = `
                    <button onclick="applyRoundAction('Craft_M_W_K')" style="background: #3498db;">⚙️ КРАФТ ПРОМЕЖУТОЧНОГО МОДУЛЯ (Протокол Связи)</button>
                    <button onclick="applyRoundAction('Gather_E_B_S')" class="round-action-button">🔄 СБОР БАЗОВЫХ РЕСУРСОВ (+1 E, +1 B, +1 S, +1 Статус)</button>
                 `;
            } else if (round === 6) {
                 actions.innerHTML = `
                    <button onclick="applyRoundAction('Trade')" style="background: #3498db;">🤝 ОБМЕН С ВЕДУЩИМ (Протокол Связи)</button>
                    <button onclick="applyRoundAction('Final_Dash')" class="round-action-button">⚡ ФИНАЛЬНЫЙ РЫВОК (требует 2 ${RESOURCES.E.icon})</button>
                 `;
            } else if (round === 7) {
                 actions.innerHTML = `
                    <button onclick="assembleBeacon()" class="round-action-button" style="font-size: 1.1em;">🛰️ СБОРКА И ЗАПУСК МАЯКА</button>
                    <button onclick="applyRoundAction('Fail_7')" class="end-round-button">🔴 БЕЗДЕЙСТВИЕ (Завершить)</button>
                 `;
            }
        }

        // Инициализация на всякий случай, если пользователь запускает код напрямую
        document.addEventListener('DOMContentLoaded', () => {
            // Скрыть игровую область, пока не выбрана группа
            document.getElementById('game-round').style.display = 'none';
        });
    </script>
</body>
</html>
