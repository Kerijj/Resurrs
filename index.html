<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–∫—Å–ø–µ–¥–∏—Ü–∏—è –ê—Ä–µ—Å 7 –ú–∞—Ä—Å–∏–∞–Ω—Å–∫–∏–π –ö–≤–µ—Å—Ç</title>
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #1c1c1c; color: #dcdcdc; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; background: #2a2a2a; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); }
        h1, h2 { color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; margin-top: 0; }
        .intro, .round-content, #trade-dialogue { margin-bottom: 20px; padding: 15px; border: 1px dashed #555; border-radius: 5px; }
        .resources-display { background: #3c3c3c; padding: 10px; border-radius: 5px; margin-top: 15px; }
        .resources-display h3 { color: #2ecc71; margin-top: 0; }
        .log-box { margin-top: 15px; background: #1c1c1c; padding: 10px; height: 100px; overflow-y: scroll; border-radius: 5px; font-size: 0.9em; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; background: #3498db; color: white; margin-right: 10px; transition: background 0.2s; }
        button:hover:not(:disabled) { background: #2980b9; }
        button:disabled { background: #555; cursor: not-allowed; }
        #mod-input { padding: 8px; border-radius: 4px; border: 1px solid #7f8c8d; margin-right: 10px; background: #1c1c1c; color: #dcdcdc; }
        .group-select button { width: 150px; }
        .current-round-title { color: #f1c40f; }
        .task-list { list-style-type: none; padding: 0; }
        .task-list li { margin-bottom: 8px; }
        .inventory-list { margin-top: 10px; list-style-type: none; padding: 0; display: flex; flex-wrap: wrap; gap: 10px;}
        .inventory-item { padding: 5px 10px; border-radius: 5px; background: #444;}
    </style>
</head>
<body>

    <div class="container">
        <h1>üåå –≠–∫—Å–ø–µ–¥–∏—Ü–∏—è –ê—Ä–µ—Å 7</h1>
        <div id="game-area">
            <div class="intro" id="intro-screen">
                <h2>–ù–∞—á–∞–ª–æ –ú–∏—Å—Å–∏–∏</h2>
                <p>–í—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–∂–∏–≤—à–∏–µ —á–ª–µ–Ω—ã —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏ –ê—Ä–µ—Å 7 –Ω–∞ –ö—Ä–∞—Å–Ω–æ–π –ø–ª–∞–Ω–µ—Ç–µ –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é –≥—Ä—É–ø–ø—É —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
                
                <div class="group-select">
                    <button onclick="startGame('Technocrats')">üõ†Ô∏è –¢–µ—Ö–Ω–æ–∫—Ä–∞—Ç—ã –≠–Ω–µ—Ä–≥–∏—è</button>
                    <button onclick="startGame('Bioengineers')">üß™ –ë–∏–æ–∏–Ω–∂–µ–Ω–µ—Ä—ã –•–∏–º–∏—è</button>
                    <button onclick="startGame('Constructors')">üß± –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</button>
                </div>
            </div>

            <div id="game-round" style="display:none;">
                <h2 class="current-round-title" id="round-title"></h2>
                
                <div class="round-content" id="round-description"></div>

                <div id="trade-dialogue" style="display:none;">
                    <h3>ü§ù –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã —Å –ü–µ—Ä–µ–∫—É–ø—â–∏–∫–æ–º</h3>
                    <p style="color: #f1c40f;">–í–≤–µ–¥–∏—Ç–µ –≤ –ø–∞–Ω–µ–ª—å –í–µ–¥—É—â–µ–≥–æ —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ **–û–¢–î–ê–¢–¨ [–∫–æ–¥] [–∫–æ–ª –≤–æ]** –∏ **–ü–û–õ–£–ß–ò–¢–¨ [–∫–æ–¥] [–∫–æ–ª –≤–æ]**</p>
                    <p style="font-size: 0.9em;">–ù–∞–ø—Ä–∏–º–µ—Ä –û–¢–î–ê–¢–¨ S 1 –∏ –ü–û–õ–£–ß–ò–¢–¨ B 1</p>
                </div>

                <div class="resources-display">
                    <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: <span id="player-group-name"></span></h3>
                    <ul class="inventory-list" id="inventory-list-display"></ul>
                    <p id="group-status"></p>
                </div>

                <div class="action-area" id="action-area">
                    </div>
                
                <div class="log-box">
                    **–ñ—É—Ä–Ω–∞–ª –í–µ–¥—É—â–µ–≥–æ**
                    <div id="game-log"></div>
                </div>

                <div style="margin-top: 20px; padding: 10px; background: #444; border-radius: 5px;">
                    <h4>–ü–∞–Ω–µ–ª—å –í–µ–¥—É—â–µ–≥–æ –í–≤–æ–¥ –∫–æ–º–∞–Ω–¥</h4>
                    <input type="text" id="mod-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –í–µ–¥—É—â–µ–≥–æ">
                    <button onclick="processModCommand()">–í–≤–æ–¥</button>
                    <button onclick="nextRound()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –†–∞—É–Ω–¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const RESOURCES = {
            // –ë–∞–∑–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã (5 —à—Ç)
            E: { name: '–ò—Å—Ç–æ—á–Ω –≠–Ω–µ—Ä–≥–∏–∏', code: 'E' },
            B: { name: '–û—Ä–≥ –ú–∞—Ç–µ—Ä–∏—è', code: 'B' },
            S: { name: '–ü—Ä–æ—á–Ω—ã–π –ú–µ—Ç–∞–ª–ª', code: 'S' },
            L: { name: '–ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä L', code: 'L' },
            F: { name: '–í–æ–ª–æ–∫–Ω–æ F', code: 'F' },
            
            // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (4 —à—Ç)
            M: { name: '–ö—Ä–∏–æ –ú–æ–¥—É–ª—å', code: 'M' },
            W: { name: '–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –í–æ–¥—ã', code: 'W' },
            K: { name: '–ì–µ—Ä–º–æ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä', code: 'K' },
            Z: { name: '–û–ø—Ç–∏—á –ö–∞–±–µ–ª—å', code: 'Z' }, // –ë–æ–Ω—É—Å–Ω—ã–π
            
            P: { name: '–ú–∞—è–∫ –°–ø–∞—Å–µ–Ω–∏—è', code: 'P' }
        };

        const ROUND_TITLES = [
            "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ú–∏—Å—Å–∏–∏",
            "–†–∞—É–Ω–¥ 1 –°–±–æ—Ä –ë–∞–∑–æ–≤—ã—Ö –†–µ—Å—É—Ä—Å–æ–≤",
            "–†–∞—É–Ω–¥ 2 –ì–µ—Ä–º–µ—Ç–∏–∑–∞—Ü–∏—è –∏ –ö—Ä–∞—Ñ—Ç",
            "–†–∞—É–Ω–¥ 3 –ú–∞—Ä—à –±—Ä–æ—Å–æ–∫ —á–µ—Ä–µ–∑ –ü—É—Å—Ç–æ—à—å",
            "–†–∞—É–Ω–¥ 4 –¢–∞–π–Ω–∞ –û—Å–∫–æ–ª–∫–∞ –ê–Ω—Ç—É—Ä–∞–∂",
            "–†–∞—É–Ω–¥ 5 –£–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –ë—É—Ä–∏",
            "–†–∞—É–Ω–¥ 6 –§–∏–Ω–∞–ª—å–Ω—ã–π –ü–æ–¥—ä–µ–º –∏ –ö–û–ù–¢–†–ê–ö–¢",
            "–†–∞—É–Ω–¥ 7 –°–±–æ—Ä–∫–∞ –ú–∞—è–∫–∞ –∏ –§–∏–Ω–∞–ª"
        ];

        let gameState = {
            group: null,
            inventory: { E: 0, B: 0, S: 0, L: 0, F: 0, M: 0, W: 0, K: 0, Z: 0, P: 0 }, // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
            currentRound: 0,
            status: "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –º–∏—Å—Å–∏–∏",
            historyLog: []
        };

        // --- –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---

        function updateLog(message, isCritical = false) {
            const logBox = document.getElementById('game-log');
            const color = isCritical ? 'red' : (message.includes('–ø–æ–ª—É—á–∞–µ—Ç') || message.includes('—É—Å–ø–µ—à–µ–Ω') ? '#2ecc71' : '#dcdcdc');
            logBox.innerHTML = `<p style="margin: 2px 0; color: ${color};">[–†${gameState.currentRound}] ${message}</p>` + logBox.innerHTML;
        }

        function updateUI() {
            document.getElementById('player-group-name').textContent = gameState.group;
            
            // –ù–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
            const inventoryList = document.getElementById('inventory-list-display');
            let html = '';
            for (const code in gameState.inventory) {
                const count = gameState.inventory[code];
                if (count > 0) {
                    html += `<li class="inventory-item">${RESOURCES[code].name} (${count})</li>`;
                }
            }
            inventoryList.innerHTML = html || '<li>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</li>';
            
            document.getElementById('group-status').innerHTML = gameState.status;
            document.getElementById('round-title').textContent = ROUND_TITLES[gameState.currentRound];
        }

        function startGame(groupName) {
            gameState.group = groupName;
            gameState.currentRound = 1;
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('game-round').style.display = 'block';
            
            updateLog(`–ì—Ä—É–ø–ø–∞ –≤—ã–±—Ä–∞–Ω–∞ **${groupName}** –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è ${ROUND_TITLES[gameState.currentRound]}`);
            updateUI();
            loadRound(1);
        }

        function nextRound() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º (–æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è 5 —Ä–µ—Å—É—Ä—Å–æ–≤)
            const baseResources = ['E', 'B', 'S', 'L', 'F'];
            
            if (gameState.currentRound === 1 && baseResources.every(code => gameState.inventory[code] === 0)) {
                updateLog("üõë –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏—Ç–µ –±–∞–∑–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã", true);
                return;
            }
            
            if (gameState.currentRound === 2 && (gameState.inventory.M === 0 && gameState.inventory.W === 0 && gameState.inventory.K === 0)) {
                 updateLog("üõë –°–æ–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ—Å—É—Ä—Å M W –∏–ª–∏ K", true);
                 return;
            }
            
            const isActionLogged = gameState.historyLog.some(log => log.round === gameState.currentRound);
            if (gameState.currentRound >= 3 && gameState.currentRound <= 6 && !isActionLogged) {
                 updateLog("üõë –í—ã –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∫–ª—é—á–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —ç—Ç–æ–≥–æ —Ä–∞—É–Ω–¥–∞", true);
                 return;
            }
            if (gameState.currentRound === 6 && document.getElementById('trade-dialogue').style.display === 'block') {
                 updateLog("üõë –û–±–º–µ–Ω –∞–∫—Ç–∏–≤–µ–Ω –ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –ø—Ä–µ–∂–¥–µ —á–µ–º –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ", true);
                 return;
            }


            if (gameState.currentRound === 7) return; 

            gameState.currentRound++;
            document.getElementById('trade-dialogue').style.display = 'none';
            updateLog(`=== –ü–µ—Ä–µ—Ö–æ–¥ –≤ ${ROUND_TITLES[gameState.currentRound]} ===`, true);
            gameState.status = "";
            loadRound(gameState.currentRound);
            updateUI();
        }

        // --- –õ–û–ì–ò–ö–ê –í–ï–î–£–©–ï–ì–û (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---

        function processModCommand() {
            const input = document.getElementById('mod-input').value.trim().toLowerCase();
            const words = input.split(' ');
            document.getElementById('mod-input').value = '';

            // 1. –î–û–ë–´–¢–¨ [–∫–æ–¥] [–∫–æ–ª –≤–æ] (–†1)
            if (words[0] === '–¥–æ–±—ã—Ç—å' && words.length === 3) {
                const resCode = words[1].toUpperCase();
                const amount = parseInt(words[2]);
                const baseResources = ['E', 'B', 'S', 'L', 'F'];
                
                if (baseResources.includes(resCode) && !isNaN(amount) && amount > 0 && gameState.currentRound === 1) {
                    gameState.inventory[resCode] += amount;
                    updateLog(`üì¢ –í–µ–¥—É—â–∏–π –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ì—Ä—É–ø–ø–∞ ${gameState.group} –ø–æ–ª—É—á–∞–µ—Ç +${amount} **${RESOURCES[resCode].name}**`);
                    updateUI();
                    return;
                }
            } 
            
            // 2. –ö–†–ê–§–¢ [–∫–æ–¥] (–†2)
            if (words[0] === '–∫—Ä–∞—Ñ—Ç' && words.length === 2) {
                const resCode = words[1].toUpperCase();
                if (['M', 'W', 'K', 'Z'].includes(resCode) && gameState.currentRound === 2) { // Z –¥–æ–±–∞–≤–ª–µ–Ω
                    craftIntermediate(resCode);
                    return;
                }
            }

            // 3. –ö–û–ù–¢–†–ê–ö–¢ (–†6) –∏ 4. –û–¢–î–ê–¢–¨ / –ü–û–õ–£–ß–ò–¢–¨ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            if (input === '–∫–æ–Ω—Ç—Ä–∞–∫—Ç' && gameState.currentRound === 6) {
                updateLog("ü§ù **–ü–ï–†–ï–ö–£–ü–©–ò–ö –ê–ö–¢–ò–í–ò–†–û–í–ê–ù** –ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –û–¢–î–ê–¢–¨ –ü–û–õ–£–ß–ò–¢–¨");
                document.getElementById('trade-dialogue').style.display = 'block';
                return;
            }
            
            if ((words[0] === '–æ—Ç–¥–∞—Ç—å' || words[0] === '–ø–æ–ª—É—á–∏—Ç—å') && words.length === 3) {
                 const action = words[0];
                 const resCode = words[1].toUpperCase();
                 const amount = parseInt(words[2]);

                 if (RESOURCES[resCode] && !isNaN(amount) && document.getElementById('trade-dialogue').style.display === 'block') {
                    if (action === '–æ—Ç–¥–∞—Ç—å') {
                        if (gameState.inventory[resCode] >= amount) {
                            gameState.inventory[resCode] -= amount;
                            updateLog(`–ü–µ—Ä–µ–∫—É–ø—â–∏–∫ –ì—Ä—É–ø–ø–∞ ${gameState.group} –æ—Ç–¥–∞–ª–∞ **-${amount} ${RESOURCES[resCode].name}**`);
                        } else {
                            updateLog(`üõë –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ${RESOURCES[resCode].name} –¥–ª—è –æ—Ç–¥–∞—á–∏ –û–±–º–µ–Ω –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω`, true);
                        }
                    } else if (action === '–ø–æ–ª—É—á–∏—Ç—å') {
                        gameState.inventory[resCode] += amount;
                        updateLog(`–ü–µ—Ä–µ–∫—É–ø—â–∏–∫ –ì—Ä—É–ø–ø–∞ ${gameState.group} –ø–æ–ª—É—á–∏–ª–∞ **+${amount} ${RESOURCES[resCode].name}**`);
                    }
                    updateUI();
                    return;
                }
            }
            
            updateLog("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–ª–∏ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è –∫–æ–º–∞–Ω–¥–∞ –í–µ–¥—É—â–µ–≥–æ", true);
        }

        // --- –õ–û–ì–ò–ö–ê –ö–†–ê–§–¢–ê (–†2) - –û–ë–ù–û–í–õ–ï–ù–û ---

        function craftIntermediate(resCode) {
            const costs = {
                M: { E: 3, B: 2 }, 
                W: { B: 3, S: 2 }, 
                K: { S: 3, L: 2 }, // –ù–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç
                Z: { L: 3, F: 2 }  // –ù–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç (–±–æ–Ω—É—Å–Ω—ã–π)
            };
            const cost = costs[resCode];
            let canCraft = true;

            for (const res in cost) {
                if (gameState.inventory[res] < cost[res]) {
                    updateLog(`üõë –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ${RESOURCES[res].name} —Ç—Ä–µ–±—É–µ—Ç—Å—è ${cost[res]} –ö—Ä–∞—Ñ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω`, true);
                    canCraft = false;
                    break;
                }
            }

            if (canCraft) {
                for (const res in cost) {
                    gameState.inventory[res] -= cost[res];
                }
                gameState.inventory[resCode]++;
                updateLog(`üéâ –ö—Ä–∞—Ñ—Ç —É—Å–ø–µ—à–µ–Ω –°–æ–∑–¥–∞–Ω **1 ${RESOURCES[resCode].name}**`);
            }
            updateUI();
        }

        // --- –î–ï–¢–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–£–ù–î–û–í (3-7) ---

        function getRound1Task() {
            // –ó–∞–¥–∞–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ (–∫–∞–∫ –≤ –≤–∞—à–µ–º –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ)
            switch(gameState.group) {
                case 'Technocrats': return "üîê –ó–∞–¥–∞–Ω–∏–µ –†–µ—à–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞–º–º—É –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–ª—å–∫–æ 4 –±—É–∫–≤—ã –Ω–∞–ø—Ä–∏–º–µ—Ä –ê–†–ï–°";
                case 'Bioengineers': return "üé® –ó–∞–¥–∞–Ω–∏–µ –ù–∞–∑–æ–≤–∏—Ç–µ 5 –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è –∂–∏–∑–Ω–∏ –Ω–∞ –ú–∞—Ä—Å–µ –∫—Ä–æ–º–µ –≤–æ–¥—ã";
                case 'Constructors': return "üìê –ó–∞–¥–∞–Ω–∏–µ –ò–∑ –ø–æ–¥—Ä—É—á–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ —Ä—É—á–∫–∞ –±—É–º–∞–≥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ—Å—Ç—Ä–æ–π—Ç–µ —Å–∞–º—É—é –≤—ã—Å–æ–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞ 30 —Å–µ–∫—É–Ω–¥";
                default: return "–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ª—é–±–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ –¥–∞—Å—Ç –í–µ–¥—É—â–∏–π";
            }
        }
        
        function getCostString(code) {
             const costs = {
                M: { E: 3, B: 2 }, 
                W: { B: 3, S: 2 }, 
                K: { S: 3, L: 2 }, 
                Z: { L: 3, F: 2 }
            };
            return Object.entries(costs[code]).map(([c, count]) => `${count} ${RESOURCES[c].name}`).join(' –∏ ');
        }
        
        function getActionStatus() {
            return gameState.historyLog.some(log => log.round === gameState.currentRound) ? 'disabled' : '';
        }

        // ... (–§—É–Ω–∫—Ü–∏–∏ applyR3Action, applyR4Action, applyR5Action, applyR6Action –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ –ª–æ–≥–∏–∫–µ) ...
        
        function applyR3Action(code) {
            let statusChange = 0;
            const hasResource = gameState.inventory[code] > 0;
            if (hasResource) {
                statusChange = 1;
                updateLog(`üß≠ –£—Å–ø–µ—Ö –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ${RESOURCES[code].name} –¥–∞–ª–æ +1 –∫ —Å—Ç–∞—Ç—É—Å—É`);
                gameState.status = `–£—Å–ø–µ—Ö ${RESOURCES[code].name} –ø–æ–º–æ–≥ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ +1 –æ—á–∫–æ`;
            } else {
                statusChange = -1;
                updateLog(`‚ö†Ô∏è –ü—Ä–æ–≤–∞–ª –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ ${RESOURCES[code].name} –ø—Ä–∏–≤–µ–ª–æ –∫ -1 –∫ —Å—Ç–∞—Ç—É—Å—É`);
                gameState.status = `–ù–µ—É–¥–∞—á–∞ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ ${RESOURCES[code].name} –ø—Ä–∏–≤–µ–ª–æ –∫ –ø–æ—Ç–µ—Ä–µ –≤—Ä–µ–º–µ–Ω–∏ -1 –æ—á–∫–æ`;
            }
            gameState.historyLog.push({ round: 3, statusChange: statusChange, details: `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫–æ–¥ ${code}` });
            loadRound(3);
            updateUI();
        }
        
        function applyR4Action(code) {
            let statusChange = 0;
            let message = "";
            const hasResource = gameState.inventory[code] > 0;

            if (hasResource) {
                 if (code === 'M') { statusChange = 1; message = "–ò–∑—É—á–µ–Ω–∏–µ –û—Å–∫–æ–ª–∫–∞ —Å –ø–æ–º–æ—â—å—é –ú–æ–¥—É–ª—è M –¥–∞–ª–æ +1 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É –∏ **–ü–æ–¥—Å–∫–∞–∑–∫—É** –û—Å–∫–æ–ª–æ–∫ —á–∞—Å—Ç—å –∞–Ω—Ç–µ–Ω–Ω—ã –ú–∞—è–∫–∞"; }
                 else if (code === 'W') { statusChange = -1; message = "–ê–Ω–∞–ª–∏–∑ —Å –ø–æ–º–æ—â—å—é –°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∞ W –±—ã–ª –Ω–µ–≤–µ—Ä–Ω—ã–º -1 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É"; }
                 else if (code === 'K') { statusChange = 2; message = "–ì–µ—Ä–º–µ—Ç–∏–∑–∞—Ü–∏—è K –∏ –≤–∑—è—Ç–∏–µ –û—Å–∫–æ–ª–∫–∞ —Å —Å–æ–±–æ–π —Å–∞–º–æ–µ –º—É–¥—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ **+2 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É**"; }
            } else {
                statusChange = -1; message = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ –Ω–∞—É–≥–∞–¥ -1 –∫ —Å—Ç–∞—Ç—É—Å—É";
            }

            gameState.historyLog.push({ round: 4, statusChange: statusChange, details: `–û—Å–∫–æ–ª–æ–∫ –†–µ—à–µ–Ω–∏–µ ${code}` });
            gameState.status = `–°—Ç–∞—Ç—É—Å ${message}`;
            loadRound(4);
            updateUI();
        }

        function applyR5Action(action) {
            const statusR3 = gameState.historyLog.find(log => log.round === 3)?.statusChange || 0;
            let statusChange = 0;
            let message = "";

            if (action === 'Energy' && statusR3 < 0) {
                statusChange = 1; message = "–≠–∫–æ–Ω–æ–º–∏—è –≠–Ω–µ—Ä–≥–∏–∏ –±—ã–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞ –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ç–µ—Ä—å —ç–Ω–µ—Ä–≥–∏–∏ **+1 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É**";
            } else if (action === 'Protect' && statusR3 >= 0) {
                statusChange = 1; message = "–ó–∞—â–∏—Ç–∞ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å–ø–∞—Å–ª–∞ –≤–∞—à–∏ —Ä–µ—Å—É—Ä—Å—ã **+1 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É**";
            } else {
                statusChange = -1; message = "–ù–µ–≤–µ—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤ —É—Å–ª–æ–≤–∏—è—Ö –±—É—Ä–∏ -1 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É";
            }
            
            gameState.historyLog.push({ round: 5, statusChange: statusChange, details: `–ë—É—Ä—è –î–µ–π—Å—Ç–≤–∏–µ ${action}` });
            gameState.status = `–°—Ç–∞—Ç—É—Å ${message}`;
            loadRound(5);
            updateUI();
        }

        function applyR6Action(action) {
            let statusChange = 0;
            let message = "";
            
            if (action === 'Trade') {
                gameState.status = "ü§ù –í—ã –æ—Ç–∫—Ä—ã—Ç—ã –∫ –æ–±–º–µ–Ω—É —Å –¥—Ä—É–≥–∏–º–∏ –≤—ã–∂–∏–≤—à–∏–º–∏ –î–ª—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤ –Ω—É–∂–µ–Ω **–ö–û–ù–¢–†–ê–ö–¢** –≤–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ –≤ –ø–æ–ª–µ –í–µ–¥—É—â–µ–≥–æ";
                loadRound(6);
                return;
            } else if (action === 'Race') {
                if (gameState.inventory.E > 0) {
                    gameState.inventory.E -= 1;
                    statusChange = 1; message = "–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ 1 –ò—Å—Ç–æ—á–Ω –≠–Ω–µ—Ä–≥–∏–∏ –Ω–æ –Ω–∞–±—Ä–∞–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç—å **+1 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É**";
                } else {
                    statusChange = -2; message = "–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –ù–µ —Ö–≤–∞—Ç–∏–ª–æ —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è —Ä—ã–≤–∫–∞ **-2 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É**";
                }
            } else if (action === 'Safe') {
                statusChange = 1; message = "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å –ú–µ–¥–ª–µ–Ω–Ω–æ –Ω–æ –≤–µ—Ä–Ω–æ **+1 –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É**";
            }
            
            gameState.historyLog.push({ round: 6, statusChange: statusChange, details: `–ü–æ–¥—ä–µ–º –î–µ–π—Å—Ç–≤–∏–µ ${action}` });
            gameState.status = `–°—Ç–∞—Ç—É—Å ${message}`;
            loadRound(6);
            updateUI();
        }


        function assembleBeacon() {
            const required = { M: 1, W: 1, K: 1 };
            let canAssemble = true;

            for (const res in required) {
                if (gameState.inventory[res] < required[res]) {
                    updateLog(`üõë –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ${RESOURCES[res].name} –¥–ª—è —Å–±–æ—Ä–∫–∏ –ú–∞—è–∫–∞`, true);
                    canAssemble = false;
                    break;
                }
            }

            if (canAssemble) {
                gameState.inventory.M -= 1;
                gameState.inventory.W -= 1;
                gameState.inventory.K -= 1;
                gameState.inventory.P = 1;
                updateLog(`üéâ **–ú–∞—è–∫ –°–ø–∞—Å–µ–Ω–∏—è –°–æ–±—Ä–∞–Ω** –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—á–∞ —Å–∏–≥–Ω–∞–ª–∞`);
                updateUI();
            }
        }

        function calculateFinalScore() {
            const assemblyBonus = gameState.inventory.P > 0 ? 5 : 0;
            // –ë–æ–Ω—É—Å –∑–∞ –û–ø—Ç–∏—á–µ—Å–∫–∏–π –ö–∞–±–µ–ª—å (Z)
            const Z_bonus = gameState.inventory.Z > 0 ? 2 : 0; 
            const historyScore = gameState.historyLog.reduce((sum, log) => sum + log.statusChange, 0);
            return assemblyBonus + historyScore + Z_bonus; // Z_bonus –¥–æ–±–∞–≤–ª–µ–Ω
        }

        function getFinalMessage() {
            const score = calculateFinalScore();
            if (gameState.inventory.P === 0) return "‚ùå –ü—Ä–æ–≤–∞–ª –º–∏—Å—Å–∏–∏ –ú–∞—è–∫ –Ω–µ —Å–æ–±—Ä–∞–Ω –°–∏–≥–Ω–∞–ª –æ —Å–ø–∞—Å–µ–Ω–∏–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω";
            if (score >= 8) return "üåü –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –£—Å–ø–µ—Ö –°—á–µ—Ç " + score + " –í—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç–µ—Å—å –≥–µ—Ä–æ–µ–º –ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–¥–µ–∞–ª—å–Ω–æ";
            if (score >= 4) return "‚úÖ –£—Å–ø–µ—Ö –°—á–µ—Ç " + score + " –°–∏–≥–Ω–∞–ª –ø—Ä–∏–Ω—è—Ç –í—ã –≤—ã–∂–∏–ª–∏ –Ω–æ –≤–∞—à–∞ –º–∏—Å—Å–∏—è –±—ã–ª–∞ –Ω–∞ –≥—Ä–∞–Ω–∏";
            return "‚ö†Ô∏è –ù–∏–∑–∫–∏–π –£—Å–ø–µ—Ö –°—á–µ—Ç " + score + " –ú–∞—è–∫ —Å–æ–±—Ä–∞–Ω –Ω–æ —Å–ª–∞–±—ã–π —Å–∏–≥–Ω–∞–ª –í–∞—à–µ –≤—ã–∂–∏–≤–∞–Ω–∏–µ –ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º";
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê –†–ê–£–ù–î–û–í (–æ–±–Ω–æ–≤–ª–µ–Ω–æ) ---

        function loadRound(round) {
            const desc = document.getElementById('round-description');
            const actions = document.getElementById('action-area');
            actions.innerHTML = '';

            if (round !== 6) document.getElementById('trade-dialogue').style.display = 'none';

            switch(round) {
                case 1:
                    desc.innerHTML = `<h3>–ó–∞–¥–∞–Ω–∏–µ</h3><p>${getRound1Task()}</p><hr><p>üëâ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –í–µ–¥—É—â–∏–π –≤–≤–æ–¥–∏—Ç –∫–æ–º–∞–Ω–¥—É **–î–û–ë–´–¢–¨ [–∫–æ–¥] [–∫–æ–ª –≤–æ]**</p>`;
                    actions.innerHTML = `<button ${getActionStatus()} onclick="updateLog('–û–∂–∏–¥–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –í–µ–¥—É—â–µ–≥–æ')">–Ø –≤—ã–ø–æ–ª–Ω–∏–ª –∑–∞–¥–∞–Ω–∏–µ</button>`;
                    break;

                case 2:
                    desc.innerHTML = `<h3>–ó–∞–¥–∞–Ω–∏–µ</h3><p>–°–æ–∑–¥–∞–π—Ç–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã üîë –ö–ª—é—á–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É **–ö–†–ê–§–¢ [–∫–æ–¥]**</p><hr><h4>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–ª—å –ø–æ 1 —à—Ç)</h4><ul class="task-list"><li>**${RESOURCES.M.name}** M –¢—Ä–µ–±—É–µ—Ç ${getCostString('M')}</li><li>**${RESOURCES.W.name}** W –¢—Ä–µ–±—É–µ—Ç ${getCostString('W')}</li><li>**${RESOURCES.K.name}** K –¢—Ä–µ–±—É–µ—Ç ${getCostString('K')}</li><li>**${RESOURCES.Z.name}** Z (–ë–æ–Ω—É—Å) –¢—Ä–µ–±—É–µ—Ç ${getCostString('Z')}</li></ul>`;
                    actions.innerHTML = `<button disabled>–î–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å –í–µ–¥—É—â–µ–≥–æ –ö–†–ê–§–¢</button>`;
                    break;

                case 3:
                    desc.innerHTML = `<h3>–ó–∞–¥–∞–Ω–∏–µ</h3><p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—é –≠—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤–∞—à —Å—Ç–∞—Ç—É—Å +1 –∏–ª–∏ -1</p><hr><h4>–î–µ–π—Å—Ç–≤–∏—è</h4><ul class="task-list"><li>**–ù–∞–≤–∏–≥–∞—Ü–∏—è –ú** –£–ª—É—á—à–∞–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—é</li><li>**–í–æ–¥–∞ W** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–µ—Ä—é —ç–Ω–µ—Ä–≥–∏–∏</li><li>**–ó–∞—â–∏—Ç–∞ K** –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –º–∏–Ω–∏ –±—É—Ä–∏</li></ul>`;
                    actions.innerHTML = `<button ${getActionStatus()} onclick="applyR3Action('M')">–ù–∞–≤–∏–≥–∞—Ü–∏—è –ú</button><button ${getActionStatus()} onclick="applyR3Action('W')">–í–æ–¥–∞ W</button><button ${getActionStatus()} onclick="applyR3Action('K')">–ó–∞—â–∏—Ç–∞ K</button>`;
                    break;
                    
                case 4:
                    desc.innerHTML = `<h3>–ó–∞–¥–∞–Ω–∏–µ</h3><p>–í—ã –Ω–∞—à–ª–∏ –º–µ—Ä—Ü–∞—é—â–∏–π **–û—Å–∫–æ–ª–æ–∫** –†–µ—à–∏—Ç–µ –∫–∞–∫ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ</p>`;
                    actions.innerHTML = `<button ${getActionStatus()} onclick="applyR4Action('M')">–ò–∑—É—á–∏—Ç—å –ú</button><button ${getActionStatus()} onclick="applyR4Action('W')">–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å W</button><button ${getActionStatus()} onclick="applyR4Action('K')">–í–∑—è—Ç—å —Å —Å–æ–±–æ–π K</button>`;
                    break;
                    
                case 5:
                    const statusR3 = gameState.historyLog.find(log => log.round === 3)?.statusChange || 0;
                    const hint = statusR3 < 0 ? ' –í–∞—à —Å—Ç–∞—Ç—É—Å –Ω–∏–∑–∫–∏–π –Ω—É–∂–Ω–∞ –≠–ö–û–ù–û–ú–ò–Ø' : ' –í–∞—à —Å—Ç–∞—Ç—É—Å —Ö–æ—Ä–æ—à–∏–π –Ω—É–∂–Ω–∞ –ó–ê–©–ò–¢–ê';
                    desc.innerHTML = `<h3>–ó–∞–¥–∞–Ω–∏–µ</h3><p>–ü—Ä–∏–º–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å –í–∞—à —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –†3 –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä${hint}</p><hr><h4>–†–µ—à–µ–Ω–∏—è</h4><ul class="task-list"><li>**–≠–∫–æ–Ω–æ–º–∏—è –≠–Ω–µ—Ä–≥–∏–∏** –í–∞–∂–Ω–æ –ø—Ä–∏ –Ω–∏–∑–∫–æ–º —Å—Ç–∞—Ç—É—Å–µ</li><li>**–ó–∞—â–∏—Ç–∞ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è** –í–∞–∂–Ω–æ –ø—Ä–∏ —Ö–æ—Ä–æ—à–µ–º —Å—Ç–∞—Ç—É—Å–µ</li></ul>`;
                    actions.innerHTML = `<button ${getActionStatus()} onclick="applyR5Action('Energy')">–≠–∫–æ–Ω–æ–º–∏—è –≠–Ω–µ—Ä–≥–∏–∏</button><button ${getActionStatus()} onclick="applyR5Action('Protect')">–ó–∞—â–∏—Ç–∞ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</button>`;
                    break;
                    
                case 6:
                    desc.innerHTML = `<h3>–ó–∞–¥–∞–Ω–∏–µ</h3><p>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä—ã–≤–æ–∫ –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ –°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ **–ö–û–ù–¢–†–ê–ö–¢** –≤ –ø–∞–Ω–µ–ª—å –í–µ–¥—É—â–µ–≥–æ</p>`;
                    actions.innerHTML = `<button ${getActionStatus()} onclick="applyR6Action('Race')">–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ -1 E</button><button ${getActionStatus()} onclick="applyR6Action('Trade')">–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –û–±–º–µ–Ω</button><button ${getActionStatus()} onclick="applyR6Action('Safe')">–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å +1 —Å—Ç–∞—Ç—É—Å</button>`;
                    if (document.getElementById('trade-dialogue').style.display === 'block') {
                        document.getElementById('trade-dialogue').style.display = 'block';
                    }
                    break;

                case 7:
                    desc.innerHTML = `<h3>–ó–∞–¥–∞–Ω–∏–µ</h3><p>–¢—Ä–µ–±—É–µ—Ç—Å—è 1 **–ö—Ä–∏–æ –ú–æ–¥—É–ª—å** 1 **–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –í–æ–¥—ã** 1 **–ì–µ—Ä–º–æ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä**</p><hr><h4>–ò—Ç–æ–≥</h4><p>–í–∞—à —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —É—Å–ø–µ—Ö–∞ ${calculateFinalScore()}</p><p>üéâ **–§–∏–Ω–∞–ª** ${getFinalMessage()}</p>`;
                    actions.innerHTML = `<button ${getActionStatus()} onclick="assembleBeacon()">–°–æ–±—Ä–∞—Ç—å –ú–∞—è–∫ –°–ø–∞—Å–µ–Ω–∏—è</button>`;
                    break;
            }
        }
    </script>
</body>
</html>
